<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Ch∆∞∆°ng tr√¨nh ƒê√†o t·∫°o</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== MODAL FIXES ===== */
        /* Modal c∆° b·∫£n */
        .fixed.inset-0 {
            display: none;
            z-index: 50;
        }

        .fixed.inset-0:not(.hidden) {
            display: flex;
        }

        /* Modal th√™m m√¥n h·ªçc - FIXED */
        #modal-them-mon-hoc {
            display: none !important;
            z-index: 1050 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #modal-them-mon-hoc.hidden {
            display: none !important;
        }

        #modal-them-mon-hoc:not(.hidden) {
            display: flex !important;
        }

        #modal-them-mon-hoc > div {
            z-index: 1051 !important;
            position: relative;
            max-height: 90vh !important;
            overflow: visible !important;
            background-color: white !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            width: 95% !important;
            max-width: 1200px !important;
        }

		.modal {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100%;
		    height: 100%;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		}

        /* Modal backdrop */
        .modal-backdrop {
            z-index: 1040 !important;
        }

        /* ===== SELECT2 FIXES ===== */
        /* Select2 trong modal */
        .modal .select2-container {
            z-index: 1060 !important;
        }

        .modal .select2-container--open {
            z-index: 9999 !important; /* 1070 */
        }

        .modal .select2-dropdown {
            z-index: 10000 !important; /* 1080 */
            position: fixed !important;
            top: auto !important;
            left: auto !important;
            width: 100% !important;
            max-width: 400px !important;
            background-color: white !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }

        /* ƒê·∫£m b·∫£o √¥ t√¨m ki·∫øm hi·ªÉn th·ªã */
        .modal .select2-search--dropdown {
            padding: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal .select2-search__field {
            width: 100% !important;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }

        /* Fix cho Select2 trong modal th√™m m√¥n h·ªçc */
        #modal-them-mon-hoc .select2-container {
            width: 100% !important;
            margin-bottom: 8px;
        }

        #modal-them-mon-hoc .select2-selection {
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 8px;
        }

        #modal-them-mon-hoc .select2-selection__rendered {
            width: 100% !important;
            padding-left: 0 !important;
        }

        /* ƒê·∫£m b·∫£o dropdown kh√¥ng b·ªã c·∫Øt */
        #modal-them-mon-hoc {
            overflow: visible !important;
        }

        /* ·∫®n Select2 b√™n ngo√†i khi modal m·ªü */
        body.modal-open .select2-container:not(.modal .select2-container) {
            z-index: 1030 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

		body.modal-open .select2-container--open:not(.modal .select2-container--open) {
		    z-index: 1031 !important;
		}

        body.modal-open .select2-dropdown:not(.modal .select2-dropdown) {
            display: none !important;
        }

        /* Select2 c∆° b·∫£n */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
        }

		.select2-container--default .select2-selection--single {
		    transition: border-color 0.2s;
		}
        .select2-container--default .select2-selection--multiple {
            height: auto !important;
            padding: 0.5rem 0.75rem !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #3b82f6 !important;
            color: white !important;
            border: none !important;
            border-radius: 0.25rem !important;
        }

        .select2-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ===== INPUT & FORM STYLES ===== */
		#modal-them-mon-hoc, 
		#modal-them-chuong-trinh,
		#modal-import,
		#modal-import-errors {
		    backdrop-filter: blur(4px);
		    background-color: rgba(0, 0, 0, 0.5) !important;
		}
        /* Input trong modal */
        #modal-them-mon-hoc input:not([type="checkbox"]),
        #modal-them-mon-hoc select,
        #modal-them-mon-hoc textarea {
            background-color: white !important;
            color: #000 !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            padding: 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            pointer-events: auto !important;
            user-select: auto !important;
            cursor: text !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        #modal-them-mon-hoc input:focus,
        #modal-them-mon-hoc select:focus,
        #modal-them-mon-hoc textarea:focus {
            outline: 2px solid #3b82f6 !important;
            outline-offset: 2px !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        /* Select trong modal - ƒë·∫£m b·∫£o hi·ªÉn th·ªã m≈©i t√™n */
        #modal-them-mon-hoc select {
            appearance: auto !important;
            -webkit-appearance: auto !important;
            -moz-appearance: auto !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 0.5rem center !important;
            background-repeat: no-repeat !important;
            background-size: 1.5em 1.5em !important;
            padding-right: 2.5rem !important;
        }

        /* ===== TABLE STYLES ===== */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }

        /* ƒê·∫£m b·∫£o n·ªôi dung trong √¥ kh√¥ng b·ªã tr√†n */
        table td, table th {
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

		/* Loading state cho b·∫£ng */
		.table-loading {
		    position: relative;
		    min-height: 100px;
		}
		
		.table-loading::after {
		    content: '';
		    position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translate(-50%, -50%);
		    width: 40px;
		    height: 40px;
		    border: 3px solid #f3f3f3;
		    border-top: 3px solid #3498db;
		    border-radius: 50%;
		    animation: spin 1s linear infinite;
		}

        .wrap-cell {
            white-space: normal;
            word-wrap: break-word;
        }

        /* ƒê·ªô r·ªông c·ªôt c·ª• th·ªÉ */
        .col-tt { width: 48px; min-width: 48px; }
        .col-ma { width: 100px; min-width: 100px; }
        .col-ten { width: 220px; min-width: 220px; }
        .col-tinchi { width: 64px; min-width: 64px; }
        .col-gio { width: 80px; min-width: 80px; }
        .col-lythuyet { width: 64px; min-width: 64px; }
        .col-thuchanh { width: 64px; min-width: 64px; }
        .col-kiemtra { width: 50px; min-width: 50px; }
        .col-thi { width: 40px; min-width: 40px; }
        .col-hk { width: 48px; min-width: 48px; }
        .col-donvi { width: 180px; min-width: 180px; }
        .col-giangvien { width: 200px; min-width: 200px; }
        .col-course { width: 150px; min-width: 150px; }
        .col-thaotac { width: 80px; min-width: 80px; }

        /* Table header sticky */
        .bg-gray-50.sticky {
            z-index: 20;
            position: sticky;
            top: 0;
        }

        /* ===== EDITABLE CELL STYLES ===== */
        .editable:focus {
            outline: 2px solid #3b82f6;
            background-color: #f0f9ff;
            border-radius: 0.25rem;
        }

        .editable.select {
            background-color: transparent;
            border: none;
            width: 100%;
            padding: 2px 4px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .editable.select:focus {
            outline: 2px solid #3b82f6;
            background-color: white;
            border-radius: 4px;
        }

        /* ===== BUTTON STYLES ===== */
        button:not(:disabled) {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button colors */
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-600:hover { background-color: #1d4ed8; }

        .bg-green-600 { background-color: #059669; }
        .bg-green-600:hover { background-color: #047857; }

        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-600:hover { background-color: #374151; }

        .bg-purple-600 { background-color: #7c3aed; }
        .bg-purple-600:hover { background-color: #6d28d9; }

        /* ===== AUTOCOMPLETE STYLES ===== */
        .instructor-autocomplete {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            top: 100%;
            left: 0;
        }

        .autocomplete-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }


        /* ===== FIX SELECT2 IN TABLE ===== */
        /* ƒê·∫£m b·∫£o dropdown Select2 kh√¥ng b·ªã c·∫Øt */
        .table-container {
            position: relative;
            overflow: auto;
        }

        /* Fix v·ªã tr√≠ Select2 trong table cell */
        table td .select2-container {
            z-index: 10 !important;
            position: relative !important;
            width: 100% !important;
        }

        table td .select2-container--open {
            z-index: 9999 !important;
        }

        table td .select2-dropdown {
            position: fixed !important;
            z-index: 99999 !important;
            min-width: 200px !important;
            max-width: 300px !important;
        }

        /* ƒê·∫£m b·∫£o Select2 trong b·∫£ng hi·ªÉn th·ªã ƒë√∫ng */
        td .select2-container {
            width: 100% !important;
        }

        td .select2-selection {
            background: transparent !important;
            border: 1px solid transparent !important;
            height: 28px !important;
            min-height: 28px !important;
        }

        td .select2-selection:focus {
            border-color: #3b82f6 !important;
            background-color: #f0f9ff !important;
        }

        td .select2-selection__rendered {
            line-height: 26px !important;
            font-size: 0.875rem !important;
            padding-left: 4px !important;
        }

        /* Fix cho dropdown khi table c√≥ overflow */
        .table-container .select2-dropdown {
            position: absolute !important;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal > div {
            animation: modalSlideIn 0.3s ease-out;
        }

        .select2-dropdown {
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .fa-spinner.fa-spin {
            animation: spin 1s linear infinite;
        }

        /* ===== UTILITY CLASSES ===== */
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Success/Error states */
        .success-badge {
            background-color: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .error-badge {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 768px) {
			.select2-container {
		        font-size: 14px;
		    }
		    
		    .select2-selection--single {
		        height: 40px !important;
		        line-height: 40px !important;
		    }
		    
		    .select2-selection__arrow {
		        height: 38px !important;
		    }

            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .modal > div {
                width: 95% !important;
                margin: 1rem auto !important;
                padding: 1rem !important;
            }
            
            .modal .select2-dropdown {
                position: fixed !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 90% !important;
                max-width: 300px !important;
            }
            
            .table-container {
                max-height: 400px;
            }
            
            /* Stack grid columns on mobile */
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
            
            /* Adjust font sizes */
            h1 {
                font-size: 1.5rem !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
            
            /* Button spacing */
            .flex.space-x-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .flex.space-x-2 > button {
                width: 100%;
            }
            
            /* Table adjustments */
            table {
                font-size: 0.875rem;
            }
            
            .col-ten, .col-donvi, .col-giangvien, .col-course {
                min-width: 150px !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .modal > div {
                width: 100% !important;
                margin: 0.5rem !important;
                padding: 0.75rem !important;
            }
            
            /* Hide some less important columns on very small screens */
            .col-lythuyet, .col-thuchanh, .col-kiemtra .col-thi {
                display: none;
            }
            
            .text-3xl {
                font-size: 1.25rem !important;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .modal,
            .select2-dropdown,
            button:not(.print-button),
            .no-print {
                display: none !important;
            }
            
            .table-container {
                max-height: none;
                overflow: visible;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #000;
                padding: 0.5rem;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        /* Focus styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .bg-blue-600 { background-color: #0000ff; }
            .bg-green-600 { background-color: #008000; }
            .bg-gray-600 { background-color: #000000; }
            .bg-purple-600 { background-color: #800080; }
            
            .border {
                border-width: 2px !important;
            }
        }

        /* ===== DARK MODE SUPPORT ===== */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111827;
                color: #f9fafb;
            }
            
            .bg-white {
                background-color: #1f2937 !important;
            }
            
            .bg-gray-100 {
                background-color: #111827 !important;
            }
            
            .bg-gray-50 {
                background-color: #374151 !important;
            }
            
            .text-gray-700 {
                color: #d1d5db !important;
            }
            
            .text-gray-900 {
                color: #f9fafb !important;
            }
            
            .border-gray-300 {
                border-color: #4b5563 !important;
            }
            
            /* Modal trong dark mode */
            .modal > .bg-white {
                background-color: #1f2937 !important;
            }
            
            /* Table trong dark mode */
            table {
                color: #f9fafb;
            }
            
            thead.bg-gray-50 {
                background-color: #374151 !important;
            }
            
            /* Input trong dark mode */
            input, select, textarea {
                background-color: #374151 !important;
                color: #f9fafb !important;
                border-color: #4b5563 !important;
            }
            
            /* Select2 trong dark mode */
            .select2-container--default .select2-selection--single,
            .select2-container--default .select2-selection--multiple {
                background-color: #374151 !important;
                border-color: #4b5563 !important;
            }
            
            .select2-dropdown {
                background-color: #1f2937 !important;
                border-color: #4b5563 !important;
            }
            
            .select2-results__option {
                color: #f9fafb;
            }
            
            .select2-search__field {
                background-color: #374151 !important;
                color: #f9fafb !important;
            }
        }

        /* ===== FIX FOR SPECIFIC ELEMENTS ===== */
        /* ƒê·∫£m b·∫£o c√°c n√∫t trong modal c√≥ th·ªÉ click */
        #modal-them-mon-hoc button,
        #modal-them-chuong-trinh button {
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        /* ƒê·∫£m b·∫£o modal kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi c√°c style kh√°c */
        #modal-them-mon-hoc,
        #modal-them-chuong-trinh {
            pointer-events: auto !important;
        }

        #modal-them-mon-hoc *,
        #modal-them-chuong-trinh * {
            pointer-events: auto !important;
        }

        /* Fix cho chi·ªÅu cao modal content */
        #modal-them-mon-hoc .bg-white {
            max-height: 90vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        /* ƒê·∫£m b·∫£o body kh√¥ng scroll khi modal m·ªü */
        body.modal-open {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
        }

        /* Fix cho placeholder trong input */
        ::placeholder {
            color: #9ca3af;
            opacity: 1;
        }

        /* ===== CUSTOM SCROLLBAR FOR MODAL ===== */
        #modal-them-mon-hoc .bg-white::-webkit-scrollbar {
            width: 6px;
        }

        #modal-them-mon-hoc .bg-white::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #modal-them-mon-hoc .bg-white::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #modal-them-mon-hoc .bg-white::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* ===== TOOLTIP STYLES ===== */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #374151;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* ===== VALIDATION STYLES ===== */
        .valid-input {
            border-color: #10b981 !important;
        }

        .invalid-input {
            border-color: #ef4444 !important;
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .validation-message.error {
            color: #ef4444;
        }

        .validation-message.success {
            color: #10b981;
        }

        /* ===== FINAL TOUCHES ===== */
        /* Smooth transitions */
        .modal,
        .modal > div,
        .select2-container,
        .select2-dropdown {
            transition: all 0.3s ease;
        }

		/* Th√™m style cho Select2 */
        .select2-container {
            z-index: 1000 !important;
        }
        
        .select2-container--open {
            z-index: 10000 !important;
        }
        
        .select2-dropdown {
            z-index: 10001 !important;
        }
        
        /* ƒê·∫£m b·∫£o modal c√≥ z-index cao */
        .fixed.inset-0 {
            z-index: 9998 !important;
        }

        /* Improve text readability */
        p, label, span, div {
            line-height: 1.6;
        }

        /* Better spacing for form elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Card-like elements */
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-active {
            background-color: #10b981;
        }

        .status-inactive {
            background-color: #ef4444;
        }

        .status-draft {
            background-color: #f59e0b;
        }

        /* ===== PERFORMANCE OPTIMIZATIONS ===== */
        /* Hardware acceleration for smooth animations */
        .modal > div,
        .select2-dropdown {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            .modal > div,
            .select2-dropdown,
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    {% csrf_token %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-800">QU·∫¢N L√ù CH∆Ø∆†NG TR√åNH ƒê√ÄO T·∫†O</h1>
        
        <!-- Th√¥ng tin chung -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khoa</label>
                    <select id="khoa-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Ch·ªçn khoa --</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">T·ªï b·ªô m√¥n</label>
                    <select id="to-bo-mon" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Ch·ªçn t·ªï b·ªô m√¥n --</option>
                        {% for group in subject_groups %}
                        <option value="{{ group.id }}" data-department="{{ group.department_id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o</label>
                    <select id="chuong-trinh-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Ch·ªçn ch∆∞∆°ng tr√¨nh --</option>
                        {% for curriculum in curricula %}
                        <option value="{{ curriculum.id }}">{{ curriculum.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Kh√≥a h·ªçc</label>
                    <select id="khoa-hoc" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Ch·ªçn kh√≥a h·ªçc --</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}" data-curriculum="{{ course.curriculum_id }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- N√∫t ch·ª©c nƒÉng -->
		<div class="flex flex-wrap justify-between mb-6">
			<div class="flex space-x-2 mb-4">
    			<button id="btn-them" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-plus mr-2"></i> Th√™m ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o
    			</button>
    			<button id="btn-them-mon-hoc" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-book-medical mr-2"></i> Th√™m m√¥n h·ªçc
    			</button>
    			<button id="btn-cap-nhat" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-sync-alt mr-2"></i> C·∫≠p nh·∫≠t
    			</button>
			</div>
    
			<div>
    			<button id="btn-import" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-file-excel mr-2"></i> Import Excel
    			</button>
			</div>
		</div>

        <!-- Modal import Excel -->
        <div id="modal-import" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Import t·ª´ Excel</h3>
                    <button id="btn-dong-import" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="form-import" class="space-y-4" enctype="multipart/form-data">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o *</label>
                        <select id="import-curriculum" name="curriculum_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Ch·ªçn ch∆∞∆°ng tr√¨nh --</option>
                            {% for curriculum in curricula %}
                            <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Kh√≥a h·ªçc *</label>
                        <select id="import-course" name="course_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Ch·ªçn kh√≥a h·ªçc --</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }} ({{ course.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">File Excel *</label>
                        <input type="file" id="excel-file" name="excel_file" accept=".xlsx, .xls" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            required>
                        <p class="text-xs text-gray-500 mt-1">Ch·ªâ ch·∫•p nh·∫≠n file .xlsx ho·∫∑c .xls, t·ªëi ƒëa 10MB</p>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ch·ªçn sheet</label>
                        <select id="sheet-select" name="sheet_name" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- T·ª± ƒë·ªông ch·ªçn sheet ƒë·∫ßu ti√™n --</option>
                            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Ch·ªçn sheet ch·ª©a d·ªØ li·ªáu m√¥n h·ªçc. N·∫øu kh√¥ng ch·ªçn, sheet ƒë·∫ßu ti√™n s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng.</p>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <p>
                            <a href="#" id="btn-download-template" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                                <i class="fas fa-download mr-2"></i>T·∫£i file m·∫´u
                            </a>
                        </p>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                        <h4 class="text-sm font-semibold text-yellow-800 mb-2">L∆∞u √Ω khi import:</h4>
                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                            <li>File Excel ph·∫£i theo ƒë√∫ng ƒë·ªãnh d·∫°ng m·∫´u</li>
                            <li>C√°c c·ªôt b·∫Øt bu·ªôc: M√£ m√¥n h·ªçc, T√™n h·ªçc ph·∫ßn, S·ªë t√≠n ch·ªâ</li>
                            <li>M√£ m√¥n h·ªçc kh√¥ng ƒë∆∞·ª£c tr√πng trong c√πng ch∆∞∆°ng tr√¨nh</li>
                        </ul>
                    </div>
                </form>
                
                <div class="flex justify-end mt-6 space-x-3">
                    <button id="btn-huy-import" type="button" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-times mr-2"></i>H·ªßy
                    </button>
                    <button id="btn-luu-import" type="button" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-upload mr-2"></i>Import Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal hi·ªÉn th·ªã l·ªói import -->
        <div id="modal-import-errors" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Chi ti·∫øt l·ªói khi import</h3>
                    <button id="btn-dong-errors" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="import-errors-content" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded border">
                    <!-- N·ªôi dung l·ªói s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn ·ªü ƒë√¢y -->
                </div>
                <div class="flex justify-end">
                    <button id="btn-close-errors" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-check mr-2"></i>ƒê√≥ng
                    </button>
                </div>
            </div>
        </div>

        <!-- B·∫£ng d·ªØ li·ªáu -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50 sticky top-0" style="z-index: 10;">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">TT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">M√£ m√¥n h·ªçc</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">T√™n h·ªçc ph·∫ßn</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">S·ªë t√≠n ch·ªâ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">T·ªïng s·ªë gi·ªù</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">L√Ω thuy·∫øt</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Th·ª±c h√†nh</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Ki·ªÉm tra</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Thi</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK2</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider wg-12">HK3</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider wg-12">HK4</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK5</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK6</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-60">ƒê∆°n v·ªã</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Gi·∫£ng vi√™n</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Kh√≥a h·ªçc</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        {% if mon_hoc_data %}
							<!-- {{ mon_hoc_data|json_script:"mon-hoc-data-json" }} -->
						{% else %}
		                    <tr>
		                        <td colspan="19" class="px-4 py-4 text-center text-gray-500">
		                            Kh√¥ng c√≥ d·ªØ li·ªáu m√¥n h·ªçc
		                        </td>
		                    </tr>
		                {% endif %}
                    </tbody>

                    <!-- Th√™m script ƒë·ªÉ chuy·ªÉn d·ªØ li·ªáu t·ª´ Django template sang JavaScript -->
                    {% if mon_hoc_data %}
                    <script>
                        window.initialMonHocData = {{ mon_hoc_data|safe }};
                    </script>
                    {% endif %}
                </table>
            </div>
        </div>
        
        <!-- Th√¥ng tin t·ªïng k·∫øt -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-gray-600">T·ªïng s·ªë t√≠n ch·ªâ</p>
                    <p id="tong-tin-chi" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">T·ªïng s·ªë gi·ªù</p>
                    <p id="tong-gio" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">T·ª∑ l·ªá l√Ω thuy·∫øt</p>
                    <p id="ty-le-ly-thuyet" class="text-xl font-bold text-blue-700">0%</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">T·ª∑ l·ªá th·ª±c h√†nh</p>
                    <p id="ty-le-thuc-hanh" class="text-xl font-bold text-blue-700">0%</p>
                </div>
            </div>
        </div>

        <!-- Qu·∫£n l√Ω l·ªõp h·ªçc v√† ph√¢n c√¥ng gi·∫£ng d·∫°y -->
        <div class="mt-6 text-center">
            <a href="{% url 'teaching_management' %}" 
            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-md inline-flex items-center text-lg">
                <i class="fas fa-chalkboard-teacher mr-3"></i> 
                Qu·∫£n l√Ω Ph√¢n c√¥ng Gi·∫£ng d·∫°y
            </a>
        </div>

    </div>

    <!-- Modal th√™m ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o -->
	<div id="modal-them-chuong-trinh" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Th√™m ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o m·ªõi</h3>
                <button type="button" id="btn-dong-chuong-trinh" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-chuong-trinh" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">M√£ ch∆∞∆°ng tr√¨nh *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: CNTT_2022"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">T√™n ch∆∞∆°ng tr√¨nh *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: Ch∆∞∆°ng tr√¨nh Tin h·ªçc ·ª©ng d·ª•ng"
                            required
                            autocomplete="off">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">NƒÉm h·ªçc √°p d·ª•ng *</label>
                        <input type="text" name="academic_year" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: 2022 - 2025"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ng√†nh ƒë√†o t·∫°o *</label>
                        <select id="them-chuong-trinh-major" name="major_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                required>
                            <option value="">-- Ch·ªçn ng√†nh --</option>
                            {% for major in majors %}
                            <option value="{{ major.id }}">{{ major.name }} ({{ major.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">M√¥ t·∫£</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="3"
                            placeholder="Nh·∫≠p m√¥ t·∫£ v·ªÅ ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o..."
                            autocomplete="off"></textarea>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-md">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Th√¥ng tin b·ªï sung:</h4>
                    <p class="text-sm text-blue-700">
                        ‚Ä¢ Ch∆∞∆°ng tr√¨nh s·∫Ω ƒë∆∞·ª£c t·∫°o v·ªõi tr·∫°ng th√°i "B·∫£n nh√°p"<br>
                        ‚Ä¢ B·∫°n c√≥ th·ªÉ import m√¥n h·ªçc sau khi t·∫°o ch∆∞∆°ng tr√¨nh
                    </p>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-chuong-trinh" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-times mr-2"></i>H·ªßy
                </button>
                <button type="button" id="btn-luu-chuong-trinh" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-save mr-2"></i>L∆∞u ch∆∞∆°ng tr√¨nh
                </button>
            </div>
        </div>
    </div>

    <!-- Modal th√™m m√¥n h·ªçc -->
    <div id="modal-them-mon-hoc" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white" style="z-index: 1001;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Th√™m m√¥n h·ªçc m·ªõi</h3>
                <button type="button" id="btn-dong-mon-hoc" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="bg-blue-50 p-4 rounded-md mb-4">
                <h4 class="text-sm font-semibold text-blue-800 mb-2">Ch·ªçn t·ª´ m√¥n h·ªçc c√≥ s·∫µn</h4>
                <div class="flex space-x-2 mb-2">
                    <select id="select-existing-subject" class="flex-1">
                        <option value="">-- T√¨m ki·∫øm m√¥n h·ªçc c√≥ s·∫µn --</option>
                        <!-- Options s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                    </select>
                    <button type="button" id="btn-use-existing" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md whitespace-nowrap">
                        <i class="fas fa-check mr-1"></i> Ch·ªçn
                    </button>
                </div>
                <p class="text-xs text-blue-600">Ch·ªçn m√¥n h·ªçc t·ª´ danh s√°ch c√≥ s·∫µn ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin</p>
            </div>

            <!-- Th√™m ph·∫ßn hi·ªÉn th·ªã th√¥ng tin m√¥n h·ªçc ƒë√£ ch·ªçn -->
            <div id="existing-subject-info" class="bg-green-50 p-3 rounded-md border border-green-200 hidden mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-sm font-semibold text-green-800">ƒê√£ ch·ªçn m√¥n h·ªçc c√≥ s·∫µn</h4>
                        <p class="text-sm text-green-700" id="selected-subject-name"></p>
                    </div>
                    <button type="button" id="btn-clear-selection" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <form id="form-them-mon-hoc" class="space-y-4">
                <!-- Th√¥ng tin ch∆∞∆°ng tr√¨nh -->
                <div class="bg-blue-50 p-4 rounded-md">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Th√¥ng tin ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o *</label>
                            <select id="them-mon-hoc-curriculum" name="curriculum_id" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    required>
                                <option value="">-- Ch·ªçn ch∆∞∆°ng tr√¨nh --</option>
                                {% for curriculum in curricula %}
                                <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Kh√≥a h·ªçc *</label>
                            <select id="them-mon-hoc-course" name="course_id" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    required>
                                <option value="">-- Ch·ªçn kh√≥a h·ªçc --</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }} ({{ course.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Ng√†nh ƒë√†o t·∫°o</label>
                            <select id="them-mon-hoc-major" name="major_id"
                            		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        		<option value="">-- Ch·ªçn ng√†nh --</option>
                                {% for major in majors %}
                                <option value="{{ major.id }}">{{ major.name }} ({{ major.code }})</option>
                                {% endfor %}
							</select>
                        </div>
                    </div>
                </div>

                <!-- Th√¥ng tin c∆° b·∫£n m√¥n h·ªçc -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">M√£ m√¥n h·ªçc *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: MH01"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">T√™n m√¥n h·ªçc *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: Gi√°o d·ª•c ch√≠nh tr·ªã"
                            required
                            autocomplete="off">
                    </div>
                </div>

                <!-- S·ªë t√≠n ch·ªâ v√† gi·ªù -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">S·ªë t√≠n ch·ªâ *</label>
                        <input type="number" name="credits" step="0.5" min="0" max="10"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">T·ªïng s·ªë gi·ªù</label>
                        <input type="number" name="total_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">L√Ω thuy·∫øt</label>
                        <input type="number" name="theory_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Th·ª±c h√†nh</label>
                        <input type="number" name="practice_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ki·ªÉm tra</label>
                        <input type="number" name="tests_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thi</label>
                        <input type="number" name="exam_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Th·ª© t·ª±</label>
                        <input type="number" name="order_number" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                </div>

                <!-- Ph√¢n b·ªë h·ªçc k·ª≥ -->
                <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-3">Ph√¢n b·ªë h·ªçc k·ª≥ (s·ªë t√≠n ch·ªâ)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        {% for i in "123456" %}
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">H·ªçc k·ª≥ {{ i }}</label>
                            <input type="number" name="hk{{ i }}" step="0.5" min="0" max="10"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center" 
                                placeholder="-"
                                autocomplete="off">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Th√¥ng tin b·ªï sung -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ƒê∆°n v·ªã qu·∫£n l√Ω</label>
                        <select id="them-mon-hoc-department" name="department_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Ch·ªçn ƒë∆°n v·ªã --</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Lo·∫°i m√¥n *</label>
                        <select id="them-mon-hoc-subject-type" name="subject_type_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                required>
                            <option value="">-- Ch·ªçn lo·∫°i m√¥n --</option>
                            {% for subject_type in subject_types %}
                            <option value="{{ subject_type.id }}">{{ subject_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">T·ªï b·ªô m√¥n</label>
                        <select id="them-mon-hoc-subject-group" name="subject_group_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Ch·ªçn t·ªï b·ªô m√¥n --</option>
                            {% for subject_group in subject_groups %}
                            <option value="{{ subject_group.id }}" data-department="{{ subject_group.department_id }}">{{ subject_group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">H·ªçc k·ª≥ m·∫∑c ƒë·ªãnh</label>
                        <select id="them-mon-hoc-semester" name="semester" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                            {% for i in "123456" %}
                            <option value="{{ i }}">H·ªçc k·ª≥ {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">M√¥ t·∫£ m√¥n h·ªçc</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="3"
                            placeholder="Nh·∫≠p m√¥ t·∫£ v·ªÅ m√¥n h·ªçc..."
                            autocomplete="off"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">ƒêi·ªÅu ki·ªán ti√™n quy·∫øt</label>
                    <textarea name="prerequisites" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="2"
                            placeholder="Nh·∫≠p ƒëi·ªÅu ki·ªán ti√™n quy·∫øt (n·∫øu c√≥)..."
                            autocomplete="off"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chu·∫©n ƒë·∫ßu ra</label>
                    <textarea name="learning_outcomes" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="2"
                            placeholder="Nh·∫≠p chu·∫©n ƒë·∫ßu ra c·ªßa m√¥n h·ªçc..."
                            autocomplete="off"></textarea>
                </div>

                <!-- Th√¥ng tin m√¥n t·ª± ch·ªçn -->
                <div class="bg-green-50 p-4 rounded-md border border-green-200">
                    <h4 class="text-sm font-semibold text-green-800 mb-3">Th√¥ng tin m√¥n t·ª± ch·ªçn (n·∫øu c√≥)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" name="is_elective" id="is_elective" 
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="is_elective" class="ml-2 block text-sm text-gray-700 font-medium">
                                L√† m√¥n t·ª± ch·ªçn
                            </label>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Nh√≥m m√¥n t·ª± ch·ªçn</label>
                            <input type="text" name="elective_group" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="Vd: Nh√≥m 1"
                                autocomplete="off">
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-mon-hoc" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-times mr-2"></i>H·ªßy
                </button>
                <button type="button" id="btn-luu-mon-hoc" 
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-save mr-2"></i>L∆∞u m√¥n h·ªçc
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/vi.js"></script>
    <script>
        let allDepartments = [];
		let allSubjectGroups = [];
		let allCurricula = [];
		let allCourses = [];
		let allSubjectTypes = [];
		let allMajors = [];
		let allSubjects = [];
		let allInstructors = [];
        let isSubjectsLoaded = false;
		
		let monHocData = [];

        // Cache system
        const dataCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // Timeout handlers
        let instructorSearchTimeout = null;
        let filterTimeout = null;

        // ===== ERROR HANDLING FUNCTIONS =====
        function handleApiError(error, endpoint) {
            console.error(`‚ùå API Error for ${endpoint}:`, error.message);
            
            // Kh√¥ng hi·ªÉn th·ªã alert cho ng∆∞·ªùi d√πng v·ªõi l·ªói 500
            if (error.message.includes('500')) {
                console.log(`‚Üª Server error for ${endpoint}, using fallback data`);
                return [];
            }
            
            return [];
        }

        // ===== CACHE FUNCTIONS =====
        async function fetchWithCache(url, cacheKey) {
            console.log(`Fetching: ${url}`);
            
            const now = Date.now();
            const cached = dataCache.get(cacheKey);
            
            // Check cache
            if (cached && (now - cached.timestamp < CACHE_DURATION)) {
                console.log(`‚úì Using cache: ${cacheKey}`);
                return cached.data;
            }
            
            try {
                console.log(`‚ü≥ Fetching: ${cacheKey}`);

                // Th√™m timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                const response = await fetch(url, { 
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Store in cache
                dataCache.set(cacheKey, {
                    data: data,
                    timestamp: now
                });
                
                console.log(`‚úì Loaded: ${cacheKey} (${data.length || 0} items)`);
                return data;
            } catch (error) {
                console.warn(`‚ö† Fetch failed for ${cacheKey}:`, error.message);
                
                // Return cached data if available
                if (cached) {
                    console.log(`‚Üª Using cached data for ${cacheKey}`);
                    return cached.data;
                }
                
                // Return empty array for safety
                return [];
            }
        }


        async function loadInitialData() {
            try {
                const sampleData = getSampleData();
                
                // Th·ª≠ t·∫£i t·ª´ API, n·∫øu l·ªói th√¨ d√πng sample data
                const loadPromises = [
                    fetchWithCache('/api/curricula/', 'curricula')
                        .then(data => allCurricula = data.length ? data : sampleData.curricula)
                        .catch(() => allCurricula = sampleData.curricula),
                        
                    fetchWithCache('/api/courses/', 'courses')
                        .then(data => allCourses = data.length ? data : sampleData.courses)
                        .catch(() => allCourses = sampleData.courses),
                        
                    fetchWithCache('/api/departments/', 'departments')
                        .then(data => allDepartments = data.length ? data : sampleData.departments)
                        .catch(() => allDepartments = sampleData.departments),
                        
                    fetchWithCache('/api/subject-groups/', 'subjectGroups')
                        .then(data => allSubjectGroups = data.length ? data : sampleData.subjectGroups)
                        .catch(() => allSubjectGroups = sampleData.subjectGroups),
                        
                    fetchWithCache('/api/all-subjects/', 'subjects')
                        .then(data => allSubjects = data.length ? data : sampleData.subjects)
                        .catch(() => allSubjects = sampleData.subjects),
                        
                    fetchWithCache('/api/majors/', 'majors')
                        .then(data => allMajors = data.length ? data : sampleData.majors)
                        .catch(() => allMajors = sampleData.majors),
                        
                    fetchWithCache('/api/subject-types/', 'subjectTypes')
                        .then(data => allSubjectTypes = data.length ? data : sampleData.subjectTypes)
                        .catch(() => allSubjectTypes = sampleData.subjectTypes)
                ];
                
                await Promise.all(loadPromises);
                
                console.log('‚úÖ Data loaded successfully');
                console.log(`- Departments: ${allDepartments.length}`);
                console.log(`- Subject Groups: ${allSubjectGroups.length}`);
                console.log(`- Curricula: ${allCurricula.length}`);
                console.log(`- Courses: ${allCourses.length}`);
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Error loading initial data:', error);
                return false;
            }
        }

        // Cache cho API responses
        const apiCache = new Map();
        const CACHE_TTL = 2 * 60 * 1000; // 2 ph√∫t

        async function cachedFetch(url, options = {}) {
            const now = Date.now();
            const cached = apiCache.get(url);
            
            if (cached && (now - cached.timestamp < CACHE_TTL)) {
                console.log('Using cached response for:', url);
                return cached.response;
            }
            
            try {
                const response = await fetch(url, options);
                if (response.ok) {
                    const data = await response.json();
                    apiCache.set(url, {
                        response: data,
                        timestamp: now
                    });
                    return data;
                }
                throw new Error(`HTTP ${response.status}`);
            } catch (error) {
                // N·∫øu c√≥ l·ªói nh∆∞ng c√≥ cache c≈©, d√πng cache
                if (cached) {
                    console.log('Using stale cache due to error:', error.message);
                    return cached.response;
                }
                throw error;
            }
        }

        function loadSelect2Data(url, elementId, displayField, searchFields = []) {
            console.log(`Loading data for ${elementId} from ${url}`);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Data loaded for ${elementId}:`, data.length, 'items');
                    populateSelect2Dropdown(elementId, data, displayField, searchFields);
                })
                .catch(error => {
                    console.error(`Error loading data for ${elementId}:`, error);
                    // Fallback: kh·ªüi t·∫°o Select2 ngay c·∫£ khi kh√¥ng c√≥ d·ªØ li·ªáu
                    setTimeout(() => {
                        $(`#${elementId}`).select2({
                            language: 'vi',
                            placeholder: "Kh√¥ng c√≥ d·ªØ li·ªáu",
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $(`#${elementId}`).closest('.modal').length ? $(`#${elementId}`).closest('.modal') : $(document.body)
                        });
                    }, 100);
                });
        }

        function populateSelect2Dropdown(elementId, data, displayField, searchFields = []) {
            const dropdown = $(`#${elementId}`);
            if (!dropdown.length) {
                console.error(`Element #${elementId} not found`);
                return;
            }

            // H·ªßy Select2 n·∫øu ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o tr∆∞·ªõc ƒë√≥
            if (dropdown.hasClass('select2-hidden-accessible')) {
                dropdown.select2('destroy');
            }

            // Gi·ªØ option ƒë·∫ßu ti√™n n·∫øu c√≥
            const firstOption = dropdown.find('option').first();
            dropdown.empty();
            if (firstOption.length) {
                dropdown.append(firstOption);
            }

            // Th√™m d·ªØ li·ªáu
            data.forEach(item => {
                const displayText = item[displayField] + (item.academic_year ? ` (${item.academic_year})` : '');
                const option = new Option(displayText, item.id, false, false);
                
                // Th√™m d·ªØ li·ªáu t√¨m ki·∫øm v√†o option
                if (searchFields.length > 0) {
                    const searchText = searchFields.map(field => item[field] || '').join(' ');
                    $(option).data('search-text', searchText);
                }
                
                dropdown.append(option);
            });

            // Kh·ªüi t·∫°o l·∫°i Select2
            dropdown.select2({
                language: 'vi',
                placeholder: "Ch·ªçn ho·∫∑c nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm...",
                allowClear: true,
                width: '100%',
                dropdownParent: dropdown.closest('.modal').length ? dropdown.closest('.modal') : $(document.body),
                dropdownAutoWidth: true,
                minimumResultsForSearch: 0,
                matcher: function(params, data) {
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    
                    if (data.text && data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    
                    const searchText = $(data.element).data('search-text');
                    if (searchText && searchText.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    
                    return null;
                }
            });
            
            console.log(`Select2 initialized for ${elementId} with`, data.length, 'items');
        }


		// H√†m fetch an to√†n v·ªõi x·ª≠ l√Ω l·ªói
		async function safeFetch(url, options = {}) {
		    const timeoutDuration = options.timeout || 10000;
		    
			return new Promise((resolve) => {
		        const timeout = setTimeout(() => {
		            console.warn(`Fetch timeout for ${url}`);
		            resolve([]); // Tr·∫£ v·ªÅ m·∫£ng r·ªóng thay v√¨ throw error
		        }, timeoutDuration);
		        
		        fetch(url, options)
		            .then(response => {
		                clearTimeout(timeout);
		                if (!response.ok) {
		                    console.warn(`Fetch error: ${response.status}`);
		                    return [];
		                }
		                return response.json();
		            })
		            .then(data => {
		                resolve(data || []);
		            })
		            .catch(error => {
		                clearTimeout(timeout);
		                console.warn(`Fetch failed for ${url}:`, error.message);
		                resolve([]); // Lu√¥n tr·∫£ v·ªÅ m·∫£ng r·ªóng khi c√≥ l·ªói
		            });
		    });
		}

        // Kh·ªüi t·∫°o Select2 cho t·∫•t c·∫£ dropdown
        function initializeSelect2() {
            try {
                // ƒê√≥ng t·∫•t c·∫£ dropdown ƒëang m·ªü tr∆∞·ªõc khi kh·ªüi t·∫°o l·∫°i
                $('.select2-container--open').select2('close');

                // Kh·ªüi t·∫°o cho c√°c dropdown th√¥ng th∆∞·ªùng
                $('select:not(.select2-hidden-accessible)').each(function() {
                    try {
                        const $select = $(this);
                        const isInModal = $select.closest('.modal').length > 0;
                        
                        $select.select2({
                            language: 'vi',
                            placeholder: "Ch·ªçn ho·∫∑c nh·∫≠p ƒë·ªÉ t√¨m ki·∫øm...",
                            allowClear: true,
                            width: '100%',
                            dropdownParent: isInModal ? $select.closest('.modal') : $(document.body),
                            dropdownAutoWidth: true,
                            minimumResultsForSearch: 0
                        });
                    } catch (e) {
                        console.error('Error initializing Select2 for:', this, e);
                    }
                });

                console.log('Select2 initialized successfully');

                // T·ª± ƒë·ªông focus v√†o √¥ t√¨m ki·∫øm khi m·ªü dropdown
                $(document).on('select2:open', function(e) {
                    setTimeout(function() {
                        const searchInput = document.querySelector('.select2-search__field');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }, 100);
                });
            } catch (error) {
                console.error('Error initializing Select2:', error);
            }
        }

		// Cleanup khi r·ªùi trang
		window.addEventListener('beforeunload', function() {
		    // H·ªßy t·∫•t c·∫£ Select2
		    $('.select2-hidden-accessible').select2('destroy');
		    
		    // Clear t·∫•t c·∫£ timeout
		    if (instructorSearchTimeout) clearTimeout(instructorSearchTimeout);
		    if (filterTimeout) clearTimeout(filterTimeout);
		    
		    // Clear cache l·ªõn
		    dataCache.clear();
		    allDepartments = [];
		    allSubjectGroups = [];
		    allCurricula = [];
		    allCourses = [];
		    allSubjects = [];
		    monHocData = [];
		});

		function setupAutoCloseSelect2() {
		    // ƒê√≥ng dropdown khi ch·ªçn item
		    $(document).on('select2:select', '#khoa-dao-tao, #to-bo-mon, #chuong-trinh-dao-tao, #khoa-hoc', function() {
		        setTimeout(() => {
		            $(this).select2('close');
		        }, 100);
		    });
		    
		    // ƒê√≥ng dropdown khi click ra ngo√†i
		    $(document).on('click', function(e) {
		        const target = $(e.target);
		        const isSelect2 = target.closest('.select2-container').length > 0;
		        const isSelect2Input = target.hasClass('select2-search__field');
		        
		        if (!isSelect2 && !isSelect2Input) {
		            $('.select2-container--open').select2('close');
		        }
		    });
		}

		// Kh·ªüi t·∫°o Select2 cho modal ch·ªâ khi c·∫ßn
		function initializeModalSelect2(modalId) {
		    if (modalId === 'modal-them-mon-hoc') {
		        initializeSelect2ForSubjectModal();
		    } else if (modalId === 'modal-them-chuong-trinh') {
		        initializeSelect2ForCurriculumModal();
		    }
		}
		
        // Kh·ªüi t·∫°o Select2 cho modal th√™m m√¥n h·ªçc
        function initializeSelect2ForSubjectModal() {
            console.log('Initializing Select2 for subject modal...');
            
            try {
				const monHocModal = document.getElementById('modal-them-mon-hoc');
        		if (!monHocModal) return;

				// ƒê√≥ng t·∫•t c·∫£ Select2 ƒëang m·ªü tr∆∞·ªõc
        		closeAllOpenSelect2();

                // ƒê·∫£m b·∫£o modal hi·ªÉn th·ªã ƒë√∫ng
                $(monHocModal).css({
                    'display': 'flex',
                    'z-index': '1050'
                });
				
				// Kh·ªüi t·∫°o Select2 cho t·∫•t c·∫£ dropdown trong modal
                const select2Config = {
                    width: '100%',
                    dropdownParent: $(monHocModal),
                    language: 'vi',
                    placeholder: '-- Ch·ªçn --',
                    allowClear: true,
                    minimumResultsForSearch: 0, // Lu√¥n hi·ªÉn th·ªã √¥ t√¨m ki·∫øm
                    dropdownCssClass: 'modal-select2-dropdown',
                    containerCssClass: 'modal-select2-container'
                };
                
                // √Åp d·ª•ng cho t·ª´ng dropdown
                const dropdowns = [
                    '#select-existing-subject',
                    '#them-mon-hoc-curriculum',
                    '#them-mon-hoc-course',
                    '#them-mon-hoc-major',
                    '#them-mon-hoc-department',
                    '#them-mon-hoc-subject-type',
                    '#them-mon-hoc-subject-group',
                    '#them-mon-hoc-semester'
                ];
                
                dropdowns.forEach(selector => {
                    const $select = $(selector);
                    if ($select.length) {
                        // Destroy n·∫øu ƒë√£ c√≥ Select2
                        if ($select.hasClass('select2-hidden-accessible')) {
                            $select.select2('destroy');
                        }
                        
                        // Kh·ªüi t·∫°o m·ªõi
                        $select.select2(select2Config);
                        
                        // Fix s·ª± ki·ªán click ƒë·ªÉ m·ªü dropdown
                        $select.on('select2:open', function() {
                            // ƒê·∫£m b·∫£o dropdown hi·ªÉn th·ªã ƒë√∫ng
                            setTimeout(() => {
                                const $dropdown = $('.select2-dropdown');
                                if ($dropdown.length) {
                                    $dropdown.css({
                                        'z-index': '10000',
                                        'position': 'fixed'
                                    });
                                }
                            }, 10);
                        });
                    }
                });
                
                console.log('Select2 initialized for subject modal');
                
                // Th√™m s·ª± ki·ªán ƒë·ªÉ ƒë√≥ng dropdown khi click ra ngo√†i modal
                $(document).on('click', function(e) {
                    if (!$(e.target).closest('#modal-them-mon-hoc').length && 
                        !$(e.target).hasClass('select2-container')) {
                        $('.select2-container--open').select2('close');
                    }
                });
                
            } catch (error) {
                console.error('Error initializing Select2 for subject modal:', error);
            }
        }

        // Kh·ªüi t·∫°o Select2 cho modal th√™m ch∆∞∆°ng tr√¨nh
        function initializeSelect2ForCurriculumModal() {
            console.log('Initializing Select2 for curriculum modal...');
            
            try {
                const chuongTrinhModal = $('#modal-them-chuong-trinh');
                
                if (!chuongTrinhModal) return;

				// ƒê√≥ng t·∫•t c·∫£ Select2 ƒëang m·ªü tr∆∞·ªõc
        		closeAllOpenSelect2();

                $('select[name="major_id"]').select2({
                    width: '100%',
                    placeholder: '-- Ch·ªçn ng√†nh --',
                    allowClear: true,
                    language: 'vi',
                    dropdownParent: chuongTrinhModal,
                    //dropdownCssClass: 'modal-select2'
                });

                console.log('Select2 initialized for curriculum modal');
                
            } catch (error) {
                console.error('Error initializing Select2 for curriculum modal:', error);
            }
        }

        // H√†m c·∫≠p nh·∫≠t th√¥ng tin m√¥n h·ªçc khi ch·ªçn t·ª´ danh s√°ch c√≥ s·∫µn
        function fillSubjectFormFromExisting(subject) {
            if (!subject) return;
            
            const form = document.getElementById('form-them-mon-hoc');
            if (!form) return;
            
            // ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
            form.querySelector('input[name="code"]').value = subject.code || '';
            //form.querySelector('input[name="code"]').readOnly = true;
            form.querySelector('input[name="name"]').value = subject.name || '';
            //form.querySelector('input[name="name"]').readOnly = true;
            form.querySelector('input[name="credits"]').value = subject.credits || '';
            form.querySelector('input[name="total_hours"]').value = subject.total_hours || '';
            form.querySelector('input[name="theory_hours"]').value = subject.theory_hours || '';
            form.querySelector('input[name="practice_hours"]').value = subject.practice_hours || '';
            form.querySelector('input[name="tests_hours"]').value = subject.tests_hours || '';
            form.querySelector('input[name="exam_hours"]').value = subject.exam_hours || '';
            form.querySelector('input[name="order_number"]').value = subject.order_number || '';
            
            // ƒêi·ªÅn c√°c tr∆∞·ªùng select v√† trigger change
            setTimeout(() => {
                if (subject.department_id) {
                    $(form.querySelector('select[name="department_id"]')).val(subject.department_id).trigger('change');
                }
                
                if (subject.subject_type_id) {
                    $(form.querySelector('select[name="subject_type_id"]')).val(subject.subject_type_id).trigger('change');
                }
                
                if (subject.subject_group_id) {
                    $(form.querySelector('select[name="subject_group_id"]')).val(subject.subject_group_id).trigger('change');
                }
                
                if (subject.semester) {
                    $(form.querySelector('select[name="semester"]')).val(subject.semester).trigger('change');
                }
                
                if (subject.curriculum_id) {
                    $('#them-mon-hoc-curriculum').val(subject.curriculum_id).trigger('change');
                }
                
                if (subject.course_id) {
                    $('#them-mon-hoc-course').val(subject.course_id).trigger('change');
                }
                
                if (subject.major_id) {
                    $('#them-mon-hoc-major').val(subject.major_id).trigger('change');
                }
            }, 100);
            
            // ƒêi·ªÅn textarea
            form.querySelector('textarea[name="description"]').value = subject.description || '';
            form.querySelector('textarea[name="prerequisites"]').value = subject.prerequisites || '';
            form.querySelector('textarea[name="learning_outcomes"]').value = subject.learning_outcomes || '';
            
            // ƒêi·ªÅn checkbox
            const isElectiveCheckbox = form.querySelector('input[name="is_elective"]');
            if (isElectiveCheckbox) {
                isElectiveCheckbox.checked = subject.is_elective || false;
            }
            
            const electiveGroupInput = form.querySelector('input[name="elective_group"]');
            if (electiveGroupInput) {
                electiveGroupInput.value = subject.elective_group || '';
            }
            
            // ƒêi·ªÅn ph√¢n b·ªë h·ªçc k·ª≥
            for (let i = 1; i <= 6; i++) {
                const hkField = `hk${i}`;
                if (subject[hkField] !== undefined && subject[hkField] !== null) {
                    const input = form.querySelector(`input[name="${hkField}"]`);
                    if (input) {
                        input.value = subject[hkField];
                    }
                }
            }
            
            // Hi·ªÉn th·ªã th√¥ng b√°o
            document.getElementById('existing-subject-info').classList.remove('hidden');
            document.getElementById('selected-subject-name').textContent = 
                `${subject.code} - ${subject.name}`;
        }

		// H√†m hi·ªÉn th·ªã d·ªØ li·ªáu trong dropdown
		function populateSubjectSelect(subjects) {
		    const select = $('#select-existing-subject');
		    if (!select.length) return;

			// Clear current options (keep first option)
            const firstOption = select.find('option').first().clone();
            select.empty().append(firstOption);
            
            // Add subject options
            if (subjects && subjects.length > 0) {
                subjects.forEach(subject => {
                    const option = new Option(
                        `${subject.code || ''} - ${subject.name || ''}`,
                        subject.id || subject.code,
                        false,
                        false
                    );
                    // Store subject data in data attribute
                    $(option).data('subject', subject);
                    select.append(option);
                });
            }
            
            // Refresh Select2
            if (select.hasClass('select2-hidden-accessible')) {
                select.trigger('change.select2');
            }
            
            console.log(`Populated select with ${subjects.length} subjects`);
		}

        // C·∫≠p nh·∫≠t h√†m handleUseExistingSubject
        function handleUseExistingSubject() {
            const select = document.getElementById('select-existing-subject');
            if (!select) return;
            
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption.value || selectedOption.value === '') {
                alert('Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc');
                return;
            }
            
            // L·∫•y th√¥ng tin m√¥n h·ªçc t·ª´ data attribute
            const subjectData = selectedOption.getAttribute('data-subject');
            if (subjectData) {
                try {
                    const subject = JSON.parse(subjectData);
                    fillSubjectFormFromExisting(subject);
                } catch (e) {
                    console.error('Error parsing subject data:', e);
                    // Fallback: t√¨m trong m·∫£ng existingSubjects
                    const subjectId = selectedOption.value;
                    const subject = window.existingSubjects?.find(s => s.id == subjectId);
                    if (subject) {
                        fillSubjectFormFromExisting(subject);
                    } else {
                        alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin m√¥n h·ªçc. Vui l√≤ng th·ª≠ l·∫°i.');
                    }
                }
            } else {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu m√¥n h·ªçc. Vui l√≤ng ch·ªçn m√¥n h·ªçc kh√°c.');
            }
        }

        // C·∫≠p nh·∫≠t h√†m clearSubjectSelection
        function clearSubjectSelection() {
            console.log('Clearing subject selection...');

            const select = document.getElementById('select-existing-subject');
		    if (select) {
		        select.value = '';
		        if ($(select).hasClass('select2-hidden-accessible')) {
		            $(select).trigger('change.select2');
		        }
		    }
		    
		    const form = document.getElementById('form-them-mon-hoc');
		    if (form) {
		        form.querySelector('input[name="code"]').readOnly = false;
		        form.querySelector('input[name="name"]').readOnly = false;
		    }
        }

        // Kh·ªüi t·∫°o dropdowns
        function initializeDropdowns() {
            console.log('Initializing dropdowns...');
    
            // Kh·ªüi t·∫°o Select2 cho c√°c dropdown ch√≠nh
            const initSelect2 = (selector, placeholder) => {
                const $element = $(selector);
                if (!$element.length) return;
                
                // Destroy n·∫øu ƒë√£ c√≥ Select2
                if ($element.hasClass('select2-hidden-accessible')) {
                    $element.select2('destroy');
                }
                
                // Initialize Select2
                $element.select2({
                    width: '100%',
                    placeholder: placeholder,
                    allowClear: true,
                    language: 'vi',
                    dropdownParent: $('body')
                });
                
                return $element;
            };
            
            // Initialize main dropdowns
            const $khoaDaoTao = initSelect2('#khoa-dao-tao', '-- Ch·ªçn khoa --');
            const $toBoMon = initSelect2('#to-bo-mon', '-- Ch·ªçn t·ªï b·ªô m√¥n --');
            const $chuongTrinh = initSelect2('#chuong-trinh-dao-tao', '-- Ch·ªçn ch∆∞∆°ng tr√¨nh --');
            const $khoaHoc = initSelect2('#khoa-hoc', '-- Ch·ªçn kh√≥a h·ªçc --');
            
            // Populate data
            populateDropdown('khoa-dao-tao', allDepartments, 'name');
            populateDropdown('to-bo-mon', allSubjectGroups, 'name');
            populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
            populateDropdown('khoa-hoc', allCourses, 'name');
        }

        // ===== FIXED FILTER EVENTS =====
        function setupDropdownEvents() {
            console.log('Setting up dropdown events...');
            
            // Remove existing events to avoid duplicates
            $(document).off('change', '#khoa-dao-tao');
            $(document).off('change', '#chuong-trinh-dao-tao');
            $(document).off('change', '#to-bo-mon');
            $(document).off('change', '#khoa-hoc');
            
            // Khoa -> To bo mon filter
            $(document).on('change', '#khoa-dao-tao', function() {
                const departmentId = $(this).val();
                console.log('Khoa selected:', departmentId);
                
                // Filter subject groups
                const filteredGroups = departmentId 
                    ? allSubjectGroups.filter(group => group.department_id == departmentId)
                    : allSubjectGroups;
                
                // Update to-bo-mon dropdown
                const $subjectGroupSelect = $('#to-bo-mon');
                
                // Save current value
                const currentValue = $subjectGroupSelect.val();
                
                // Clear and repopulate
                $subjectGroupSelect.empty();
                $subjectGroupSelect.append($('<option>', {
                    value: '',
                    text: '-- Ch·ªçn t·ªï b·ªô m√¥n --'
                }));
                
                filteredGroups.forEach(group => {
                    $subjectGroupSelect.append($('<option>', {
                        value: group.id,
                        text: group.name
                    }));
                });
                
                // Restore value if still valid
                if (currentValue && filteredGroups.some(g => g.id == currentValue)) {
                    $subjectGroupSelect.val(currentValue);
                }
                
                // Update Select2
                if ($subjectGroupSelect.hasClass('select2-hidden-accessible')) {
                    $subjectGroupSelect.trigger('change');
                }
                
                // Load filtered data
                debouncedLoadFilteredData();
            });
            
            // Chuong trinh -> Khoa hoc filter
            $(document).on('change', '#chuong-trinh-dao-tao', function() {
                const curriculumId = $(this).val();
                console.log('Ch∆∞∆°ng tr√¨nh selected:', curriculumId);
                
                // Filter courses
                const filteredCourses = curriculumId
                    ? allCourses.filter(course => course.curriculum_id == curriculumId)
                    : allCourses;
                
                // Update khoa-hoc dropdown
                const $courseSelect = $('#khoa-hoc');
                
                // Save current value
                const currentValue = $courseSelect.val();
                
                // Clear and repopulate
                $courseSelect.empty();
                $courseSelect.append($('<option>', {
                    value: '',
                    text: '-- Ch·ªçn kh√≥a h·ªçc --'
                }));
                
                filteredCourses.forEach(course => {
                    const displayText = course.code 
                        ? `${course.name} (${course.code})`
                        : course.name;
                        
                    $courseSelect.append($('<option>', {
                        value: course.id,
                        text: displayText
                    }));
                });
                
                // Restore value if still valid
                if (currentValue && filteredCourses.some(c => c.id == currentValue)) {
                    $courseSelect.val(currentValue);
                }
                
                // Update Select2
                if ($courseSelect.hasClass('select2-hidden-accessible')) {
                    $courseSelect.trigger('change');
                }
                
                // Load filtered data
                debouncedLoadFilteredData();
            });
            
            // Other dropdown changes
            $(document).on('change', '#to-bo-mon', debouncedLoadFilteredData);
            $(document).on('change', '#khoa-hoc', debouncedLoadFilteredData);
        }
        
        // ===== DEBOUNCED DATA LOADING =====
        function debouncedLoadFilteredData() {
            if (filterTimeout) {
                clearTimeout(filterTimeout);
            }
            
            filterTimeout = setTimeout(() => {
                loadFilteredData();
            }, 300);
        }

        // H√†m t·∫£i d·ªØ li·ªáu d·ª±a tr√™n b·ªô l·ªçc hi·ªán t·∫°i
        function populateDropdown(elementId, data, displayField) {
            const dropdown = $(`#${elementId}`);
            if (!dropdown.length) return;
            
            // Save current value
            const currentValue = dropdown.val();
            
            // Clear and add default option
            dropdown.empty();
            dropdown.append($('<option>', {
                value: '',
                text: dropdown.attr('placeholder') || '-- Ch·ªçn --'
            }));
            
            // Add data options
            if (Array.isArray(data) && data.length > 0) {
                data.forEach(item => {
                    let text = item[displayField] || '';
                    if (item.code) {
                        text = `${item.code} - ${text}`;
                    }
                    if (item.academic_year) {
                        text += ` (${item.academic_year})`;
                    }
                    
                    const option = $('<option>', {
                        value: item.id,
                        text: text
                    });
                    
                    // Add data attributes for filtering
                    if (item.department_id) {
                        option.attr('data-department', item.department_id);
                    }
                    if (item.curriculum_id) {
                        option.attr('data-curriculum', item.curriculum_id);
                    }
                    
                    dropdown.append(option);
                });
            }
            
            // Restore previous value if still valid
            if (currentValue && dropdown.find(`option[value="${currentValue}"]`).length) {
                dropdown.val(currentValue);
            }
            
            // Update Select2
            if (dropdown.hasClass('select2-hidden-accessible')) {
                dropdown.trigger('change');
            }
        }

		// H√†m kh·ªüi t·∫°o Select2 cho c√°c dropdown trong b·∫£ng
		function initializeTableSelect2() {
            try {
                // Destroy existing Select2 instances in table to avoid conflicts
                $('tbody select.select2-hidden-accessible').each(function() {
                    try {
                        if ($.fn.select2 && $(this).data('select2')) {
                            $(this).select2('destroy');
                        }
                    } catch (e) {
                        console.log('Could not destroy Select2:', e);
                    }
                });

                // Initialize Select2 for new selects
                $('tbody select.editable:not(.select2-hidden-accessible)').each(function() {
                    const $select = $(this);
                    
                    // Ch·ªâ kh·ªüi t·∫°o n·∫øu select t·ªìn t·∫°i v√† kh√¥ng b·ªã disabled
                    if ($select.length && !$select.prop('disabled')) {
                        // Ki·ªÉm tra xem c√≥ options h·ª£p l·ªá kh√¥ng
                        const hasOptions = $select.find('option').length > 1 || 
                                        ($select.find('option').length === 1 && $select.find('option').first().val() !== '');
                        
                        if (hasOptions) {
                            try {
                                // S·ª≠ d·ª•ng m·ªôt Select2 configuration ƒë∆°n gi·∫£n
                                $select.select2({
                                    width: '100%',
                                    minimumResultsForSearch: 3,
                                    language: 'vi',
                                    placeholder: "Ch·ªçn...",
                                    allowClear: true,
                                    dropdownParent: $('body')  // S·ª≠ d·ª•ng body ƒë·ªÉ tr√°nh b·ªã c·∫Øt
                                });
                                
                                console.log('Select2 initialized for:', $select.attr('data-field'));
                            } catch (error) {
                                console.error('Error initializing Select2 for element:', error);
                                // Th√™m fallback: disable Select2 v√† ch·ªâ hi·ªÉn th·ªã native select
                                $select.removeClass('select2-hidden-accessible');
                            }
                        } else {
                            // N·∫øu kh√¥ng c√≥ options, ·∫©n select v√† hi·ªÉn th·ªã input thay th·∫ø
                            const field = $select.attr('data-field');
                            const id = $select.attr('data-id');
                            
                            // T·∫°o input thay th·∫ø
                            const $input = $('<input>', {
                                type: 'text',
                                class: 'w-full bg-transparent border-none text-sm',
                                placeholder: 'Kh√¥ng c√≥ d·ªØ li·ªáu',
                                readonly: true
                            });
                            
                            $select.hide().after($input);
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing table Select2:', error);
            }
		}
		
        // Render b·∫£ng d·ªØ li·ªáu
		function renderTable() {
            const tableBody = document.getElementById('table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (!monHocData || monHocData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="19" class="px-4 py-4 text-center text-gray-500">
                            Kh√¥ng c√≥ d·ªØ li·ªáu m√¥n h·ªçc
                        </td>
                    </tr>
                `;
                updateStatistics();
                return;
            }
            
            // Render rows
            monHocData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="px-2 py-2 text-center">${index + 1}</td>
                    <td class="px-2 py-2">
                        <input type="text" value="${escapeHtml(item.ma_mon_hoc || '')}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="code" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2">
                        <input type="text" value="${escapeHtml(item.ten_mon_hoc || '')}" 
                            class="editable w-full bg-transparent border-none text-sm"
                            data-field="name" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="number" value="${item.so_tin_chi || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="credits" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="number" value="${item.tong_so_gio || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="total_hours" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="number" value="${item.ly_thuyet || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="theory_hours" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="number" value="${item.thuc_hanh || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="practice_hours" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="number" value="${item.kiem_tra || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="tests_hours" data-id="${item.id}" readonly>
                    </td>
                    <td class="px-2 py-2 text-center">
                        <input type="number" value="${item.thi || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="exam_hours" data-id="${item.id}" readonly>
                    </td>
                    <!-- HK columns -->
                    ${[1,2,3,4,5,6].map(i => `
                        <td class="px-2 py-2 text-center">
                            <input type="number" value="${item[`hk${i}`] || ''}" 
                                class="editable w-full bg-transparent border-none text-sm text-center"
                                data-field="hk${i}" data-id="${item.id}" readonly
                                placeholder="-">
                        </td>
                    `).join('')}
                    <!-- Department select -->
                    <td class="px-2 py-2">
                        <select class="editable w-full text-sm" 
                                data-field="department" data-id="${item.id}" disabled>
                            <option value="">-- Ch·ªçn ƒë∆°n v·ªã --</option>
                            ${allDepartments.map(dept => `
                                <option value="${dept.id}" ${dept.id == item.department_id ? 'selected' : ''}>
                                    ${escapeHtml(dept.name)}
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <!-- Instructor input -->
                    <td class="px-2 py-2">
                        <input type="text" value="${escapeHtml(item.giang_vien || '')}" 
                            class="editable w-full bg-transparent border-none text-sm"
                            data-field="instructor" data-id="${item.id}" readonly>
                    </td>
                    <!-- Course select -->
                    <td class="px-2 py-2">
                        <select class="editable course-select w-full text-sm" 
                                data-field="course" data-id="${item.id}" disabled>
                            <option value="">-- Ch·ªçn --</option>
                            ${allCourses.map(course => `
                                <option value="${course.id}" ${course.id == item.course_id ? 'selected' : ''}>
                                    ${escapeHtml(course.name)} ${course.code ? '(' + escapeHtml(course.code) + ')' : ''}
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <!-- Action buttons -->
                    <td class="px-2 py-2 text-center">
                        <button class="btn-sua text-blue-600 hover:text-blue-900 mr-2" 
                                data-id="${item.id}" title="S·ª≠a">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-xoa text-red-600 hover:text-red-900" 
                                data-id="${item.id}" title="X√≥a">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            updateStatistics();

            setTimeout(() => {
                // Th√™m event listeners cho n√∫t s·ª≠a
                document.querySelectorAll('.btn-sua').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.getAttribute('data-id');
                        const row = this.closest('tr');
                        enterEditMode(row, this);
                    });
                });
                
                // Th√™m event listeners cho n√∫t x√≥a
                document.querySelectorAll('.btn-xoa').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = $(this).data('id');
                        if (id && confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc n√†y?')) {
                            deleteMonHoc(id);
                        }
                    });
                });
            }, 100);
        }

		// H√†m escape HTML ƒë·ªÉ tr√°nh XSS
		function escapeHtml(text) {
		    if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
		}
		
        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStatistics() {
            if (!monHocData || monHocData.length === 0) {
                $('#tong-tin-chi, #tong-gio').text('0');
                $('#ty-le-ly-thuyet, #ty-le-thuc-hanh').text('0%');
                return;
            }
            
            const totalCredits = monHocData.reduce((sum, item) => sum + (parseFloat(item.so_tin_chi) || 0), 0);
            const totalHours = monHocData.reduce((sum, item) => sum + (parseInt(item.tong_so_gio) || 0), 0);
            const totalTheory = monHocData.reduce((sum, item) => sum + (parseInt(item.ly_thuyet) || 0), 0);
            const totalPractice = monHocData.reduce((sum, item) => sum + (parseInt(item.thuc_hanh) || 0), 0);
            
            const tyLeLyThuyet = totalHours > 0 ? ((totalTheory / totalHours) * 100).toFixed(1) : 0;
            const tyLeThucHanh = totalHours > 0 ? ((totalPractice / totalHours) * 100).toFixed(1) : 0;
            
            $('#tong-tin-chi').text(totalCredits.toFixed(1));
            $('#tong-gio').text(totalHours);
            $('#ty-le-ly-thuyet').text(`${tyLeLyThuyet}%`);
            $('#ty-le-thuc-hanh').text(`${tyLeThucHanh}%`);
        }

        function getSampleData() {
            return {
                departments: [
                    { id: 1, code: 'CNTT', name: 'C√¥ng ngh·ªá Th√¥ng tin' },
                    { id: 2, code: 'DTVT', name: 'ƒêi·ªán t·ª≠ Vi·ªÖn th√¥ng' },
                    { id: 3, code: 'CK', name: 'C∆° kh√≠' },
                    { id: 4, code: 'XD', name: 'X√¢y d·ª±ng' }
                ],
                subjectGroups: [
                    { id: 1, name: 'T·ªï Tin h·ªçc', department_id: 1 },
                    { id: 2, name: 'T·ªï M·∫°ng m√°y t√≠nh', department_id: 1 },
                    { id: 3, name: 'T·ªï ƒêi·ªán t·ª≠', department_id: 2 },
                    { id: 4, name: 'T·ªï C∆° kh√≠ ch·∫ø t·∫°o', department_id: 3 }
                ],
                curricula: [
                    { id: 1, code: 'CT1', name: 'Ch∆∞∆°ng tr√¨nh CNTT 2023', academic_year: '2023-2024' },
                    { id: 2, code: 'CT2', name: 'Ch∆∞∆°ng tr√¨nh ƒêTVT 2023', academic_year: '2023-2024' }
                ],
                courses: [
                    { id: 1, code: 'K2023', name: 'Kh√≥a 2023', curriculum_id: 1 },
                    { id: 2, code: 'K2024', name: 'Kh√≥a 2024', curriculum_id: 1 },
                    { id: 3, code: 'K2023D', name: 'Kh√≥a 2023 ƒêTVT', curriculum_id: 2 }
                ],
                subjects: [
                    { id: 1, code: 'MH001', name: 'To√°n cao c·∫•p', credits: 3, total_hours: 45 },
                    { id: 2, code: 'MH002', name: 'L·∫≠p tr√¨nh c∆° b·∫£n', credits: 4, total_hours: 60 },
                    { id: 3, code: 'MH003', name: 'C∆° s·ªü d·ªØ li·ªáu', credits: 3, total_hours: 45 }
                ],
                majors: [
                    { id: 1, code: '7480201', name: 'C√¥ng ngh·ªá th√¥ng tin' },
                    { id: 2, code: '7510302', name: 'C√¥ng ngh·ªá k·ªπ thu·∫≠t ƒëi·ªán t·ª≠ - vi·ªÖn th√¥ng' }
                ],
                subjectTypes: [
                    { id: 1, code: 'BB', name: 'B·∫Øt bu·ªôc' },
                    { id: 2, code: 'TC', name: 'T·ª± ch·ªçn' }
                ]
            };
        }

        // Load th·ªëng k√™
        function loadThongKe(curriculumId) {
            fetch(`/thong-ke/?curriculum_id=${curriculumId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tong-tin-chi').textContent = data.tong_tin_chi;
                    document.getElementById('tong-gio').textContent = data.tong_gio;
                    document.getElementById('ty-le-ly-thuyet').textContent = data.ty_le_ly_thuyet;
                    document.getElementById('ty-le-thuc-hanh').textContent = data.ty_le_thuc_hanh;
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    updateStatistics();
                });
        }

		// C·∫≠p nh·∫≠t m√¥n h·ªçc
        function updateMonHoc(id, field, value) {
            try {
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    alert('L·ªói b·∫£o m·∫≠t: Kh√¥ng t√¨m th·∫•y CSRF token');
                    return;
                }
                
                const data = {
                    id: id,
                    field: field,
                    value: value
                };
                console.log('Sending update:', data);

                fetch(`/train-program/${id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status !== 'success') {
                        console.error('Update error:', data.message);
                        alert(data.message);
                        // Reload data to reset values
                        loadFilteredData();
                    } else {
                        console.log('Update success:', data.message);
                        //updateOriginalValue(id, field, value);
                        loadFilteredData();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t: ' + error.message);
                    loadFilteredData();
                });
            } catch (error) {
                console.error('Error in updateMonHoc:', error);
                alert('L·ªói trong h√†m updateMonHoc: ' + error.message);
            }
        }

        function getCSRFToken() {
            try {
                // Th·ª≠ t√¨m meta tag tr∆∞·ªõc
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                if (metaTag) {
                    return metaTag.getAttribute('content');
                }
                
                // Th·ª≠ t√¨m trong {% csrf_token %}
                const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfTokenInput) {
                    return csrfTokenInput.value;
                }
                
                // Th·ª≠ l·∫•y t·ª´ cookie
                return getCookie('csrftoken');
            } catch (error) {
                console.error('Error getting CSRF token:', error);
                return null;
            }
        }

        // H√†m c·∫≠p nh·∫≠t gi√° tr·ªã g·ªëc sau khi th√†nh c√¥ng
        function updateOriginalValue(id, field, value) {
            const input = document.querySelector(`[data-id="${id}"][data-field="${field}"]`);
            if (input) {
                input.setAttribute('data-original-value', value);
            }
        }

        // C·∫≠p nh·∫≠t ph√¢n b·ªë h·ªçc k·ª≥
        function updateSemesterAllocation(curriculumSubjectId, semester, credits) {
            const data = {
                id: curriculumSubjectId,
                field: `hk${semester}`,
                value: credits
            };
            
            console.log('Sending semester update:', data); // Debug log
            
            fetch(`/train-program/${curriculumSubjectId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Semester update error:', data.message);
                    alert('C√≥ l·ªói khi c·∫≠p nh·∫≠t h·ªçc k·ª≥: ' + data.message);
                    // Reload data to reset values
                    loadFilteredData();
                } else {
                    console.log('Semester update success:', data.message);
					loadFilteredData();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t h·ªçc k·ª≥: ' + error.message);
                loadFilteredData();
            });
        }
        
        // X√≥a m√¥n h·ªçc
        function deleteMonHoc(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc n√†y?')) {
                return;
            }
            
            fetch(`/train-program/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('ƒê√£ x√≥a m√¥n h·ªçc th√†nh c√¥ng');
                    loadFilteredData();
                } else {
                    alert('C√≥ l·ªói khi x√≥a: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a');
            });
        }
		
        async function loadFilteredData() {
            console.log('Loading filtered data...');
    
            const departmentId = $('#khoa-dao-tao').val();
            const subjectGroupId = $('#to-bo-mon').val();
            const curriculumId = $('#chuong-trinh-dao-tao').val();
            const courseId = $('#khoa-hoc').val();
            
            // Show loading
            $('#table-body').html(`
                <tr>
                    <td colspan="19" class="px-4 py-8 text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-700"></div>
                        <p class="mt-2 text-gray-600">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                    </td>
                </tr>
            `);
            
            
            // Build API URL
            const params = new URLSearchParams();
            if (curriculumId) params.append('curriculum_id', curriculumId);
            //if (departmentId) params.append('department_id', departmentId);
            //if (subjectGroupId) params.append('subject_group_id', subjectGroupId);
            //if (courseId) params.append('course_id', courseId);
            
            params.append('page_size', 50); // Gi·∫£m s·ªë l∆∞·ª£ng b·∫£n ghi
            params.append('page', 1);
            
            const url = `/api/subjects/${params.toString() ? '?' + params.toString() : ''}`;
            console.log('Fetching URL:', url);

            try {
                // Th·ª≠ v·ªõi timeout ng·∫Øn h∆°n
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 gi√¢y
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                }).catch(err => {
                    if (err.name === 'AbortError') {
                        throw new Error('Request timeout after 15 seconds');
                    }
                    throw err;
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Unknown error');
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
                }
                
                const result = await cachedFetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (result.status === 'success') {
                    monHocData = Array.isArray(result.data) ? result.data : [];
                    console.log(`Loaded ${monHocData.length} items`);
                    
                    renderTable();
                    updateStatistics();
                    
                    if (monHocData.length > 0) {
                        showNotification(`ƒê√£ t·∫£i ${monHocData.length} m√¥n h·ªçc`, 'success', 2000);
                    } else {
                        showNotification('Kh√¥ng c√≥ d·ªØ li·ªáu m√¥n h·ªçc', 'info', 2000);
                    }
                } else {
                    throw new Error(result.message || 'API returned error status');
                }
            } catch (error) {
                console.error('Error loading data:', error);

                // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói c·ª• th·ªÉ
                let errorMessage = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu';
                if (error.message.includes('timeout')) {
                    errorMessage = 'Y√™u c·∫ßu timeout. Vui l√≤ng th·ª≠ l·∫°i';
                } else if (error.message.includes('500')) {
                    errorMessage = 'L·ªói m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau';
                } else if (error.message.includes('502') || error.message.includes('503')) {
                    errorMessage = 'Server ƒëang qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau';
                } else {
                    errorMessage = `L·ªói: ${error.message}`;
                }
                
                // Show error in table
                $('#table-body').html(`
                    <tr>
                        <td colspan="19" class="px-4 py-4 text-center">
                            <div class="text-red-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p class="font-bold">${errorMessage}</p>
                                <button class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                        onclick="retryLoadData()">
                                    <i class="fas fa-redo mr-2"></i>Th·ª≠ l·∫°i
                                </button>
                                <button class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                                        onclick="loadWithFilters()">
                                    <i class="fas fa-filter mr-2"></i>Th·ª≠ v·ªõi √≠t filter h∆°n
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
                
                showNotification(errorMessage, 'error');
            }
        }

        function retryLoadData() {
            showNotification('ƒêang th·ª≠ t·∫£i l·∫°i d·ªØ li·ªáu...', 'info');
            loadFilteredData();
        }

        function loadWithFilters() {
            // Reset c√°c filter kh√¥ng c·∫ßn thi·∫øt
            $('#to-bo-mon').val('').trigger('change');
            $('#khoa-dao-tao').val('').trigger('change');
            $('#khoa-hoc').val('').trigger('change');
            
            setTimeout(() => {
                loadFilteredData();
            }, 500);
        }

        function useSampleData() {
            const sampleData = getSampleData().subjects.map((subject, index) => ({
                id: index + 1,
                ma_mon_hoc: subject.code,
                ten_mon_hoc: subject.name,
                so_tin_chi: subject.credits,
                tong_so_gio: subject.total_hours,
                ly_thuyet: Math.floor(subject.total_hours * 0.7),
                thuc_hanh: Math.floor(subject.total_hours * 0.3),
                kiem_tra: 0,
                thi: 0,
                hk1: subject.credits,
                hk2: '',
                hk3: '',
                hk4: '',
                hk5: '',
                hk6: '',
                don_vi: 'Khoa C√¥ng ngh·ªá th√¥ng tin',
                department_id: 1,
                giang_vien: 'Gi·∫£ng vi√™n m·∫´u',
                course_id: 1,
                curriculum_id: $('#chuong-trinh-dao-tao').val() || 1
            }));
            
            monHocData = sampleData;
            renderTable();
            updateStatistics();
            showNotification('ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u', 'warning');
        }

		// H√†m clear cache khi c·∫ßn
		function clearCache(cacheKey = null) {
            if (cacheKey) {
                dataCache.delete(cacheKey);
                console.log(`Cleared cache: ${cacheKey}`);
            } else {
                dataCache.clear();
                console.log('Cleared all cache');
            }
        }

        // Th√™m h√†m ƒë·ªÉ t·∫£i danh s√°ch m√¥n h·ªçc c√≥ s·∫µn
        function loadExistingSubjects() {
            safeFetch('/api/all-subjects/')
                .then(subjects => {
                    const select = document.getElementById('select-existing-subject');
                    if (select) {
						select.innerHTML = '<option value="">-- T√¨m ki·∫øm m√¥n h·ªçc c√≥ s·∫µn --</option>';
	                    
	                    subjects.forEach(subject => {
	                        const option = document.createElement('option');
	                        option.value = subject.id || subject.code;
	                        option.textContent = `${subject.code || ''} - ${subject.name || ''}`;
                    		option.setAttribute('data-subject', JSON.stringify(subject));
	                        select.appendChild(option);
	                    });
						
						// C·∫≠p nh·∫≠t Select2
		                if ($(select).hasClass('select2-hidden-accessible')) {
		                    $(select).trigger('change.select2');
		                }
					}

					// L∆∞u v√†o bi·∫øn to√†n c·ª•c
            		window.existingSubjects = subjects;
                })
                .catch(error => {
                    console.error('Error loading existing subjects:', error);
					
					// Fallback: s·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ monHocData
		            const existingSubjects = [];
		            const uniqueSubjects = {};
		            
		            if (monHocData && monHocData.length > 0) {
		                monHocData.forEach(item => {
		                    if (item.ma_mon_hoc && !uniqueSubjects[item.ma_mon_hoc]) {
		                        uniqueSubjects[item.ma_mon_hoc] = true;
		                        existingSubjects.push({
		                            id: item.id || item.ma_mon_hoc,
		                            code: item.ma_mon_hoc,
		                            name: item.ten_mon_hoc,
		                            credits: item.so_tin_chi,
		                            total_hours: item.tong_so_gio,
		                            theory_hours: item.ly_thuyet,
		                            practice_hours: item.thuc_hanh,
		                            tests_hours: item.kiem_tra,
		                            exam_hours: item.thi
		                        });
		                    }
		                });
					}

					// C·∫≠p nh·∫≠t dropdown v·ªõi fallback data
		            const select = document.getElementById('select-existing-subject');
		            if (select) {
		                select.innerHTML = '<option value="">-- T√¨m ki·∫øm m√¥n h·ªçc c√≥ s·∫µn --</option>';
		                
		                existingSubjects.forEach(subject => {
		                    const option = document.createElement('option');
		                    option.value = subject.id;
		                    option.textContent = `${subject.code} - ${subject.name}`;
		                    option.setAttribute('data-subject', JSON.stringify(subject));
		                    select.appendChild(option);
		                });
		            }

					window.existingSubjects = existingSubjects;
                });
        }

		// T·∫£i danh s√°ch m√¥n h·ªçc c√≥ s·∫µn t·ª´ d·ªØ li·ªáu hi·ªán t·∫°i
		function loadExistingSubjectsFromCurrentData() {
		    console.log('Loading existing subjects from current data...');
		    
		    // S·ª≠ d·ª•ng d·ªØ li·ªáu monHocData hi·ªán t·∫°i ƒë·ªÉ t·∫°o danh s√°ch m√¥n h·ªçc c√≥ s·∫µn
		    const existingSubjects = [];
			const seenCodes = new Set();
		    
		    // L·ªçc c√°c m√¥n h·ªçc duy nh·∫•t t·ª´ monHocData
		    const uniqueSubjects = {};
		    if (monHocData && monHocData.length > 0) {
		        monHocData.forEach(item => {
		            const code = item.ma_mon_hoc;
					if (code && !seenCodes.has(code)) {
						seenCodes.add(code);
						existingSubjects.push({
							id: item.id || code,
							code: code,
							name: item.ten_mon_hoc,
							credits: item.so_tin_chi,
							total_hours: item.tong_so_gio,
							theory_hours: item.ly_thuyet,
							practice_hours: item.thuc_hanh,
							tests_hours: item.kiem_tra,
							exam_hours: item.thi
						});
					}
		        });
		    }
		    
		    // Th√™m m·ªôt s·ªë m√¥n h·ªçc m·∫´u n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
		    if (existingSubjects.length === 0) {
		        existingSubjects.push(
		            { id: 1, code: 'MH001', name: 'To√°n cao c·∫•p', credits: 3, total_hours: 45, theory_hours: 30, practice_hours: 15 },
		            { id: 2, code: 'MH002', name: 'L·∫≠p tr√¨nh c∆° b·∫£n', credits: 4, total_hours: 60, theory_hours: 30, practice_hours: 30 },
		            { id: 3, code: 'MH003', name: 'C∆° s·ªü d·ªØ li·ªáu', credits: 3, total_hours: 45, theory_hours: 25, practice_hours: 20 }
		        );
		    }
		    
		    // C·∫≠p nh·∫≠t dropdown
		    const select = document.getElementById('select-existing-subject');
		    if (select) {
		        // X√≥a t·∫•t c·∫£ options tr·ª´ option ƒë·∫ßu ti√™n
		        while (select.options.length > 1) {
		            select.remove(1);
		        }
		        
		        existingSubjects.forEach(subject => {
		            const option = document.createElement('option');
		            option.value = subject.id;
		            option.textContent = `${subject.code} - ${subject.name}`;
		            
		            // S·ª≠ d·ª•ng data attributes an to√†n
		            try {
		                option.setAttribute('data-subject', JSON.stringify(subject));
		            } catch (e) {
		                console.warn('Could not stringify subject:', subject);
		            }
		            
		            select.appendChild(option);
		        });
		        
		        // C·∫≠p nh·∫≠t Select2 n·∫øu ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o
		        if ($(select).hasClass('select2-hidden-accessible')) {
		            $(select).trigger('change.select2');
		        }
		    }
		    
		    console.log('Loaded', existingSubjects.length, 'existing subjects');
    		return existingSubjects;
		}

        // T·∫°o m√¥n h·ªçc m·ªõi
        function createMonHoc() {
            const form = document.getElementById('form-them-mon-hoc');
            if (!form) {
                console.error('Form them mon hoc not found');
                alert('Kh√¥ng t√¨m th·∫•y form th√™m m√¥n h·ªçc');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
                        
            // Validate d·ªØ li·ªáu
            if (!data.curriculum_id || !data.code || !data.name || !data.credits || !data.subject_type_id) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc (*)');
                return;
            }
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu h·ªçc k·ª≥
            const semesterData = {};
            for (let i = 1; i <= 6; i++) {
                const hkValue = data[`hk${i}`];
                if (hkValue && hkValue !== '') {
                    try {
                        semesterData[`hk${i}`] = parseFloat(hkValue);
                    } catch (e) {
                        console.error(`Error parsing HK${i} value:`, hkValue);
                    }
                }
            }
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu g·ª≠i ƒëi
            const postData = {
                ...data,
                semester_allocations: semesterData
            };
                        
            // Hi·ªÉn th·ªã loading
            const saveBtn = document.getElementById('btn-luu-mon-hoc');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang t·∫°o...';
            saveBtn.disabled = true;
            
            fetch('/api/subjects/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(postData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úÖ ƒê√£ t·∫°o m√¥n h·ªçc th√†nh c√¥ng!');
                    closeThemMonHocModal();
                    // Reload d·ªØ li·ªáu
                    loadFilteredData();
                } else {
                    alert('‚ùå L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o m√¥n h·ªçc: ' + error.message);
            })
            .finally(() => {
                // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // T·∫°o ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o m·ªõi
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Validate
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc');
                return;
            }
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o th√†nh c√¥ng');
                    document.getElementById('modal-them-chuong-trinh').classList.add('hidden');
                    form.reset();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi t·∫°o ch∆∞∆°ng tr√¨nh');
            });
        }
        
        // M·ªü modal import Excel
        function openImportModal() {
            $('#modal-import').removeClass('hidden');
            $('body').addClass('overflow-hidden');
        }

        // ƒê√≥ng modal import Excel
        function closeImportModal() {
            $('#modal-import').addClass('hidden');
            $('body').removeClass('overflow-hidden');
        }

        // M·ªü modal l·ªói import
        function openImportErrorsModal() {
            document.getElementById('modal-import-errors').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        // ƒê√≥ng modal l·ªói import
        function closeImportErrorsModal() {
            document.getElementById('modal-import-errors').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // Hi·ªÉn th·ªã l·ªói import
        function showImportErrors(errors) {
            const errorsContent = document.getElementById('import-errors-content');
            if (errors && errors.length > 0) {
                errorsContent.innerHTML = `
                    <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded">
                        <h4 class="font-semibold text-red-800 mb-2">C√≥ ${errors.length} l·ªói c·∫ßn xem x√©t:</h4>
                    </div>
                    <div class="space-y-2">
                        ${errors.map(error => 
                            `<div class="flex items-start text-red-700 py-2 border-b border-red-100">
                                <i class="fas fa-exclamation-circle mt-1 mr-2 text-red-500 flex-shrink-0"></i>
                                <span class="text-sm">${error}</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
            } else {
                errorsContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <div class="text-green-600 font-semibold">Kh√¥ng c√≥ l·ªói n√†o trong qu√° tr√¨nh import</div>
                    </div>
                `;
            }
            openImportErrorsModal();
        }

        // Import Excel v·ªõi x·ª≠ l√Ω l·ªói chi ti·∫øt
        function importExcel() {
            const form = document.getElementById('form-import');
            const formData = new FormData(form);
            const curriculumId = document.getElementById('import-curriculum').value;
            const courseId = document.getElementById('import-course').value;
            const fileInput = document.getElementById('excel-file');
            const sheetSelect = document.getElementById('sheet-select');
            
            if (!curriculumId) {
                alert('Vui l√≤ng ch·ªçn ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Vui l√≤ng ch·ªçn file Excel');
                return;
            }

            // Th√™m th√¥ng tin sheet v√†o formData
            const selectedSheet = sheetSelect.value;
            if (selectedSheet) {
                formData.append('sheet_name', selectedSheet);
            }
            
            // Hi·ªÉn th·ªã loading
            const importBtn = document.getElementById('btn-luu-import');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang x·ª≠ l√Ω...';
            importBtn.disabled = true;
            
            fetch('/import-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    let successMessage = '‚úÖ ' + data.message;
                    if (data.sheet_used) {
                        successMessage += ` (Sheet: ${data.sheet_used})`;
                    }
                    alert(successMessage);
                    closeImportModal();
                    
                    // Hi·ªÉn th·ªã chi ti·∫øt l·ªói n·∫øu c√≥
                    if (data.data && data.data.errors && data.data.errors.length > 0) {
                        showImportErrors(data.data.errors);
                    }
                    
                    // Reload data
                    loadFilteredData();
                } else {
                    alert('‚ùå L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi import file: ' + error.message);
            })
            .finally(() => {
                // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            });
        }

        // T·∫£i file m·∫´u
        function downloadTemplate() {
            window.open('/download-excel-template/', '_blank');
        }
        
        // Load l·∫°i danh s√°ch curricula
        function loadCurricula() {
            fetch('/api/curricula/')
                .then(response => response.json())
                .then(data => {
                    allCurricula = data;
                    populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
                    populateDropdown('import-curriculum', allCurricula, 'name');
                })
                .catch(error => {
                    console.error('Error loading curricula:', error);
                });
        }

        // Load l·∫°i danh s√°ch courses
        function loadCourses() {
            fetch('/api/courses/')
                .then(response => response.json())
                .then(data => {
                    allCourses = data;
                    populateDropdown('khoa-hoc', allCourses, 'name');
                    populateDropdown('import-course', allCourses, 'name');
                })
                .catch(error => {
                    console.error('Error loading curricula:', error);
                });
        }

        // H√†m l·∫•y danh s√°ch sheet t·ª´ file Excel
        function getSheetNamesFromFile(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('excel_file', file);
                
                fetch('/api/get-sheet-names/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        resolve(data.sheet_names);
                    } else {
                        reject(new Error(data.message));
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }
        
        // M·ªü modal th√™m ch∆∞∆°ng tr√¨nh
        function openThemChuongTrinhModal() {
			$('#modal-them-chuong-trinh').removeClass('hidden');
            $('body').addClass('overflow-hidden');
        }

        // ƒê√≥ng modal th√™m ch∆∞∆°ng tr√¨nh
        function closeThemChuongTrinhModal() {
			$('#modal-them-chuong-trinh').addClass('hidden');
            $('body').removeClass('overflow-hidden');
        }

        // H√†m ki·ªÉm tra v√† s·ª≠a l·ªói input trong modal
        function fixModalInputs() {
            const chuongTrinhModal = document.getElementById('modal-them-chuong-trinh');
            if (!chuongTrinhModal) return;
            
            const inputs = chuongTrinhModal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                // X√≥a c√°c attribute ch·∫∑n input
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
                
                // ƒê·∫£m b·∫£o c√°c thu·ªôc t√≠nh style ƒë√∫ng
                input.style.pointerEvents = 'auto';
                input.style.userSelect = 'auto';
                input.style.backgroundColor = 'white';
                input.style.cursor = 'text';
                
                // Th√™m event listener ƒë·ªÉ debug
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Input clicked:', this.name);
                });
                
                input.addEventListener('focus', function(e) {
                    e.stopPropagation();
                    console.log('Input focused:', this.name);
                    this.style.borderColor = '#3b82f6';
                    this.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
                });
                
                input.addEventListener('blur', function(e) {
                    e.stopPropagation();
                    this.style.borderColor = '#d1d5db';
                    this.style.boxShadow = 'none';
                });
            });
        }

        // T·∫°o ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o m·ªõi
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            if (!form) {
                console.error('Form not found');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            console.log('Form data:', data);
            
            // Validate d·ªØ li·ªáu
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng b·∫Øt bu·ªôc');
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            const saveBtn = document.getElementById('btn-luu-chuong-trinh');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang t·∫°o...';
            saveBtn.disabled = true;
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úÖ ƒê√£ t·∫°o ch∆∞∆°ng tr√¨nh ƒë√†o t·∫°o th√†nh c√¥ng!');
                    closeThemChuongTrinhModal();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('‚ùå L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o ch∆∞∆°ng tr√¨nh: ' + error.message);
            })
            .finally(() => {
                // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

		// H√†m ƒë√≥ng t·∫•t c·∫£ Select2 ƒëang m·ªü
		function closeAllOpenSelect2() {
		    try {
		        // ƒê√≥ng t·∫•t c·∫£ Select2 dropdown ƒëang m·ªü
		        $('.select2-container--open').each(function() {
		            try {
                        // Ki·ªÉm tra xem ph·∫ßn t·ª≠ n√†y c√≥ ph·∫£i l√† Select2 container kh√¥ng
                        if ($(this).hasClass('select2-container--open')) {
                            // T√¨m select element t∆∞∆°ng ·ª©ng
                            const selectElement = $(this).siblings('select');
                            if (selectElement.length && selectElement.data('select2')) {
                                selectElement.select2('close');
                            }
                        }
                    } catch (e) {
                        console.log('Could not close select2:', e);
                    }
		        });
		    } catch (error) {
		        console.error('Error closing select2:', error);
		    }
		}
		
        // M·ªü modal th√™m m√¥n h·ªçc
        function openThemMonHocModal() {
			$('#modal-them-mon-hoc').removeClass('hidden');
            $('body').addClass('overflow-hidden');

            // Reset form
            $('#form-them-mon-hoc')[0].reset();
            $('#existing-subject-info').addClass('hidden');
            $('#select-existing-subject').val('').trigger('change');
            
            // Load danh s√°ch m√¥n h·ªçc c√≥ s·∫µn
            loadAllSubjects();
            
            // Kh·ªüi t·∫°o Select2 cho modal
            setTimeout(() => {
                initializeSelect2ForSubjectModal();
                enableModalInputs();
            }, 100);
        }

		// H√†m cleanup khi ƒë√≥ng modal
		function cleanupModalResources() {
		    // H·ªßy t·∫•t c·∫£ Select2 trong modal ƒëang m·ªü
		    $('.modal:not(.hidden) .select2-hidden-accessible').each(function() {
		        $(this).select2('destroy');
		    });
		    
		    // Clear timeout
		    if (instructorSearchTimeout) {
		        clearTimeout(instructorSearchTimeout);
		        instructorSearchTimeout = null;
		    }
		    
		    if (filterTimeout) {
		        clearTimeout(filterTimeout);
		        filterTimeout = null;
		    }
		}
		
        // ƒê√≥ng modal th√™m m√¥n h·ªçc
        function closeThemMonHocModal() {
			$('#modal-them-mon-hoc').addClass('hidden');
            $('body').removeClass('overflow-hidden');
        }

        // C·∫≠p nh·∫≠t th√¥ng tin ng√†nh ƒë√†o t·∫°o khi ch·ªçn ch∆∞∆°ng tr√¨nh
        function updateMajorInfo(curriculumId) {
            const majorField = document.getElementById('them-mon-hoc-major');
            if (!majorField || !curriculumId) {
                return;
            }
            
            // T√¨m th√¥ng tin ch∆∞∆°ng tr√¨nh
            const curriculum = allCurricula.find(c => c.id == curriculumId);
            if (curriculum && curriculum.major_id) {
                const major = allMajors.find(m => m.id == curriculum.major_id);
                if (major) {
                    majorField.value = `${major.name} (${major.code})`;
                    return;
                }
            }
            majorField.value = 'Kh√¥ng x√°c ƒë·ªãnh';
        }

        // L·ªçc t·ªï b·ªô m√¥n theo khoa
        function filterSubjectGroupsByDepartment(departmentId) {
            const subjectGroupSelect = document.getElementById('to-bo-mon');
            if (!subjectGroupSelect) return;

			// L∆∞u gi√° tr·ªã hi·ªán t·∫°i
    		const currentValue = subjectGroupSelect.value;
            
            // N·∫øu c√≥ departmentId, l·ªçc theo departmentId
		    if (departmentId) {
		        filteredSubjectGroups = allSubjectGroups.filter(group => 
		            group.department_id == departmentId
		        );
		    } else {
		        filteredSubjectGroups = [...allSubjectGroups];
		    }
		    
		    // C·∫≠p nh·∫≠t dropdown
		    subjectGroupSelect.innerHTML = '<option value="">-- Ch·ªçn t·ªï b·ªô m√¥n --</option>';
		    
		    filteredSubjectGroups.forEach(group => {
		        const option = document.createElement('option');
		        option.value = group.id;
		        option.textContent = group.name;
		        option.setAttribute('data-department', group.department_id);
		        subjectGroupSelect.appendChild(option);
		    });
		    
		    // Kh√¥i ph·ª•c gi√° tr·ªã c≈© n·∫øu v·∫´n c√≥ trong danh s√°ch ƒë√£ l·ªçc
		    if (currentValue && filteredSubjectGroups.some(g => g.id == currentValue)) {
		        subjectGroupSelect.value = currentValue;
		    } else {
		        subjectGroupSelect.value = '';
		        // Trigger change ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
		        $(subjectGroupSelect).trigger('change');
		    }
		    
		    // C·∫≠p nh·∫≠t Select2
		    if ($(subjectGroupSelect).hasClass('select2-hidden-accessible')) {
		        $(subjectGroupSelect).trigger('change.select2');
		    }
        }

		// H√†m l·ªçc danh s√°ch kh√≥a h·ªçc theo ch∆∞∆°ng tr√¨nh
		function filterCoursesByCurriculum(curriculumId) {
		    const courseSelect = document.getElementById('khoa-hoc');
		    
		    if (!courseSelect) return;
		    
		    // L∆∞u gi√° tr·ªã hi·ªán t·∫°i
		    const currentValue = courseSelect.value;
		    
		    // N·∫øu c√≥ curriculumId, l·ªçc theo curriculumId
		    if (curriculumId) {
		        filteredCourses = allCourses.filter(course => 
		            course.curriculum_id == curriculumId
		        );
		    } else {
		        filteredCourses = [...allCourses];
		    }
		    
		    // C·∫≠p nh·∫≠t dropdown
		    courseSelect.innerHTML = '<option value="">-- Ch·ªçn kh√≥a h·ªçc --</option>';
		    
		    filteredCourses.forEach(course => {
		        const option = document.createElement('option');
		        option.value = course.id;
		        option.textContent = course.name;
		        if (course.code) {
		            option.textContent += ` (${course.code})`;
		        }
		        option.setAttribute('data-curriculum', course.curriculum_id);
		        courseSelect.appendChild(option);
		    });
		    
		    // Kh√¥i ph·ª•c gi√° tr·ªã c≈© n·∫øu v·∫´n c√≥ trong danh s√°ch ƒë√£ l·ªçc
		    if (currentValue && filteredCourses.some(c => c.id == currentValue)) {
		        courseSelect.value = currentValue;
		    } else {
		        courseSelect.value = '';
		        // Trigger change ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
		        $(courseSelect).trigger('change');
		    }
		    
		    // C·∫≠p nh·∫≠t Select2
		    if ($(courseSelect).hasClass('select2-hidden-accessible')) {
		        $(courseSelect).trigger('change.select2');
		    }
		}

		// H√†m reset c√°c dropdown ph·ª• thu·ªôc
		function resetDependentDropdowns() {
		    // Khi thay ƒë·ªïi khoa, reset t·ªï b·ªô m√¥n
		    $(document).on('change', '#khoa-dao-tao', function() {
		        const departmentId = this.value;
		        
		        // Reset v√† l·ªçc t·ªï b·ªô m√¥n
		        filterSubjectGroupsByDepartment(departmentId);
		        
		        // Load d·ªØ li·ªáu m√¥n h·ªçc theo khoa
		        loadFilteredData();
		    });

			// Khi thay ƒë·ªïi ch∆∞∆°ng tr√¨nh, reset kh√≥a h·ªçc
		    $(document).on('change', '#chuong-trinh-dao-tao', function() {
		        const curriculumId = this.value;
		        
		        // Reset v√† l·ªçc kh√≥a h·ªçc
		        filterCoursesByCurriculum(curriculumId);
		        
		        // Load d·ªØ li·ªáu m√¥n h·ªçc theo ch∆∞∆°ng tr√¨nh
		        loadFilteredData();
		    });
		    
		    // Khi thay ƒë·ªïi t·ªï b·ªô m√¥n, load d·ªØ li·ªáu
		    $(document).on('change', '#to-bo-mon', loadFilteredData);
		    
		    // Khi thay ƒë·ªïi kh√≥a h·ªçc, load d·ªØ li·ªáu
		    $(document).on('change', '#khoa-hoc', loadFilteredData);
		}

        // H√†m x·ª≠ l√Ω khi ch·ªçn m√¥n h·ªçc c√≥ s·∫µn
        function handleUseExistingSubject() {
            const select = document.getElementById('select-existing-subject');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Vui l√≤ng ch·ªçn m·ªôt m√¥n h·ªçc');
                return;
            }
            
            // Hi·ªÉn th·ªã th√¥ng tin m√¥n h·ªçc ƒë√£ ch·ªçn
            document.getElementById('existing-subject-info').classList.remove('hidden');
            document.getElementById('selected-subject-name').textContent = 
                `${selectedOption.getAttribute('data-code')} - ${selectedOption.getAttribute('data-name')}`;
            
            // ƒêi·ªÅn th√¥ng tin v√†o form
            document.querySelector('input[name="code"]').value = selectedOption.getAttribute('data-code');
            document.querySelector('input[name="name"]').value = selectedOption.getAttribute('data-name');
            
            // Disable c√°c tr∆∞·ªùng m√£ v√† t√™n ƒë·ªÉ tr√°nh ch·ªânh s·ª≠a
            document.querySelector('input[name="code"]').setAttribute('readonly', 'true');
            document.querySelector('input[name="name"]').setAttribute('readonly', 'true');
        }

        // H√†m x√≥a l·ª±a ch·ªçn
        function clearSubjectSelection() {
            document.getElementById('existing-subject-info').classList.add('hidden');
            document.getElementById('select-existing-subject').value = '';
            document.querySelector('input[name="code"]').removeAttribute('readonly');
            document.querySelector('input[name="name"]').removeAttribute('readonly');
            document.querySelector('input[name="code"]').value = '';
            document.querySelector('input[name="name"]').value = '';
        }

        // H√†m t√¨m ki·∫øm gi·∫£ng vi√™n v·ªõi debounce
        function searchInstructors(query, targetInput) {
            if (instructorSearchTimeout) {
                clearTimeout(instructorSearchTimeout);
            }
            
            // Clear suggestions n·∫øu query qu√° ng·∫Øn
            if (query.length < 2) {
                clearInstructorSuggestions(targetInput);
                return;
            }
            
            instructorSearchTimeout = setTimeout(() => {
                fetch(`/api/search-instructors/?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        console.log('API response status:', response.status); // Debug
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(instructors => {
                        console.log('API returned instructors:', instructors); // Debug
                        showInstructorSuggestions(instructors, targetInput);
                    })
                    .catch(error => {
                        console.error('Error searching instructors:', error);
                        clearInstructorSuggestions(targetInput);
                    });
            }, 300);
        }

        // H√†m hi·ªÉn th·ªã suggestions
        function showInstructorSuggestions(instructors, targetInput) {            
            // T√¨m datalist li√™n k·∫øt v·ªõi input
            const datalist = targetInput.nextElementSibling;
            if (!datalist || datalist.tagName !== 'DATALIST') {
                console.error('Datalist not found for input:', targetInput);
                return;
            }
            
            datalist.innerHTML = '';
            
            if (instructors.length === 0) {
                return;
            }
            
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor.full_name;
                option.textContent = `${instructor.full_name} (${instructor.code})`;
                option.setAttribute('data-instructor-id', instructor.id);
                datalist.appendChild(option);
            });
            
        }

        // H√†m x√≥a suggestions
        function clearInstructorSuggestions(targetInput) {
            const datalist = targetInput.nextElementSibling;
            if (datalist && datalist.tagName === 'DATALIST') {
                datalist.innerHTML = '';
            }
        }

        // H√†m x·ª≠ l√Ω khi ch·ªçn m·ªôt suggestion
        function handleInstructorSelection(input) {
            // C√≥ th·ªÉ th√™m logic x·ª≠ l√Ω khi ch·ªçn suggestion ·ªü ƒë√¢y
            console.log('Instructor selected:', input.value);
        }

        // H√†m kh·ªüi t·∫°o autocomplete cho t·∫•t c·∫£ input gi·∫£ng vi√™n
        function initializeInstructorAutocompleteForTable() {
            const inputs = document.querySelectorAll('.instructor-autocomplete');
		    inputs.forEach(input => {
		        // Ch·ªâ kh·ªüi t·∫°o cho c√°c input ch∆∞a c√≥ autocomplete v√† kh√¥ng ph·∫£i readonly
		        if (!input.hasAttribute('data-autocomplete-initialized') && !input.readOnly) {
		            initializeInstructorAutocompleteForInput(input);
		        }
		    });
        }

        // H√†m load t·∫•t c·∫£ m√¥n h·ªçc ƒë·ªÉ populate dropdowns
        function loadAllSubjects() {
			console.log('Loading all subjects for dropdown...');

            // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu t·ª´ template, d√πng lu√¥n
            if (allSubjects && allSubjects.length > 0) {
                populateSubjectSelect(allSubjects);
                return;
            }
            
            // N·∫øu kh√¥ng, g·ªçi API
            fetch('/api/all-subjects/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // X·ª≠ l√Ω c√°c ƒë·ªãnh d·∫°ng response kh√°c nhau
                    let subjects = [];
                    if (Array.isArray(data)) {
                        subjects = data;
                    } else if (data && data.data && Array.isArray(data.data)) {
                        subjects = data.data;
                    } else if (data && Array.isArray(data.subjects)) {
                        subjects = data.subjects;
                    }
                    
                    allSubjects = subjects;
                    console.log(`Loaded ${allSubjects.length} subjects for dropdown`);
                    populateSubjectSelect(allSubjects);
                })
                .catch(error => {
                    console.error('Error loading subjects:', error);
                    // Fallback: s·ª≠ d·ª•ng d·ªØ li·ªáu t·ª´ monHocData
                    const fallbackSubjects = monHocData.map(item => ({
                        id: item.id,
                        code: item.ma_mon_hoc,
                        name: item.ten_mon_hoc,
                        credits: item.so_tin_chi,
                        total_hours: item.tong_so_gio
                    }));
                    populateSubjectSelect(fallbackSubjects);
                });
        }

		function enableModalInputs() {
		    const monHocModal = document.getElementById('modal-them-mon-hoc');
		    if (!monHocModal) return;
		    
		    const allInputs = monHocModal.querySelectorAll('input, select, textarea');
		    allInputs.forEach(input => {
		        // Remove any blocking attributes
		        input.removeAttribute('disabled');
		        input.removeAttribute('readonly');
		        
		        // Force styles
		        input.style.pointerEvents = 'auto';
		        input.style.cursor = 'text';
		        input.style.userSelect = 'auto';
		        input.style.webkitUserSelect = 'auto';
		        input.style.backgroundColor = 'white';
		        input.style.color = '#000';
		        input.style.opacity = '1';
		        
		        // Add event listeners to ensure they work
		        input.addEventListener('mousedown', function(e) {
		            e.stopPropagation();
		        });
		        
		        input.addEventListener('click', function(e) {
		            e.stopPropagation();
		        });
		        
		        input.addEventListener('focus', function(e) {
		            this.style.outline = '2px solid #3b82f6';
		        });
		        
		        input.addEventListener('blur', function(e) {
		            this.style.outline = '';
		        });
		    });

            // ƒê·∫£m b·∫£o Select2 ƒë∆∞·ª£c enable
            setTimeout(() => {
                $('.modal select').each(function() {
                    const $select = $(this);
                    if ($select.hasClass('select2-hidden-accessible')) {
                        $select.select2('enable');
                    }
                });
            }, 50);
		}

		// ===== ENTER EDIT MODE FUNCTION =====
		function enterEditMode(row, button) {
		    console.log('Entering edit mode');
    
            // Update button
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.classList.remove('btn-sua', 'text-blue-600');
            button.classList.add('btn-luu', 'text-green-600');
            button.title = 'L∆∞u thay ƒë·ªïi';
            
            button.onclick = function(e) {
                e.stopPropagation();
                exitEditMode(row, button, button.getAttribute('data-id'));
            };
            
            // Enable c√°c input trong row
            const inputs = row.querySelectorAll('input.editable');
            inputs.forEach(input => {
                input.readOnly = false;
                input.classList.add('border', 'border-blue-300', 'px-1');
            });
            
            // Enable v√† kh·ªüi t·∫°o Select2 cho c√°c select
            const selects = row.querySelectorAll('select');
            selects.forEach(select => {
                select.disabled = false;
                select.classList.add('border', 'border-blue-300');
                
                // Ch·ªâ kh·ªüi t·∫°o Select2 n·∫øu c√≥ options
                if ($(select).find('option').length > 0) {
                    try {
                        $(select).select2({
                            width: '100%',
                            dropdownParent: $('body'),
                            minimumResultsForSearch: 3,
                            language: 'vi'
                        });
                    } catch (error) {
                        console.log('Could not initialize Select2:', error);
                    }
                }
            });
            
            // T·∫°o autocomplete cho gi·∫£ng vi√™n
            const instructorInput = row.querySelector('input[data-field="instructor"]');
            if (instructorInput) {
                instructorInput.readOnly = false;
                // Kh·ªüi t·∫°o autocomplete n·∫øu c·∫ßn
                initializeInstructorAutocompleteForInput(instructorInput);
            }
		}
		
		// ===== EXIT EDIT MODE FUNCTION =====
		function exitEditMode(row, button, id) {
		    console.log('Exiting edit mode for:', id);
    
            // Update button
            button.innerHTML = '<i class="fas fa-edit"></i>';
            button.classList.remove('text-green-600');
            button.classList.add('text-blue-600');
            button.title = 'S·ª≠a';
            
            button.onclick = function(e) {
                e.stopPropagation();
                enterEditMode(row, button);
            };
            
            // Collect changes
            const changes = {};
            
            // Process selects (destroy Select2 first)
            const selects = row.querySelectorAll('select');
            selects.forEach(select => {
                const $select = $(select);
                if ($select.hasClass('select2-hidden-accessible')) {
                    try {
                        $select.select2('destroy');
                    } catch (e) {
                        console.log('Could not destroy Select2:', e);
                    }
                }
                
                const field = select.getAttribute('data-field');
                const value = select.value;
                changes[field] = value;
                
                // Disable select
                select.disabled = true;
                select.classList.remove('border', 'border-blue-300');
            });
            
            // Process inputs
            const inputs = row.querySelectorAll('input.editable');
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const value = input.value;
                changes[field] = value;
                input.readOnly = true;
                input.classList.remove('border', 'border-blue-300', 'px-1');
            });
            
            // Save changes
            if (Object.keys(changes).length > 0) {
                saveChanges(id, changes);
            }
		}
		
		// ===== SAVE CHANGES FUNCTION =====
		function saveChanges(id, changes) {
		    const csrfToken = getCSRFToken();
		    
		    // Chu·∫©n b·ªã d·ªØ li·ªáu
		    const data = {
		        id: id,
		        changes: changes
		    };
		    
		    console.log('Sending changes to server:', data);
		    
		    fetch(`/train-program/${id}/update-multiple/`, {
		        method: 'POST',
		        headers: {
		            'Content-Type': 'application/json',
		            'X-CSRFToken': csrfToken,
		            'X-Requested-With': 'XMLHttpRequest'
		        },
		        body: JSON.stringify(data)
		    })
		    .then(response => {
		        if (!response.ok) {
		            throw new Error(`HTTP ${response.status}`);
		        }
		        return response.json();
		    })
		    .then(data => {
		        if (data.status === 'success') {
		            console.log('Changes saved successfully:', data.message);
		            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
		            showNotification('ƒê√£ l∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');
		            
		            // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·ª•c b·ªô n·∫øu c·∫ßn
		            updateLocalData(id, changes);
		        } else {
		            console.error('Save error:', data.message);
		            showNotification('L·ªói: ' + data.message, 'error');
		            // Rollback changes
		            setTimeout(() => {
		                loadFilteredData();
		            }, 1000);
		        }
		    })
		    .catch(error => {
		        console.error('Error saving changes:', error);
		        showNotification('C√≥ l·ªói x·∫£y ra khi l∆∞u thay ƒë·ªïi', 'error');
		        // Rollback changes
		        setTimeout(() => {
		            loadFilteredData();
		        }, 1000);
		    });
		}

		// ===== INITIALIZE AUTOCORRECT FOR SPECIFIC INPUT =====
		function initializeInstructorAutocompleteForInput(inputElement) {
		    // Ki·ªÉm tra xem ƒë√£ kh·ªüi t·∫°o ch∆∞a
		    if (inputElement.hasAttribute('data-autocomplete-initialized')) {
		        return;
		    }
		    
		    console.log('Initializing autocomplete for input');
		    
		    // ƒê√°nh d·∫•u ƒë√£ kh·ªüi t·∫°o
		    inputElement.setAttribute('data-autocomplete-initialized', 'true');
		    
		    // X√≥a readonly v√† disabled n·∫øu c√≥
		    inputElement.removeAttribute('readonly');
		    inputElement.removeAttribute('disabled');
		    
		    // Th√™m s·ª± ki·ªán
		    inputElement.addEventListener('input', function(e) {
		        const query = this.value;
		        if (query.length >= 2) {
		            searchInstructors(query, this);
		        }
		    });
		    
		    inputElement.addEventListener('focus', function(e) {
		        const query = this.value;
		        if (query.length >= 2) {
		            searchInstructorSuggestions(query, this);
		        }
		    });
		    
		    inputElement.addEventListener('blur', function(e) {
		        setTimeout(() => {
		            clearInstructorSuggestions(this);
		        }, 200);
		    });
		    
		    // Th√™m datalist n·∫øu ch∆∞a c√≥
		    if (!inputElement.nextElementSibling || inputElement.nextElementSibling.tagName !== 'DATALIST') {
		        const datalist = document.createElement('datalist');
		        datalist.id = 'instructor-suggestions-' + inputElement.getAttribute('data-id');
		        inputElement.setAttribute('list', datalist.id);
		        inputElement.parentNode.appendChild(datalist);
		    }
		}

		// ===== ENHANCED SEARCH INSTRUCTORS FUNCTION =====
		function searchInstructorSuggestions(query, targetInput) {
		    if (!query || query.length < 2) return;
		    
		    // Hi·ªÉn th·ªã loading
		    const datalist = targetInput.nextElementSibling;
		    if (datalist && datalist.tagName === 'DATALIST') {
		        datalist.innerHTML = '';
		    }
		    
		    // Gi·∫£ l·∫≠p d·ªØ li·ªáu gi·∫£ng vi√™n (trong th·ª±c t·∫ø s·∫Ω g·ªçi API)
		    const mockInstructors = [
		        { id: 1, full_name: 'Nguy·ªÖn VƒÉn A', code: 'GV001' },
		        { id: 2, full_name: 'Tr·∫ßn Th·ªã B', code: 'GV002' },
		        { id: 3, full_name: 'L√™ VƒÉn C', code: 'GV003' },
		        { id: 4, full_name: 'Ph·∫°m Th·ªã D', code: 'GV004' },
		        { id: 5, full_name: 'Ho√†ng VƒÉn E', code: 'GV005' }
		    ];
		    
		    // L·ªçc gi·∫£ng vi√™n theo query
		    const filtered = mockInstructors.filter(instructor => 
		        instructor.full_name.toLowerCase().includes(query.toLowerCase()) ||
		        instructor.code.toLowerCase().includes(query.toLowerCase())
		    );
		    
		    // Hi·ªÉn th·ªã suggestions
		    if (datalist) {
		        datalist.innerHTML = '';
		        filtered.forEach(instructor => {
		            const option = document.createElement('option');
		            option.value = instructor.full_name;
		            option.textContent = `${instructor.full_name} (${instructor.code})`;
		            datalist.appendChild(option);
		        });
		    }
		}

		// ===== UPDATE LOCAL DATA FUNCTION =====
		function updateLocalData(id, changes) {
		    // C·∫≠p nh·∫≠t d·ªØ li·ªáu c·ª•c b·ªô
		    const index = monHocData.findIndex(item => item.id == id);
		    if (index !== -1) {
		        Object.keys(changes).forEach(field => {
		            const newValue = changes[field].value;
		            
		            // Map field name t·ª´ data-field sang t√™n trong monHocData
		            const fieldMap = {
		                'instructor': 'giang_vien',
		                'department': 'don_vi',
		                'course': 'course_id'
		            };
		            
		            const dataField = fieldMap[field] || field;
		            monHocData[index][dataField] = newValue;
		        });
		        
		        console.log('Local data updated');
		    }
		}

		// ===== CLEAR INSTRUCTOR SUGGESTIONS =====
		function clearInstructorSuggestions(targetInput) {
		    const datalist = targetInput.nextElementSibling;
		    if (datalist && datalist.tagName === 'DATALIST') {
		        datalist.innerHTML = '';
		    }
		}

        // H√†m l·∫•y CSRF token
        function getCookie(name) {
            try {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            } catch (error) {
                console.error('Error getting cookie:', error);
                return null;
            }
        }
        
        // ===== INITIALIZATION =====
        // document.addEventListener('DOMContentLoaded', function() {
        //    console.log('DOM loaded, initializing application...');
        $(document).ready(function() {
            console.log('Document ready, initializing...');
            
            // ƒê·∫£m b·∫£o jQuery v√† Select2 ƒë√£ t·∫£i xong
            if (typeof $ === 'undefined' || typeof $.fn.select2 === 'undefined') {
                console.error('jQuery or Select2 not loaded');
                setTimeout(() => {
                    initApplication();
                }, 1000);
                return;
            }
            
            initApplication();
        });

        function initApplication() {
            // First, load initial data from template if available
            if (window.initialMonHocData && window.initialMonHocData.length > 0) {
                monHocData = window.initialMonHocData;
                console.log('Loaded initial data from template:', monHocData.length, 'items');
                renderTable();
                updateStatistics();
            }
            
            // Then load data asynchronously
            setTimeout(() => {
                loadInitialData()
                    .then((success) => {
                        if (success) {
                            // Initialize dropdowns (ch·ªâ dropdown ch√≠nh, kh√¥ng ph·∫£i trong b·∫£ng)
                            initializeMainDropdowns();
                            
                            // Setup dropdown events
                            setupDropdownEvents();
                            
                            // Setup other event listeners
                            setupEventListeners();
                            
                            console.log('‚úÖ Application initialized successfully');
                            
                            // Load filtered data if any filter is selected
                            const hasFilter = $('#khoa-dao-tao').val() || 
                                            $('#chuong-trinh-dao-tao').val() ||
                                            $('#to-bo-mon').val() || 
                                            $('#khoa-hoc').val();
                            
                            if (hasFilter) {
                                loadFilteredData();
                            }
                        } else {
                            console.warn('‚ö† Using sample data due to initialization errors');
                            showNotification('ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u', 'warning');
                            
                            // Initialize with sample data
                            const sampleData = getSampleData();
                            allDepartments = sampleData.departments;
                            allSubjectGroups = sampleData.subjectGroups;
                            allCurricula = sampleData.curricula;
                            allCourses = sampleData.courses;
                            
                            initializeMainDropdowns();
                            setupDropdownEvents();
                            setupEventListeners();
                        }
                    })
                    .catch((error) => {
                        console.error('‚ùå Initialization error:', error);
                        showNotification('L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng', 'error');
                    });
            }, 500);
        }

        // H√†m ri√™ng ƒë·ªÉ kh·ªüi t·∫°o dropdown ch√≠nh
        function initializeMainDropdowns() {
            console.log('Initializing main dropdowns...');
            
            const dropdowns = [
                { id: 'khoa-dao-tao', placeholder: '-- Ch·ªçn khoa --' },
                { id: 'to-bo-mon', placeholder: '-- Ch·ªçn t·ªï b·ªô m√¥n --' },
                { id: 'chuong-trinh-dao-tao', placeholder: '-- Ch·ªçn ch∆∞∆°ng tr√¨nh --' },
                { id: 'khoa-hoc', placeholder: '-- Ch·ªçn kh√≥a h·ªçc --' }
            ];
            
            dropdowns.forEach(dropdown => {
                const $select = $(`#${dropdown.id}`);
                if ($select.length) {
                    // Destroy existing Select2
                    if ($select.hasClass('select2-hidden-accessible')) {
                        $select.select2('destroy');
                    }
                    
                    // Initialize Select2
                    $select.select2({
                        width: '100%',
                        placeholder: dropdown.placeholder,
                        allowClear: true,
                        language: 'vi',
                        minimumResultsForSearch: 0
                    });
                }
            });
        }

        // Cleanup on page unload
        $(window).on('beforeunload', function() {
            // Cleanup Select2
            $('.select2-hidden-accessible').select2('destroy');
            
            // Clear timeouts
            if (instructorSearchTimeout) clearTimeout(instructorSearchTimeout);
            if (filterTimeout) clearTimeout(filterTimeout);
        });

        // ===== EVENT LISTENERS SETUP =====
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Update button
            $('#btn-cap-nhat').off('click').on('click', function() {
                loadFilteredData();
                showNotification('ƒê√£ c·∫≠p nh·∫≠t d·ªØ li·ªáu', 'success');
            });
            
            // Th√™m ch∆∞∆°ng tr√¨nh
            $('#btn-them').off('click').on('click', openThemChuongTrinhModal);
            
            // Th√™m m√¥n h·ªçc
            $('#btn-them-mon-hoc').off('click').on('click', openThemMonHocModal);
            
            // Import Excel
            $('#btn-import').off('click').on('click', openImportModal);
            
            // Close modals
            $('#btn-dong-chuong-trinh, #btn-huy-chuong-trinh').off('click').on('click', closeThemChuongTrinhModal);
            $('#btn-dong-mon-hoc, #btn-huy-mon-hoc').off('click').on('click', closeThemMonHocModal);
            $('#btn-dong-import, #btn-huy-import').off('click').on('click', closeImportModal);
            
            // Edit/Save buttons in table
            $(document).off('click', '.btn-sua').on('click', '.btn-sua', function(e) {
                e.stopPropagation();
                const button = this;
                const row = button.closest('tr');
                const id = button.getAttribute('data-id');
                const isEditButton = button.innerHTML.includes('fa-edit');
                
                if (isEditButton) {
                    enterEditMode(row, button);
                } else {
                    exitEditMode(row, button, id);
                }
            });
            
            // Delete buttons in table
            $(document).off('click', '.btn-xoa').on('click', '.btn-xoa', function(e) {
                e.stopPropagation();
                const id = $(this).data('id');
                if (id && confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m√¥n h·ªçc n√†y?')) {
                    deleteMonHoc(id);
                }
            });

            // Event cho n√∫t "Ch·ªçn" m√¥n h·ªçc c√≥ s·∫µn
            $('#btn-use-existing').off('click').on('click', handleUseExistingSubject);
            
            // Event cho n√∫t x√≥a l·ª±a ch·ªçn m√¥n h·ªçc
            $('#btn-clear-selection').off('click').on('click', clearSubjectSelection);
            
            // Event cho vi·ªác ch·ªçn m√¥n h·ªçc t·ª´ dropdown
            $('#select-existing-subject').off('change').on('change', function() {
                const selectedId = $(this).val();
                if (selectedId) {
                    const selectedOption = $(this).find('option:selected');
                    const subjectData = selectedOption.data('subject');
                    if (subjectData) {
                        fillSubjectFormFromExisting(subjectData);
                    }
                }
            });
            
            // Event cho n√∫t l∆∞u m√¥n h·ªçc
            $('#btn-luu-mon-hoc').off('click').on('click', createMonHoc);
            
            // Event cho n√∫t l∆∞u ch∆∞∆°ng tr√¨nh
            $('#btn-luu-chuong-trinh').off('click').on('click', createCurriculum);
            
            // Event cho n√∫t import Excel
            $('#btn-luu-import').off('click').on('click', importExcel);
            
            // Event cho file input Excel ƒë·ªÉ l·∫•y sheet names
            $('#excel-file').off('change').on('change', function() {
                const file = this.files[0];
                if (file) {
                    getSheetNamesFromFile(file)
                        .then(sheetNames => {
                            const sheetSelect = $('#sheet-select');
                            sheetSelect.empty();
                            sheetSelect.append('<option value="">-- T·ª± ƒë·ªông ch·ªçn sheet ƒë·∫ßu ti√™n --</option>');
                            sheetNames.forEach(sheetName => {
                                sheetSelect.append(`<option value="${sheetName}">${sheetName}</option>`);
                            });
                        })
                        .catch(error => {
                            console.error('Error getting sheet names:', error);
                        });
                }
            });
            
            // ESC to close modals
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeThemChuongTrinhModal();
                    closeThemMonHocModal();
                    closeImportModal();
                    $('body').removeClass('overflow-hidden');
                }
            });
        }

        // ===== SHOW NOTIFICATION FUNCTION =====
		function showNotification(message, type = 'info', duration = 3000) {
		    const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-3 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, duration);
		}

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            // Destroy all Select2 instances
            $('.select2-hidden-accessible').select2('destroy');
            
            // Clear timeouts
            if (instructorSearchTimeout) clearTimeout(instructorSearchTimeout);
            if (filterTimeout) clearTimeout(filterTimeout);
            
            // Clear cache
            clearCache();
        });
    </script>
	
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Chương trình Đào tạo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== MODAL FIXES ===== */
        /* Modal cơ bản */
        .fixed.inset-0 {
            display: none;
            z-index: 50;
        }

        .fixed.inset-0:not(.hidden) {
            display: flex;
        }

        /* Modal thêm môn học - FIXED */
        #modal-them-mon-hoc {
            display: none !important;
            z-index: 1050 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
            align-items: center !important;
            justify-content: center !important;
        }

        #modal-them-mon-hoc.hidden {
            display: none !important;
        }

        #modal-them-mon-hoc:not(.hidden) {
            display: flex !important;
        }

        #modal-them-mon-hoc > div {
            z-index: 1051 !important;
            position: relative;
            max-height: 90vh !important;
            overflow-y: auto !important;
            background-color: white !important;
            border-radius: 0.5rem !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            width: 95% !important;
            max-width: 1200px !important;
        }

        /* Modal backdrop */
        .modal-backdrop {
            z-index: 1040 !important;
        }

        /* ===== SELECT2 FIXES ===== */
        /* Select2 trong modal */
        .modal .select2-container {
            z-index: 1060 !important;
        }

        .modal .select2-container--open {
            z-index: 1070 !important;
        }

        .modal .select2-dropdown {
            z-index: 1080 !important;
            position: fixed !important;
            top: auto !important;
            left: auto !important;
            width: auto !important;
            min-width: 300px !important;
            background-color: white !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }

        /* Ẩn Select2 bên ngoài khi modal mở */
        body.modal-open .select2-container:not(.modal .select2-container) {
            z-index: -1 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        body.modal-open .select2-dropdown:not(.modal .select2-dropdown) {
            display: none !important;
        }

        /* Select2 cơ bản */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
        }

        .select2-container--default .select2-selection--multiple {
            height: auto !important;
            padding: 0.5rem 0.75rem !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #3b82f6 !important;
            color: white !important;
            border: none !important;
            border-radius: 0.25rem !important;
        }

        .select2-dropdown {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ===== INPUT & FORM STYLES ===== */
        /* Input trong modal */
        #modal-them-mon-hoc input:not([type="checkbox"]),
        #modal-them-mon-hoc select,
        #modal-them-mon-hoc textarea {
            background-color: white !important;
            color: #000 !important;
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            padding: 0.75rem !important;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            pointer-events: auto !important;
            user-select: auto !important;
            cursor: text !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        #modal-them-mon-hoc input:focus,
        #modal-them-mon-hoc select:focus,
        #modal-them-mon-hoc textarea:focus {
            outline: 2px solid #3b82f6 !important;
            outline-offset: 2px !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        /* Select trong modal - đảm bảo hiển thị mũi tên */
        #modal-them-mon-hoc select {
            appearance: auto !important;
            -webkit-appearance: auto !important;
            -moz-appearance: auto !important;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
            background-position: right 0.5rem center !important;
            background-repeat: no-repeat !important;
            background-size: 1.5em 1.5em !important;
            padding-right: 2.5rem !important;
        }

        /* ===== TABLE STYLES ===== */
        .table-container {
            max-height: 500px;
            overflow-y: auto;
            position: relative;
        }

        /* Đảm bảo nội dung trong ô không bị tràn */
        table td, table th {
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle;
        }

        .wrap-cell {
            white-space: normal;
            word-wrap: break-word;
        }

        /* Độ rộng cột cụ thể */
        .col-tt { width: 48px; min-width: 48px; }
        .col-ma { width: 100px; min-width: 100px; }
        .col-ten { width: 220px; min-width: 220px; }
        .col-tinchi { width: 64px; min-width: 64px; }
        .col-gio { width: 80px; min-width: 80px; }
        .col-lythuyet { width: 64px; min-width: 64px; }
        .col-thuchanh { width: 64px; min-width: 64px; }
        .col-kiemtra { width: 50px; min-width: 50px; }
        .col-thi { width: 40px; min-width: 40px; }
        .col-hk { width: 48px; min-width: 48px; }
        .col-donvi { width: 180px; min-width: 180px; }
        .col-giangvien { width: 200px; min-width: 200px; }
        .col-course { width: 150px; min-width: 150px; }
        .col-thaotac { width: 80px; min-width: 80px; }

        /* Table header sticky */
        .bg-gray-50.sticky {
            z-index: 20;
            position: sticky;
            top: 0;
        }

        /* ===== EDITABLE CELL STYLES ===== */
        .editable:focus {
            outline: 2px solid #3b82f6;
            background-color: #f0f9ff;
            border-radius: 0.25rem;
        }

        .editable.select {
            background-color: transparent;
            border: none;
            width: 100%;
            padding: 2px 4px;
            font-size: 0.875rem;
            cursor: pointer;
        }

        .editable.select:focus {
            outline: 2px solid #3b82f6;
            background-color: white;
            border-radius: 4px;
        }

        /* ===== BUTTON STYLES ===== */
        button:not(:disabled) {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button colors */
        .bg-blue-600 { background-color: #2563eb; }
        .bg-blue-600:hover { background-color: #1d4ed8; }

        .bg-green-600 { background-color: #059669; }
        .bg-green-600:hover { background-color: #047857; }

        .bg-gray-600 { background-color: #4b5563; }
        .bg-gray-600:hover { background-color: #374151; }

        .bg-purple-600 { background-color: #7c3aed; }
        .bg-purple-600:hover { background-color: #6d28d9; }

        /* ===== AUTOCOMPLETE STYLES ===== */
        .instructor-autocomplete {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            top: 100%;
            left: 0;
        }

        .autocomplete-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }

        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }

        .autocomplete-suggestion:last-child {
            border-bottom: none;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal > div {
            animation: modalSlideIn 0.3s ease-out;
        }

        .select2-dropdown {
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .fa-spinner.fa-spin {
            animation: spin 1s linear infinite;
        }

        /* ===== UTILITY CLASSES ===== */
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Loading states */
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Success/Error states */
        .success-badge {
            background-color: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .error-badge {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .modal > div {
                width: 95% !important;
                margin: 1rem auto !important;
                padding: 1rem !important;
            }
            
            .modal .select2-dropdown {
                position: fixed !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 90% !important;
                max-width: 300px !important;
            }
            
            .table-container {
                max-height: 400px;
            }
            
            /* Stack grid columns on mobile */
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem;
            }
            
            /* Adjust font sizes */
            h1 {
                font-size: 1.5rem !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
            
            /* Button spacing */
            .flex.space-x-2 {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .flex.space-x-2 > button {
                width: 100%;
            }
            
            /* Table adjustments */
            table {
                font-size: 0.875rem;
            }
            
            .col-ten, .col-donvi, .col-giangvien, .col-course {
                min-width: 150px !important;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .modal > div {
                width: 100% !important;
                margin: 0.5rem !important;
                padding: 0.75rem !important;
            }
            
            /* Hide some less important columns on very small screens */
            .col-lythuyet, .col-thuchanh, .col-kiemtra .col-thi {
                display: none;
            }
            
            .text-3xl {
                font-size: 1.25rem !important;
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .modal,
            .select2-dropdown,
            button:not(.print-button),
            .no-print {
                display: none !important;
            }
            
            .table-container {
                max-height: none;
                overflow: visible;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #000;
                padding: 0.5rem;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        /* Focus styles for keyboard navigation */
        :focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        /* Screen reader only text */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .bg-blue-600 { background-color: #0000ff; }
            .bg-green-600 { background-color: #008000; }
            .bg-gray-600 { background-color: #000000; }
            .bg-purple-600 { background-color: #800080; }
            
            .border {
                border-width: 2px !important;
            }
        }

        /* ===== DARK MODE SUPPORT ===== */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111827;
                color: #f9fafb;
            }
            
            .bg-white {
                background-color: #1f2937 !important;
            }
            
            .bg-gray-100 {
                background-color: #111827 !important;
            }
            
            .bg-gray-50 {
                background-color: #374151 !important;
            }
            
            .text-gray-700 {
                color: #d1d5db !important;
            }
            
            .text-gray-900 {
                color: #f9fafb !important;
            }
            
            .border-gray-300 {
                border-color: #4b5563 !important;
            }
            
            /* Modal trong dark mode */
            .modal > .bg-white {
                background-color: #1f2937 !important;
            }
            
            /* Table trong dark mode */
            table {
                color: #f9fafb;
            }
            
            thead.bg-gray-50 {
                background-color: #374151 !important;
            }
            
            /* Input trong dark mode */
            input, select, textarea {
                background-color: #374151 !important;
                color: #f9fafb !important;
                border-color: #4b5563 !important;
            }
            
            /* Select2 trong dark mode */
            .select2-container--default .select2-selection--single,
            .select2-container--default .select2-selection--multiple {
                background-color: #374151 !important;
                border-color: #4b5563 !important;
            }
            
            .select2-dropdown {
                background-color: #1f2937 !important;
                border-color: #4b5563 !important;
            }
            
            .select2-results__option {
                color: #f9fafb;
            }
            
            .select2-search__field {
                background-color: #374151 !important;
                color: #f9fafb !important;
            }
        }

        /* ===== FIX FOR SPECIFIC ELEMENTS ===== */
        /* Đảm bảo các nút trong modal có thể click */
        #modal-them-mon-hoc button,
        #modal-them-chuong-trinh button {
            pointer-events: auto !important;
            cursor: pointer !important;
        }

        /* Đảm bảo modal không bị ảnh hưởng bởi các style khác */
        #modal-them-mon-hoc,
        #modal-them-chuong-trinh {
            pointer-events: auto !important;
        }

        #modal-them-mon-hoc *,
        #modal-them-chuong-trinh * {
            pointer-events: auto !important;
        }

        /* Fix cho chiều cao modal content */
        #modal-them-mon-hoc .bg-white {
            max-height: 90vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }

        /* Đảm bảo body không scroll khi modal mở */
        body.modal-open {
            overflow: hidden !important;
            position: fixed;
            width: 100%;
        }

        /* Fix cho placeholder trong input */
        ::placeholder {
            color: #9ca3af;
            opacity: 1;
        }

        /* ===== CUSTOM SCROLLBAR FOR MODAL ===== */
        #modal-them-mon-hoc .bg-white::-webkit-scrollbar {
            width: 6px;
        }

        #modal-them-mon-hoc .bg-white::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #modal-them-mon-hoc .bg-white::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #modal-them-mon-hoc .bg-white::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        /* ===== TOOLTIP STYLES ===== */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #374151;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* ===== VALIDATION STYLES ===== */
        .valid-input {
            border-color: #10b981 !important;
        }

        .invalid-input {
            border-color: #ef4444 !important;
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .validation-message.error {
            color: #ef4444;
        }

        .validation-message.success {
            color: #10b981;
        }

        /* ===== FINAL TOUCHES ===== */
        /* Smooth transitions */
        .modal,
        .modal > div,
        .select2-container,
        .select2-dropdown {
            transition: all 0.3s ease;
        }

		/* Thêm style cho Select2 */
        .select2-container {
            z-index: 9999 !important;
        }
        
        .select2-container--open {
            z-index: 10000 !important;
        }
        
        .select2-dropdown {
            z-index: 10001 !important;
        }
        
        /* Đảm bảo modal có z-index cao */
        .fixed.inset-0 {
            z-index: 9998 !important;
        }

        /* Improve text readability */
        p, label, span, div {
            line-height: 1.6;
        }

        /* Better spacing for form elements */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }

        /* Card-like elements */
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-active {
            background-color: #10b981;
        }

        .status-inactive {
            background-color: #ef4444;
        }

        .status-draft {
            background-color: #f59e0b;
        }

        /* ===== PERFORMANCE OPTIMIZATIONS ===== */
        /* Hardware acceleration for smooth animations */
        .modal > div,
        .select2-dropdown {
            transform: translateZ(0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            .modal > div,
            .select2-dropdown,
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    {% csrf_token %}
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-800">QUẢN LÝ CHƯƠNG TRÌNH ĐÀO TẠO</h1>
        
        <!-- Thông tin chung -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khoa</label>
                    <select id="khoa-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn khoa --</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Tổ bộ môn</label>
                    <select id="to-bo-mon" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn tổ bộ môn --</option>
                        {% for group in subject_groups %}
                        <option value="{{ group.id }}" data-department="{{ group.department_id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Chương trình đào tạo</label>
                    <select id="chuong-trinh-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn chương trình --</option>
                        {% for curriculum in curricula %}
                        <option value="{{ curriculum.id }}">{{ curriculum.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khóa học</label>
                    <select id="khoa-hoc" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn khóa học --</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}" data-curriculum="{{ course.curriculum_id }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Nút chức năng -->
		<div class="flex flex-wrap justify-between mb-6">
			<div class="flex space-x-2 mb-4">
    			<button id="btn-them" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-plus mr-2"></i> Thêm chương trình đào tạo
    			</button>
    			<button id="btn-them-mon-hoc" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-book-medical mr-2"></i> Thêm môn học
    			</button>
    			<button id="btn-cap-nhat" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-sync-alt mr-2"></i> Cập nhật
    			</button>
			</div>
    
			<div>
    			<button id="btn-import" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-file-excel mr-2"></i> Import Excel
    			</button>
			</div>
		</div>

        <!-- Modal import Excel -->
        <div id="modal-import" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Import từ Excel</h3>
                    <button id="btn-dong-import" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="form-import" class="space-y-4" enctype="multipart/form-data">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                        <select id="import-curriculum" name="curriculum_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn chương trình --</option>
                            {% for curriculum in curricula %}
                            <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Khóa học *</label>
                        <select id="import-course" name="course_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn khóa học --</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.name }} ({{ course.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">File Excel *</label>
                        <input type="file" id="excel-file" name="excel_file" accept=".xlsx, .xls" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            required>
                        <p class="text-xs text-gray-500 mt-1">Chỉ chấp nhận file .xlsx hoặc .xls, tối đa 10MB</p>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Chọn sheet</label>
                        <select id="sheet-select" name="sheet_name" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Tự động chọn sheet đầu tiên --</option>
                            <!-- Các option sẽ được thêm bằng JavaScript -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Chọn sheet chứa dữ liệu môn học. Nếu không chọn, sheet đầu tiên sẽ được sử dụng.</p>
                    </div>
                    
                    <div class="text-sm text-gray-600">
                        <p>
                            <a href="#" id="btn-download-template" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                                <i class="fas fa-download mr-2"></i>Tải file mẫu
                            </a>
                        </p>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                        <h4 class="text-sm font-semibold text-yellow-800 mb-2">Lưu ý khi import:</h4>
                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                            <li>File Excel phải theo đúng định dạng mẫu</li>
                            <li>Các cột bắt buộc: Mã môn học, Tên học phần, Số tín chỉ</li>
                            <li>Mã môn học không được trùng trong cùng chương trình</li>
                        </ul>
                    </div>
                </form>
                
                <div class="flex justify-end mt-6 space-x-3">
                    <button id="btn-huy-import" type="button" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-times mr-2"></i>Hủy
                    </button>
                    <button id="btn-luu-import" type="button" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-upload mr-2"></i>Import Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal hiển thị lỗi import -->
        <div id="modal-import-errors" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Chi tiết lỗi khi import</h3>
                    <button id="btn-dong-errors" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="import-errors-content" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded border">
                    <!-- Nội dung lỗi sẽ được điền ở đây -->
                </div>
                <div class="flex justify-end">
                    <button id="btn-close-errors" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-check mr-2"></i>Đóng
                    </button>
                </div>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50 sticky top-0" style="z-index: 10;">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">TT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Mã môn học</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Tên học phần</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Số tín chỉ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Tổng số giờ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Lý thuyết</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Thực hành</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Kiểm tra</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Thi</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK2</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider wg-12">HK3</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider wg-12">HK4</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK5</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK6</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-60">Đơn vị</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Giảng viên</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Khóa học</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Thông tin tổng kết -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-gray-600">Tổng số tín chỉ</p>
                    <p id="tong-tin-chi" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tổng số giờ</p>
                    <p id="tong-gio" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tỷ lệ lý thuyết</p>
                    <p id="ty-le-ly-thuyet" class="text-xl font-bold text-blue-700">0%</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tỷ lệ thực hành</p>
                    <p id="ty-le-thuc-hanh" class="text-xl font-bold text-blue-700">0%</p>
                </div>
            </div>
        </div>

        <!-- Quản lý lớp học và phân công giảng dạy -->
        <div class="mt-6 text-center">
            <a href="{% url 'teaching_management' %}" 
            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-6 rounded-md inline-flex items-center text-lg">
                <i class="fas fa-chalkboard-teacher mr-3"></i> 
                Quản lý Phân công Giảng dạy
            </a>
        </div>

    </div>

    <!-- Modal thêm chương trình đào tạo -->
	<div id="modal-them-chuong-trinh" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm chương trình đào tạo mới</h3>
                <button type="button" id="btn-dong-chuong-trinh" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-chuong-trinh" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã chương trình *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: CNTT_2022"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên chương trình *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: Chương trình Tin học ứng dụng"
                            required
                            autocomplete="off">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Năm học áp dụng *</label>
                        <input type="text" name="academic_year" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: 2022 - 2025"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngành đào tạo *</label>
                        <select name="major_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                required>
                            <option value="">-- Chọn ngành --</option>
                            {% for major in majors %}
                            <option value="{{ major.id }}">{{ major.name }} ({{ major.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="3"
                            placeholder="Nhập mô tả về chương trình đào tạo..."
                            autocomplete="off"></textarea>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-md">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Thông tin bổ sung:</h4>
                    <p class="text-sm text-blue-700">
                        • Chương trình sẽ được tạo với trạng thái "Bản nháp"<br>
                        • Bạn có thể import môn học sau khi tạo chương trình
                    </p>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-chuong-trinh" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-chuong-trinh" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-save mr-2"></i>Lưu chương trình
                </button>
            </div>
        </div>
    </div>

    <!-- Modal thêm môn học -->
    <div id="modal-them-mon-hoc" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white" style="z-index: 1001;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm môn học mới</h3>
                <button type="button" id="btn-dong-mon-hoc" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="bg-blue-50 p-4 rounded-md mb-4">
                <h4 class="text-sm font-semibold text-blue-800 mb-2">Chọn từ môn học có sẵn</h4>
                <div class="flex space-x-2 mb-2">
                    <select id="select-existing-subject" class="flex-1">
                        <option value="">-- Tìm kiếm môn học có sẵn --</option>
                        <!-- Options sẽ được điền bằng JavaScript -->
                    </select>
                    <button type="button" id="btn-use-existing" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md whitespace-nowrap">
                        <i class="fas fa-check mr-1"></i> Chọn
                    </button>
                </div>
                <p class="text-xs text-blue-600">Chọn môn học từ danh sách có sẵn để tự động điền thông tin</p>
            </div>

            <!-- Thêm phần hiển thị thông tin môn học đã chọn -->
            <div id="existing-subject-info" class="bg-green-50 p-3 rounded-md border border-green-200 hidden mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-sm font-semibold text-green-800">Đã chọn môn học có sẵn</h4>
                        <p class="text-sm text-green-700" id="selected-subject-name"></p>
                    </div>
                    <button type="button" id="btn-clear-selection" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <form id="form-them-mon-hoc" class="space-y-4">
                <!-- Thông tin chương trình -->
                <div class="bg-blue-50 p-4 rounded-md">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Thông tin chương trình đào tạo</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                            <select id="them-mon-hoc-curriculum" name="curriculum_id" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    required>
                                <option value="">-- Chọn chương trình --</option>
                                {% for curriculum in curricula %}
                                <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Khóa học *</label>
                            <select id="them-mon-hoc-course" name="course_id" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    required>
                                <option value="">-- Chọn khóa học --</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.name }} ({{ course.code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Ngành đào tạo</label>
                            <select id="them-mon-hoc-major" name="major_id"
                            		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        		<option value="">-- Chọn ngành --</option>
                                {% for major in majors %}
                                <option value="{{ major.id }}">{{ major.name }} ({{ major.code }})</option>
                                {% endfor %}
							</select>
                        </div>
                    </div>
                </div>

                <!-- Thông tin cơ bản môn học -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã môn học *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: MH01"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên môn học *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: Giáo dục chính trị"
                            required
                            autocomplete="off">
                    </div>
                </div>

                <!-- Số tín chỉ và giờ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Số tín chỉ *</label>
                        <input type="number" name="credits" step="0.5" min="0" max="10"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tổng số giờ</label>
                        <input type="number" name="total_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Lý thuyết</label>
                        <input type="number" name="theory_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thực hành</label>
                        <input type="number" name="practice_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Kiểm tra</label>
                        <input type="number" name="tests_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thi</label>
                        <input type="number" name="exam_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thứ tự</label>
                        <input type="number" name="order_number" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                </div>

                <!-- Phân bố học kỳ -->
                <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-3">Phân bố học kỳ (số tín chỉ)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        {% for i in "123456" %}
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Học kỳ {{ i }}</label>
                            <input type="number" name="hk{{ i }}" step="0.5" min="0" max="10"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center" 
                                placeholder="-"
                                autocomplete="off">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Thông tin bổ sung -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Đơn vị quản lý</label>
                        <select id="them-mon-hoc-department" name="department_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn đơn vị --</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Loại môn *</label>
                        <select id="them-mon-hoc-subject-type" name="subject_type_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                required>
                            <option value="">-- Chọn loại môn --</option>
                            {% for subject_type in subject_types %}
                            <option value="{{ subject_type.id }}">{{ subject_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tổ bộ môn</label>
                        <select id="them-mon-hoc-subject-group" name="subject_group_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn tổ bộ môn --</option>
                            {% for subject_group in subject_groups %}
                            <option value="{{ subject_group.id }}" data-department="{{ subject_group.department_id }}">{{ subject_group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Học kỳ mặc định</label>
                        <select id="them-mon-hoc-semester" name="semester" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn học kỳ --</option>
                            {% for i in "123456" %}
                            <option value="{{ i }}">Học kỳ {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả môn học</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="3"
                            placeholder="Nhập mô tả về môn học..."
                            autocomplete="off"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Điều kiện tiên quyết</label>
                    <textarea name="prerequisites" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="2"
                            placeholder="Nhập điều kiện tiên quyết (nếu có)..."
                            autocomplete="off"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chuẩn đầu ra</label>
                    <textarea name="learning_outcomes" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="2"
                            placeholder="Nhập chuẩn đầu ra của môn học..."
                            autocomplete="off"></textarea>
                </div>

                <!-- Thông tin môn tự chọn -->
                <div class="bg-green-50 p-4 rounded-md border border-green-200">
                    <h4 class="text-sm font-semibold text-green-800 mb-3">Thông tin môn tự chọn (nếu có)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" name="is_elective" id="is_elective" 
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="is_elective" class="ml-2 block text-sm text-gray-700 font-medium">
                                Là môn tự chọn
                            </label>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Nhóm môn tự chọn</label>
                            <input type="text" name="elective_group" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="Vd: Nhóm 1"
                                autocomplete="off">
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-mon-hoc" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-mon-hoc" 
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-save mr-2"></i>Lưu môn học
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/vi.js"></script>
    <script>
		window.addEventListener('error', function(e) {
		    console.error('Global error caught:', e.message);
		    console.error('Error at:', e.filename, 'line:', e.lineno, 'col:', e.colno);
		    console.error('Error stack:', e.error?.stack);
		    return false;
		});
		
		// Bắt lỗi unhandled promise rejections
		window.addEventListener('unhandledrejection', function(e) {
		    console.error('Unhandled promise rejection:', e.reason);
		    console.error('Promise:', e.promise);
		    return false;
		});
		
        // Biến toàn cục lưu trữ dữ liệu
        let allDepartments = {{ departments|safe }};
        let allSubjectGroups = {{ subject_groups|safe }};
        let allCurricula = {{ curricula|safe }};
        let allCourses = {{ courses|safe }};
        let allSubjectTypes = {{ subject_types|safe }};
        let allMajors = {{ majors|safe }};
		let allSubjects = [];
		let isSubjectsLoaded = false;
		let monHocData = [];

        // Khởi tạo monHocData từ dữ liệu Django template
		try {
		    // Lấy dữ liệu từ Django template
		    let rawData = '{{ mon_hoc_data|escapejs|safe }}';
		    
		    console.log('Raw data length:', rawData.length);
		    console.log('Raw data sample:', rawData.substring(0, 100));
		    
		    if (rawData && rawData.trim() !== '' && rawData !== '[]' && rawData !== '{{ mon_hoc_data|escapejs|safe }}') {
		        // Thay thế các ký tự đặc biệt
		        rawData = rawData.replace(/&quot;/g, '"')
		                         .replace(/&#39;/g, "'")
		                         .replace(/&amp;/g, '&')
		                         .replace(/&lt;/g, '<')
		                         .replace(/&gt;/g, '>')
		                         .replace(/&nbsp;/g, ' ')
		                         .replace(/\\/g, '\\\\');
		        
		        console.log('After replace:', rawData.substring(0, 100));
		        
		        // Parse JSON
		        monHocData = JSON.parse(rawData);
		        console.log('Successfully parsed monHocData. Items:', monHocData.length);
		    } else {
		        console.log('No mon_hoc_data provided or empty');
		        monHocData = [];
		    }
		} catch (e) {
		    console.error('Error parsing monHocData:', e);
		    console.error('Error details:', e.message);
		    monHocData = [];
		}
		
		console.log('MonHocData loaded with', monHocData.length, 'items');
		
		// Hàm fetch an toàn với xử lý lỗi
		async function safeFetch(url, options = {}) {
			const timeout = 5000; // 5 seconds
		    
		    const controller = new AbortController();
		    const timeoutId = setTimeout(() => controller.abort(), timeout);

		    try {
		        const response = await fetch(url, {
		            ...options,
		            signal: controller.signal
		        });
		        
		        clearTimeout(timeoutId);

				if (!response.ok) {
		            // Không throw error, chỉ trả về object lỗi
		            return {
		                success: false,
		                data: [],
		                message: `HTTP ${response.status}: ${response.statusText}`
		            };
		        }

		        try {
		            const data = await response.json();
		            return {
		                success: true,
		                data: data,
		                message: 'Success'
		            };
		        } catch (jsonError) {
		            console.error('JSON parse error:', jsonError);
		            return {
		                success: false,
		                data: [],
		                message: 'Invalid JSON response'
		            };
		        }
		    } catch (error) {
				clearTimeout(timeoutId);
				if (error.name === 'AbortError') {
		            console.error(`Fetch timeout for ${url}`);
		            return { 
		                success: false, 
		                data: [], 
		                message: 'Request timeout (server is slow)' 
		            };
		        }
		        console.error(`Fetch error for ${url}:`, error);
		        return { success: false, data: [], message: error.message || 'Network error' };
		    }
		}

        // Khởi tạo Select2 cho tất cả dropdown
        function initializeSelect2() {
            setTimeout(() => {
				try {
	                // Các dropdown chính trên trang
	                if ($('#khoa-dao-tao').length) {
                		$('#khoa-dao-tao').select2({
		                    width: '100%',
		                    placeholder: '-- Chọn khoa --',
		                    allowClear: true,
		                    language: 'vi'
						});
	                }
					if ($('#to-bo-mon').length) {
                		$('#to-bo-mon').select2({
		                    width: '100%',
		                    placeholder: '-- Chọn tổ bộ môn --',
		                    allowClear: true,
		                    language: 'vi'
						});
	                }
					if ($('#chuong-trinh-dao-tao').length) {
                		$('#chuong-trinh-dao-tao').select2({
		                    width: '100%',
		                    placeholder: '-- Chọn chương trình --',
		                    allowClear: true,
		                    language: 'vi'
						});
	                }
					if ($('#khoa-hoc').length) {
                		$('#khoa-hoc').select2({
		                    width: '100%',
		                    placeholder: '-- Chọn khóa học --',
		                    allowClear: true,
		                    language: 'vi'
						});
	                }
	                
	                // Dropdown trong modal import
	                $('#import-curriculum, #import-course').select2({
	                    width: '100%',
	                    placeholder: '-- Chọn --',
	                    allowClear: true,
	                    language: 'vi',
	                    dropdownParent: $('#modal-import')
	                });
	                
	                // Dropdown sheet select
	                $('#sheet-select').select2({
	                    width: '100%',
	                    placeholder: '-- Tự động chọn sheet đầu tiên --',
	                    allowClear: true,
	                    language: 'vi',
	                    dropdownParent: $('#modal-import')
	                });
	                
	                // Dropdown trong modal thêm chương trình
	                if (!$('select[name="major_id"]').hasClass('select2-hidden-accessible')) {
	                    $('select[name="major_id"]').select2({
	                        width: '100%',
	                        placeholder: '-- Chọn ngành --',
	                        allowClear: true,
	                        language: 'vi',
	                        dropdownParent: $('#modal-them-chuong-trinh')
	                    });
	                }
	                console.log('Select2 initialized successfully');
	
	                // Tự động focus vào ô tìm kiếm khi mở dropdown
	                $(document).on('select2:open', function(e) {
	                    setTimeout(function() {
	                        const searchInput = document.querySelector('.select2-search__field');
	                        if (searchInput) {
	                            searchInput.focus();
	                        }
	                    }, 100);
	                });
	            } catch (error) {
	                console.error('Error initializing Select2:', error);
	            }
			}, 500);
        }

        // Khởi tạo Select2 cho modal thêm môn học
        function initializeSelect2ForSubjectModal() {
            console.log('Initializing Select2 for subject modal...');
            
            try {
				const modalElement = document.getElementById('modal-them-mon-hoc');
        		if (!modalElement) return;
				
                const modal = $('#modal-them-mon-hoc');
				
				// Khởi tạo Select2 cho các dropdown trong modal
		        $('#select-existing-subject').select2({
		            placeholder: '-- Tìm kiếm môn học có sẵn --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		        
		        $('#them-mon-hoc-curriculum').select2({
		            placeholder: '-- Chọn chương trình --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		        
		        $('#them-mon-hoc-course').select2({
		            placeholder: '-- Chọn khóa học --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });

				$('#them-mon-hoc-major').select2({
		            placeholder: '-- Chọn ngành --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		        
		        $('select[name="department_id"]').select2({
		            placeholder: '-- Chọn đơn vị --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		        
		        $('select[name="subject_type_id"]').select2({
		            placeholder: '-- Chọn loại môn --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		        
		        $('select[name="subject_group_id"]').select2({
		            placeholder: '-- Chọn tổ bộ môn --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		        
		        $('select[name="semester"]').select2({
		            placeholder: '-- Chọn học kỳ --',
		            allowClear: true,
		            width: '100%',
		            dropdownParent: modal
		        });
		
		        console.log('Select2 initialized for subject modal');
            } catch (error) {
                console.error('Error initializing Select2 for subject modal:', error);
            }
        }

        // Khởi tạo Select2 cho modal thêm chương trình
        function initializeSelect2ForCurriculumModal() {
            console.log('Initializing Select2 for curriculum modal...');
            
            try {
                const modal = $('#modal-them-chuong-trinh');
                
                $('select[name="major_id"]').select2({
                    width: '100%',
                    placeholder: '-- Chọn ngành --',
                    allowClear: true,
                    language: 'vi',
                    dropdownParent: modal,
                    //dropdownCssClass: 'modal-select2'
                });

                console.log('Select2 initialized for curriculum modal');
                
            } catch (error) {
                console.error('Error initializing Select2 for curriculum modal:', error);
            }
        }

        // Hàm cập nhật thông tin môn học khi chọn từ danh sách có sẵn
        function fillSubjectFormFromExisting(subject) {
            if (!subject) return;
            
            const form = document.getElementById('form-them-mon-hoc');
            if (!form) return;
            
            // Điền thông tin cơ bản
            form.querySelector('input[name="code"]').value = subject.code || '';
            form.querySelector('input[name="code"]').readOnly = true;
            form.querySelector('input[name="name"]').value = subject.name || '';
            form.querySelector('input[name="name"]').readOnly = true;
            form.querySelector('input[name="credits"]').value = subject.credits || '';
            form.querySelector('input[name="total_hours"]').value = subject.total_hours || '';
            form.querySelector('input[name="theory_hours"]').value = subject.theory_hours || '';
            form.querySelector('input[name="practice_hours"]').value = subject.practice_hours || '';
            form.querySelector('input[name="tests_hours"]').value = subject.tests_hours || '';
            form.querySelector('input[name="exam_hours"]').value = subject.exam_hours || '';
            form.querySelector('input[name="order_number"]').value = subject.order_number || '';
            
            // Điền các trường select
            if (subject.department_id) {
                form.querySelector('select[name="department_id"]').value = subject.department_id;
                $(form.querySelector('select[name="department_id"]')).trigger('change');
            }
            
            if (subject.subject_type_id) {
                form.querySelector('select[name="subject_type_id"]').value = subject.subject_type_id;
                $(form.querySelector('select[name="subject_type_id"]')).trigger('change');
            }
            
            if (subject.subject_group_id) {
                form.querySelector('select[name="subject_group_id"]').value = subject.subject_group_id;
                $(form.querySelector('select[name="subject_group_id"]')).trigger('change');
            }
            
            if (subject.semester) {
                form.querySelector('select[name="semester"]').value = subject.semester;
                $(form.querySelector('select[name="semester"]')).trigger('change');
            }
            
            // Điền textarea
            form.querySelector('textarea[name="description"]').value = subject.description || '';
            form.querySelector('textarea[name="prerequisites"]').value = subject.prerequisites || '';
            form.querySelector('textarea[name="learning_outcomes"]').value = subject.learning_outcomes || '';
            
            // Điền checkbox
            const isElectiveCheckbox = form.querySelector('input[name="is_elective"]');
            if (isElectiveCheckbox) {
                isElectiveCheckbox.checked = subject.is_elective || false;
            }
            
            const electiveGroupInput = form.querySelector('input[name="elective_group"]');
            if (electiveGroupInput) {
                electiveGroupInput.value = subject.elective_group || '';
            }
            
            // Điền phân bố học kỳ
            for (let i = 1; i <= 6; i++) {
                const hkField = `hk${i}`;
                if (subject[hkField] !== undefined && subject[hkField] !== null) {
                    const input = form.querySelector(`input[name="${hkField}"]`);
                    if (input) {
                        input.value = subject[hkField];
                    }
                }
            }
            
            // Hiển thị thông báo
            document.getElementById('existing-subject-info').classList.remove('hidden');
            document.getElementById('selected-subject-name').textContent = 
                `${subject.code} - ${subject.name}`;
        }

		// Hàm hiển thị dữ liệu trong dropdown
		function populateSubjectSelect(subjects) {
		    const select = $('#select-existing-subject');
		    if (!select.length) {
		        console.error('Select element not found');
		        return;
		    }

			// Lưu giá trị hiện tại
		    const currentValue = select.val();
		    select.empty();
		    
		    // Thêm option mặc định
		    select.append($('<option>', {
		        value: '',
		        text: '-- Tìm kiếm môn học có sẵn --'
		    }));
		    
			// Sử dụng subjects được truyền vào, nếu không có thì dùng allSubjects
    		const subjectList = subjects && subjects.length > 0 ? subjects : (allSubjects || []);
			
		    // Thêm các môn học
			if (subjectList.length > 0) {
			    subjectList.forEach(subject => {
			        const option = $('<option>', {
                        value: subject.id,
                        text: `${subject.code || ''} - ${subject.name || ''}`,
                        'data-subject': JSON.stringify(subject)
                    });
                    select.append(option);
			    });
			} else {
		        select.append($('<option>', {
		            value: '',
		            text: '-- Không có môn học nào --'
		        }));
		    }
		    // Khôi phục giá trị cũ (nếu có)
		    if (currentValue) {
		        select.val(currentValue);
		    }
		    // Refresh Select2
		    select.trigger('change.select2');
		}

        // Cập nhật hàm handleUseExistingSubject
        function handleUseExistingSubject() {
            const select = document.getElementById('select-existing-subject');
            if (!select) return;
            
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption.value || selectedOption.value === '') {
                alert('Vui lòng chọn một môn học');
                return;
            }
            
            // Lấy thông tin môn học từ data attribute
            const subjectData = selectedOption.getAttribute('data-subject');
            if (subjectData) {
                try {
                    const subject = JSON.parse(subjectData);
                    fillSubjectFormFromExisting(subject);
                } catch (e) {
                    console.error('Error parsing subject data:', e);
                    // Fallback: tìm trong mảng existingSubjects
                    const subjectId = selectedOption.value;
                    const subject = window.existingSubjects?.find(s => s.id == subjectId);
                    if (subject) {
                        fillSubjectFormFromExisting(subject);
                    } else {
                        alert('Không thể tải thông tin môn học. Vui lòng thử lại.');
                    }
                }
            } else {
                alert('Không có dữ liệu môn học. Vui lòng chọn môn học khác.');
            }
        }

        // Cập nhật hàm clearSubjectSelection
        function clearSubjectSelection() {
            console.log('Clearing subject selection...');

            const select = document.getElementById('select-existing-subject');
		    if (select) {
		        select.value = '';
		        if ($(select).hasClass('select2-hidden-accessible')) {
		            $(select).trigger('change.select2');
		        }
		    }
		    
		    const form = document.getElementById('form-them-mon-hoc');
		    if (form) {
		        form.querySelector('input[name="code"]').readOnly = false;
		        form.querySelector('input[name="name"]').readOnly = false;
		    }
        }

        // Khởi tạo dropdowns
        function initializeDropdowns() {
            if (allDepartments && allDepartments.length > 0) {
		        populateDropdown('khoa-dao-tao', allDepartments, 'name');
		    }
		    
		    if (allSubjectGroups && allSubjectGroups.length > 0) {
		        populateDropdown('to-bo-mon', allSubjectGroups, 'name');
		    }
		    
		    if (allCurricula && allCurricula.length > 0) {
		        populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
		        populateDropdown('import-curriculum', allCurricula, 'name');
		        populateDropdown('them-mon-hoc-curriculum', allCurricula, 'name');
		    }
		    
		    if (allCourses && allCourses.length > 0) {
		        populateDropdown('khoa-hoc', allCourses, 'name');
		        populateDropdown('import-course', allCourses, 'name');
		        populateDropdown('them-mon-hoc-course', allCourses, 'name');
		    }
		    
		    if (allMajors && allMajors.length > 0) {
		        const majorSelect = document.querySelector('select[name="major_id"]');
		        if (majorSelect) {
		            majorSelect.innerHTML = '<option value="">-- Chọn ngành --</option>';
		            allMajors.forEach(major => {
		                const option = document.createElement('option');
		                option.value = major.id;
		                option.textContent = `${major.name} (${major.code})`;
		                majorSelect.appendChild(option);
		            });
		        }
		    }
		    
		    if (allSubjectTypes && allSubjectTypes.length > 0) {
		        const typeSelect = document.querySelector('select[name="subject_type_id"]');
		        if (typeSelect) {
		            typeSelect.innerHTML = '<option value="">-- Chọn loại môn --</option>';
		            allSubjectTypes.forEach(type => {
		                const option = document.createElement('option');
		                option.value = type.id;
		                option.textContent = type.name;
		                typeSelect.appendChild(option);
		            });
		        }
		    }
        }
        
        function populateDropdown(elementId, data, displayField) {
            const dropdown = document.getElementById(elementId);
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">-- Chọn --</option>';
            
            if (data && Array.isArray(data)) {
		        data.forEach(item => {
		            const option = document.createElement('option');
		            option.value = item.id;
		            
		            let displayText = item[displayField] || '';
		            if (item.academic_year) {
		                displayText += ` (${item.academic_year})`;
		            }
		            if (item.code) {
		                displayText = `${item.code} - ${displayText}`;
		            }
		            
		            option.textContent = displayText;
		            option.setAttribute('data-name', item[displayField] || '');
		            option.setAttribute('data-code', item.code || '');
		            
		            // Lưu toàn bộ object dưới dạng data attribute
		            option.setAttribute('data-object', JSON.stringify(item));
		            
		            dropdown.appendChild(option);
		        });
            
	            // Cập nhật Select2 nếu đã được khởi tạo
	            if ($(dropdown).hasClass('select2-hidden-accessible')) {
	                $(dropdown).trigger('change');
	            }
			}
        }
        
        // Render bảng dữ liệu
		function renderTable() {
            const tableBody = document.getElementById('table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (!monHocData || monHocData.length === 0) {
		        const row = document.createElement('tr');
		        row.innerHTML = `<td colspan="19" class="px-4 py-4 text-center text-gray-500">Không có dữ liệu môn học</td>`;
		        tableBody.appendChild(row);
		        return;
		    }
            
            monHocData.forEach((monHoc, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-2 py-2 text-center text-sm col-tt">${index + 1}</td>
                    <td class="px-2 py-2 col-ma">
                        <input type="text" value="${monHoc.ma_mon_hoc || ''}"
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="code" data-id="${monHoc.id}" readonly
                            data-original-value="${monHoc.ma_mon_hoc || ''}">
                    </td>
                    <td class="px-2 py-2 col-ten wrap-cell">
                        <input type="text" value="${monHoc.ten_mon_hoc || 0}"
                            class="editable w-full bg-transparent border-none text-sm text-center"
                            data-field="name" data-id="${monHoc.id}" disabled
                            data-original-value="${monHoc.ten_mon_hoc || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-tinchi">
                        <input type="number" value="${monHoc.so_tin_chi || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="credits" data-id="${monHoc.id}" readonly step="0.5" min="0"
                            data-original-value="${monHoc.so_tin_chi || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-gio">
                        <input type="number" value="${monHoc.tong_so_gio || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="total_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.tong_so_gio || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-lythuyet">
                        <input type="number" value="${monHoc.ly_thuyet || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="theory_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.ly_thuyet || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-thuchanh">
                        <input type="number" value="${monHoc.thuc_hanh || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="practice_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.thuc_hanh || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-kiemtra">
                        <input type="number" value="${monHoc.kiem_tra || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="tests_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.kiem_tra || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-thi">
                        <input type="number" value="${monHoc.thi || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="exam_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.thi || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk1 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk1" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk1 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk2 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk2" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk2 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk3 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk3" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk3 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk4 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk4" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk4 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk5 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk5" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk5 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk6 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk6" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk6 || ''}">
                    </td>
                    <td class="px-2 py-2 col-donvi">
                        <select class="editable select department-select w-full bg-transparent border-none text-sm" 
                                data-field="department" data-id="${monHoc.id}" disabled
                                data-original-value="${monHoc.don_vi || ''}">
                            <option value="">-- Chọn đơn vị --</option>
                            ${allDepartments.map(dept => `
                                <option value="${dept.name}" ${dept.name === monHoc.don_vi ? 'selected' : ''}>
                                    ${dept.name}
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="px-2 py-2 col-giangvien">
                        <input type="text" value="${monHoc.giang_vien || ''}" 
                            class="editable instructor-autocomplete w-full bg-transparent border-none text-sm" 
                            data-field="instructor" data-id="${monHoc.id}" readonly
                            data-original-value="${monHoc.giang_vien || ''}"
                            placeholder="Nhập tên giảng viên..."
                            list="instructor-suggestions-${monHoc.id}">
                        <datalist id="instructor-suggestions-${monHoc.id}">
                            <!-- Suggestions will be populated dynamically -->
                        </datalist>
                    </td>
                    <td class="px-2 py-2 col-course">
                        <select class="editable w-full bg-transparent border-none text-sm" 
                                data-field="course" data-id="${monHoc.id}" readonly
                                data-original-value="${monHoc.course_id || ''}">
                            <option value="">-- Chọn khóa học --</option>
                            ${allCourses.map(course => `
                                <option value="${course.id}" ${course.id == monHoc.course_id ? 'selected' : ''}>
                                    ${course.name} (${course.code})
                                </option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="px-2 py-2 text-center col-thaotac">
                        <button class="btn-sua text-blue-600 hover:text-blue-900 mr-2" data-id="${monHoc.id}" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-xoa text-red-600 hover:text-red-900" data-id="${monHoc.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Khởi tạo autocomplete sau khi render
            //setTimeout(() => {
            //    initializeInstructorAutocomplete();
            //}, 200);
            
            // Cập nhật thống kê
            updateStatistics();
        }
        
        // Cập nhật thống kê
        function updateStatistics() {
            if (!monHocData || monHocData.length === 0) {
		        document.getElementById('tong-tin-chi').textContent = '0';
		        document.getElementById('tong-gio').textContent = '0';
		        document.getElementById('ty-le-ly-thuyet').textContent = '0%';
		        document.getElementById('ty-le-thuc-hanh').textContent = '0%';
		        return;
		    }
			const totalCredits = monHocData.reduce((sum, item) => sum + (parseFloat(item.so_tin_chi) || 0), 0);
            const totalHours = monHocData.reduce((sum, item) => sum + (parseInt(item.tong_so_gio) || 0), 0);
            const totalTheory = monHocData.reduce((sum, item) => sum + (parseInt(item.ly_thuyet) || 0), 0);
            const totalPractice = monHocData.reduce((sum, item) => sum + (parseInt(item.thuc_hanh) || 0), 0);
            
            const tyLeLyThuyet = totalHours > 0 ? (totalTheory / totalHours * 100).toFixed(1) : 0;
            const tyLeThucHanh = totalHours > 0 ? (totalPractice / totalHours * 100).toFixed(1) : 0;
            
            document.getElementById('tong-tin-chi').textContent = totalCredits.toFixed(1);
            document.getElementById('tong-gio').textContent = totalHours;
            document.getElementById('ty-le-ly-thuyet').textContent = `${tyLeLyThuyet}%`;
            document.getElementById('ty-le-thuc-hanh').textContent = `${tyLeThucHanh}%`;
        }
        
        // Load thống kê
        function loadThongKe(curriculumId) {
            fetch(`/thong-ke/?curriculum_id=${curriculumId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tong-tin-chi').textContent = data.tong_tin_chi;
                    document.getElementById('tong-gio').textContent = data.tong_gio;
                    document.getElementById('ty-le-ly-thuyet').textContent = data.ty_le_ly_thuyet;
                    document.getElementById('ty-le-thuc-hanh').textContent = data.ty_le_thuc_hanh;
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    updateStatistics();
                });
        }

		// Cập nhật môn học
        function updateMonHoc(id, field, value) {
            try {
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    console.error('CSRF token not found');
                    alert('Lỗi bảo mật: Không tìm thấy CSRF token');
                    return;
                }
                
                const data = {
                    id: id,
                    field: field,
                    value: value
                };
                console.log('Sending update:', data);

                fetch(`/train-program/${id}/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status}: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status !== 'success') {
                        console.error('Update error:', data.message);
                        alert(data.message);
                        // Reload data to reset values
                        loadFilteredData();
                    } else {
                        console.log('Update success:', data.message);
                        //updateOriginalValue(id, field, value);
                        loadFilteredData();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi cập nhật: ' + error.message);
                    loadFilteredData();
                });
            } catch (error) {
                console.error('Error in updateMonHoc:', error);
                alert('Lỗi trong hàm updateMonHoc: ' + error.message);
            }
        }

        function getCSRFToken() {
            try {
                // Thử tìm meta tag trước
                const metaTag = document.querySelector('meta[name="csrf-token"]');
                if (metaTag) {
                    return metaTag.getAttribute('content');
                }
                
                // Thử tìm trong {% csrf_token %}
                const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (csrfTokenInput) {
                    return csrfTokenInput.value;
                }
                
                // Thử lấy từ cookie
                return getCookie('csrftoken');
            } catch (error) {
                console.error('Error getting CSRF token:', error);
                return null;
            }
        }

        // Hàm cập nhật giá trị gốc sau khi thành công
        function updateOriginalValue(id, field, value) {
            const input = document.querySelector(`[data-id="${id}"][data-field="${field}"]`);
            if (input) {
                input.setAttribute('data-original-value', value);
            }
        }

        // Cập nhật phân bố học kỳ
        function updateSemesterAllocation(curriculumSubjectId, semester, credits) {
            const data = {
                id: curriculumSubjectId,
                field: `hk${semester}`,
                value: credits
            };
            
            console.log('Sending semester update:', data); // Debug log
            
            fetch(`/train-program/${curriculumSubjectId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Semester update error:', data.message);
                    alert('Có lỗi khi cập nhật học kỳ: ' + data.message);
                    // Reload data to reset values
                    loadFilteredData();
                } else {
                    console.log('Semester update success:', data.message);
					loadFilteredData();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật học kỳ: ' + error.message);
                loadFilteredData();
            });
        }
        
        // Xóa môn học
        function deleteMonHoc(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa môn học này?')) {
                return;
            }
            
            fetch(`/train-program/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã xóa môn học thành công');
                    loadFilteredData();
                } else {
                    alert('Có lỗi khi xóa: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa');
            });
        }
		
        // Load dữ liệu theo bộ lọc
        function loadFilteredData() {
            const departmentId = document.getElementById('khoa-dao-tao')?.value;
            const subjectGroupId = document.getElementById('to-bo-mon')?.value;
            const curriculumId = document.getElementById('chuong-trinh-dao-tao')?.value;
            const courseId = document.getElementById('khoa-hoc')?.value;

			console.log('Filters:', { departmentId, curriculumId, courseId });

			// Nếu không có bộ lọc, hiển thị tất cả dữ liệu
		    if (!departmentId && !curriculumId && !courseId) {
		        console.log('No filters applied, showing all data');
		        renderTable();
		        return;
		    }

			// Hiển thị thông báo đang lọc
		    const tableBody = document.getElementById('table-body');
		    if (tableBody) {
		        tableBody.innerHTML = '<tr><td colspan="19" class="px-4 py-4 text-center text-gray-500">Đang lọc dữ liệu...</td></tr>';
		    }
		    
		    // Giả lập việc lọc dữ liệu
		    setTimeout(() => {
		        // Trong thực tế, đây sẽ là call API
		        // Tạm thời hiển thị toàn bộ dữ liệu
		        console.log('Filtering complete, showing data');
		        renderTable();
		    }, 500);

			
            //let url = '/api/subjects/';
            //const params = [];
            
            //if (curriculumId) params.push(`curriculum_id=${curriculumId}`);
            //if (departmentId) params.push(`department_id=${departmentId}`);
            //if (subjectGroupId) params.push(`subject_group_id=${subjectGroupId}`);
			//if (courseId) params.push(`course_id=${courseId}`);
            
            //url += '?' + params.join('&');
            
            //safeFetch(url)
            //    .then(data => {
            //        monHocData = data;
            //        renderTable();
                    
                    // Load thống kê nếu có curriculum
            //        if (curriculumId) {
            //            loadThongKe(curriculumId);
            //        } else {
            //            updateStatistics();
            //        }
            //    })
            //    .catch(error => {
            //        console.error('Error loading filtered data:', error);
            //        alert('Có lỗi xảy ra khi tải dữ liệu');
            //    });
        }

        // Thêm hàm để tải danh sách môn học có sẵn
        function loadExistingSubjects() {
            safeFetch('/api/all-subjects/')
                .then(subjects => {
                    const select = document.getElementById('select-existing-subject');
                    select.innerHTML = '<option value="">-- Chọn môn học có sẵn --</option>';
                    
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.id;
                        option.textContent = `${subject.code} - ${subject.name}`;
                        option.setAttribute('data-name', subject.name);
                        option.setAttribute('data-code', subject.code);
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading existing subjects:', error);
                });
        }

		// Tải danh sách môn học có sẵn từ dữ liệu hiện tại
		function loadExistingSubjectsFromCurrentData() {
		    console.log('Loading existing subjects from current data...');
		    
		    // Sử dụng dữ liệu monHocData hiện tại để tạo danh sách môn học có sẵn
		    const existingSubjects = [];
		    
		    // Lọc các môn học duy nhất từ monHocData
		    const uniqueSubjects = {};
		    if (monHocData && monHocData.length > 0) {
		        monHocData.forEach(item => {
		            if (item.ma_mon_hoc && !uniqueSubjects[item.ma_mon_hoc]) {
		                uniqueSubjects[item.ma_mon_hoc] = true;
		                existingSubjects.push({
		                    id: item.id || item.ma_mon_hoc,
		                    code: item.ma_mon_hoc,
		                    name: item.ten_mon_hoc,
		                    credits: item.so_tin_chi,
		                    total_hours: item.tong_so_gio,
		                    theory_hours: item.ly_thuyet,
		                    practice_hours: item.thuc_hanh,
		                    tests_hours: item.kiem_tra,
		                    exam_hours: item.thi
		                });
		            }
		        });
		    }
		    
		    // Thêm một số môn học mẫu nếu không có dữ liệu
		    if (existingSubjects.length === 0) {
		        existingSubjects.push(
		            { id: 1, code: 'MH001', name: 'Toán cao cấp', credits: 3, total_hours: 45, theory_hours: 30, practice_hours: 15 },
		            { id: 2, code: 'MH002', name: 'Lập trình cơ bản', credits: 4, total_hours: 60, theory_hours: 30, practice_hours: 30 },
		            { id: 3, code: 'MH003', name: 'Cơ sở dữ liệu', credits: 3, total_hours: 45, theory_hours: 25, practice_hours: 20 }
		        );
		    }
		    
		    // Cập nhật dropdown
		    const select = document.getElementById('select-existing-subject');
		    if (select) {
		        select.innerHTML = '<option value="">-- Tìm kiếm môn học có sẵn --</option>';
		        
		        existingSubjects.forEach(subject => {
		            const option = document.createElement('option');
		            option.value = subject.id;
		            option.textContent = `${subject.code} - ${subject.name}`;
		            option.setAttribute('data-subject', JSON.stringify(subject));
		            select.appendChild(option);
		        });
		        
		        // Cập nhật Select2
		        if ($(select).hasClass('select2-hidden-accessible')) {
		            $(select).trigger('change.select2');
		        }
		    }
		    
		    window.existingSubjects = existingSubjects;
		    console.log('Loaded', existingSubjects.length, 'existing subjects');
		}

        // Tạo môn học mới
        function createMonHoc() {
            const form = document.getElementById('form-them-mon-hoc');
            if (!form) {
                console.error('Form them mon hoc not found');
                alert('Không tìm thấy form thêm môn học');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
                        
            // Validate dữ liệu
            if (!data.curriculum_id || !data.code || !data.name || !data.credits || !data.subject_type_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc (*)');
                return;
            }
            
            // Chuẩn bị dữ liệu học kỳ
            const semesterData = {};
            for (let i = 1; i <= 6; i++) {
                const hkValue = data[`hk${i}`];
                if (hkValue && hkValue !== '') {
                    try {
                        semesterData[`hk${i}`] = parseFloat(hkValue);
                    } catch (e) {
                        console.error(`Error parsing HK${i} value:`, hkValue);
                    }
                }
            }
            
            // Chuẩn bị dữ liệu gửi đi
            const postData = {
                ...data,
                semester_allocations: semesterData
            };
                        
            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-mon-hoc');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;
            
            fetch('/api/subjects/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(postData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo môn học thành công!');
                    closeThemMonHocModal();
                    // Reload dữ liệu
                    loadFilteredData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                alert('❌ Có lỗi xảy ra khi tạo môn học: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Tạo chương trình đào tạo mới
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Validate
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã tạo chương trình đào tạo thành công');
                    document.getElementById('modal-them-chuong-trinh').classList.add('hidden');
                    form.reset();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tạo chương trình');
            });
        }
        
        // Mở modal import Excel
        function openImportModal() {
            document.getElementById('modal-import').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        // Đóng modal import Excel
        function closeImportModal() {
            const modal = document.getElementById('modal-import');
		    if (modal) {
		        modal.classList.add('hidden');
		    }
		    document.body.classList.remove('overflow-hidden');
        }

        // Mở modal lỗi import
        function openImportErrorsModal() {
            document.getElementById('modal-import-errors').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        // Đóng modal lỗi import
        function closeImportErrorsModal() {
            document.getElementById('modal-import-errors').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // Hiển thị lỗi import
        function showImportErrors(errors) {
            const errorsContent = document.getElementById('import-errors-content');
            if (errors && errors.length > 0) {
                errorsContent.innerHTML = `
                    <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded">
                        <h4 class="font-semibold text-red-800 mb-2">Có ${errors.length} lỗi cần xem xét:</h4>
                    </div>
                    <div class="space-y-2">
                        ${errors.map(error => 
                            `<div class="flex items-start text-red-700 py-2 border-b border-red-100">
                                <i class="fas fa-exclamation-circle mt-1 mr-2 text-red-500 flex-shrink-0"></i>
                                <span class="text-sm">${error}</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
            } else {
                errorsContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <div class="text-green-600 font-semibold">Không có lỗi nào trong quá trình import</div>
                    </div>
                `;
            }
            openImportErrorsModal();
        }

        // Import Excel với xử lý lỗi chi tiết
        function importExcel() {
            const form = document.getElementById('form-import');
            const formData = new FormData(form);
            const curriculumId = document.getElementById('import-curriculum').value;
            const courseId = document.getElementById('import-course').value;
            const fileInput = document.getElementById('excel-file');
            const sheetSelect = document.getElementById('sheet-select');
            
            if (!curriculumId) {
                alert('Vui lòng chọn chương trình đào tạo');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file Excel');
                return;
            }

            // Thêm thông tin sheet vào formData
            const selectedSheet = sheetSelect.value;
            if (selectedSheet) {
                formData.append('sheet_name', selectedSheet);
            }
            
            // Hiển thị loading
            const importBtn = document.getElementById('btn-luu-import');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
            importBtn.disabled = true;
            
            fetch('/import-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    let successMessage = '✅ ' + data.message;
                    if (data.sheet_used) {
                        successMessage += ` (Sheet: ${data.sheet_used})`;
                    }
                    alert(successMessage);
                    closeImportModal();
                    
                    // Hiển thị chi tiết lỗi nếu có
                    if (data.data && data.data.errors && data.data.errors.length > 0) {
                        showImportErrors(data.data.errors);
                    }
                    
                    // Reload data
                    loadFilteredData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi import file: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            });
        }

        // Tải file mẫu
        function downloadTemplate() {
            window.open('/download-excel-template/', '_blank');
        }
        
        // Load lại danh sách curricula
        function loadCurricula() {
            fetch('/api/curricula/')
                .then(response => response.json())
                .then(data => {
                    allCurricula = data;
                    populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
                    populateDropdown('import-curriculum', allCurricula, 'name');
                })
                .catch(error => {
                    console.error('Error loading curricula:', error);
                });
        }

        // Load lại danh sách courses
        function loadCourses() {
            fetch('/api/courses/')
                .then(response => response.json())
                .then(data => {
                    allCourses = data;
                    populateDropdown('khoa-hoc', allCourses, 'name');
                    populateDropdown('import-course', allCourses, 'name');
                })
                .catch(error => {
                    console.error('Error loading curricula:', error);
                });
        }

        // Hàm lấy danh sách sheet từ file Excel
        function getSheetNamesFromFile(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('excel_file', file);
                
                fetch('/api/get-sheet-names/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        resolve(data.sheet_names);
                    } else {
                        reject(new Error(data.message));
                    }
                })
                .catch(error => {
                    reject(error);
                });
            });
        }
        
        // Mở modal thêm chương trình
        function openThemChuongTrinhModal() {
            console.log('Opening curriculum modal...');
            const modal = document.getElementById('modal-them-chuong-trinh');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            
                // Đảm bảo các input có thể nhập
                setTimeout(() => {
                    initializeSelect2ForCurriculumModal();
            
                    // Đảm bảo các input có thể nhập
                    const inputs = modal.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        input.removeAttribute('readonly');
                        input.removeAttribute('disabled');
                        input.style.pointerEvents = 'auto';
                        input.style.userSelect = 'auto';
                    });
                    
                    // Focus vào input đầu tiên
                    const firstInput = modal.querySelector('input[name="code"]');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 100);
            }
        }

        // Đóng modal thêm chương trình
        function closeThemChuongTrinhModal() {
            const modal = document.getElementById('modal-them-chuong-trinh');
            if (modal) {
                modal.classList.add('hidden');
            }
			document.body.classList.remove('overflow-hidden');
			
			// Reset form
			//const form = document.getElementById('form-them-chuong-trinh');
			//if (form) {
			//	form.reset();
			//}
        }

        // Hàm kiểm tra và sửa lỗi input trong modal
        function fixModalInputs() {
            const modal = document.getElementById('modal-them-chuong-trinh');
            if (!modal) return;
            
            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                // Xóa các attribute chặn input
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
                
                // Đảm bảo các thuộc tính style đúng
                input.style.pointerEvents = 'auto';
                input.style.userSelect = 'auto';
                input.style.backgroundColor = 'white';
                input.style.cursor = 'text';
                
                // Thêm event listener để debug
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Input clicked:', this.name);
                });
                
                input.addEventListener('focus', function(e) {
                    e.stopPropagation();
                    console.log('Input focused:', this.name);
                    this.style.borderColor = '#3b82f6';
                    this.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
                });
                
                input.addEventListener('blur', function(e) {
                    e.stopPropagation();
                    this.style.borderColor = '#d1d5db';
                    this.style.boxShadow = 'none';
                });
            });
        }

        // Tạo chương trình đào tạo mới
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            if (!form) {
                console.error('Form not found');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            console.log('Form data:', data);
            
            // Validate dữ liệu
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }
            
            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-chuong-trinh');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo chương trình đào tạo thành công!');
                    closeThemChuongTrinhModal();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi tạo chương trình: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Mở modal thêm môn học
        function openThemMonHocModal() {
            const modal = document.getElementById('modal-them-mon-hoc');
            if (!modal) {
                console.error('Modal them mon hoc not found');
                return;
            }
			
			// Hiển thị modal
		    //modal.classList.remove('hidden');
		    //document.body.classList.add('overflow-hidden');
			//document.body.classList.add('modal-open');

			// Đóng các modal khác nếu đang mở
		    closeThemChuongTrinhModal();
		    closeImportModal();

			// Reset form
		    const form = document.getElementById('form-them-mon-hoc');
		    if (form) {
		        form.reset();
		        clearSubjectSelection();
		    }

			// Lấy giá trị từ dropdown chính
		    const curriculumSelect = document.getElementById('chuong-trinh-dao-tao');
		    const courseSelect = document.getElementById('khoa-hoc');
		    
		    let selectedCurriculumId = '';
		    let selectedCourseId = '';
		    
		    if (curriculumSelect) {
		        selectedCurriculumId = curriculumSelect.value;
		    }
		    
		    if (courseSelect) {
		        selectedCourseId = courseSelect.value;
		    }
		    
		    // Hiển thị modal
		    modal.classList.remove('hidden');
		    document.body.classList.add('overflow-hidden');
			
			setTimeout(() => {
		        // Khởi tạo Select2
		        initializeSelect2ForSubjectModal();
		        
		        // Set giá trị mặc định nếu có
		        if (selectedCurriculumId) {
		            const curriculumSelectInModal = document.getElementById('them-mon-hoc-curriculum');
		            if (curriculumSelectInModal) {
		                curriculumSelectInModal.value = selectedCurriculumId;
		                $(curriculumSelectInModal).trigger('change');
		                updateMajorInfo(selectedCurriculumId);
		            }
		        }
		        
		        if (selectedCourseId) {
		            const courseSelectInModal = document.getElementById('them-mon-hoc-course');
		            if (courseSelectInModal) {
		                courseSelectInModal.value = selectedCourseId;
		                $(courseSelectInModal).trigger('change');
		            }
		        }

				// Tải danh sách môn học có sẵn từ dữ liệu hiện tại
        		loadExistingSubjectsFromCurrentData();
		        
		        // Load danh sách môn học có sẵn
		        //setTimeout(() => {
		        //    loadExistingSubjects();
		        //}, 300);
		        
		        // Focus vào input đầu tiên
		        setTimeout(() => {
		            const firstInput = modal.querySelector('input[name="code"]');
		            if (firstInput) {
		                firstInput.focus();
		                //firstInput.select();
		            }
		        }, 200);
		        
		    }, 100);
        }

        // Đóng modal thêm môn học
        function closeThemMonHocModal() {
			const modal = document.getElementById('modal-them-mon-hoc');
		    if (modal) {
		        modal.classList.add('hidden');
		    }
		    
		    document.body.classList.remove('overflow-hidden');
		    //document.body.classList.remove('modal-open');
		    
		    // Reset form
		    //const form = document.getElementById('form-them-mon-hoc');
		    //if (form) {
		    //    form.reset();
		    //    clearSubjectSelection();
		    //}
        }

        // Cập nhật thông tin ngành đào tạo khi chọn chương trình
        function updateMajorInfo(curriculumId) {
            const majorField = document.getElementById('them-mon-hoc-major');
            if (!majorField || !curriculumId) {
                return;
            }
            
            // Tìm thông tin chương trình
            const curriculum = allCurricula.find(c => c.id == curriculumId);
            if (curriculum && curriculum.major_id) {
                const major = allMajors.find(m => m.id == curriculum.major_id);
                if (major) {
                    majorField.value = `${major.name} (${major.code})`;
                    return;
                }
            }
            majorField.value = 'Không xác định';
        }

        // Lọc tổ bộ môn theo khoa
        function filterSubjectGroupsByDepartment(departmentId) {
            const subjectGroupSelect = document.querySelector('select[name="subject_group_id"]');
            if (!subjectGroupSelect) return;
            
            const options = subjectGroupSelect.querySelectorAll('option');
            
            options.forEach(option => {
                if (option.value === '') return; // Giữ option "-- Chọn tổ bộ môn --"
                
                const optionDepartmentId = option.getAttribute('data-department');
                if (!departmentId || optionDepartmentId == departmentId) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset selection nếu option hiện tại bị ẩn
            if (subjectGroupSelect.value) {
                const selectedOption = subjectGroupSelect.querySelector(`option[value="${subjectGroupSelect.value}"]`);
                if (selectedOption && selectedOption.style.display === 'none') {
                    subjectGroupSelect.value = '';
                }
            }
        }

        // Hàm xử lý khi chọn môn học có sẵn
        function handleUseExistingSubject() {
            const select = document.getElementById('select-existing-subject');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Vui lòng chọn một môn học');
                return;
            }
            
            // Hiển thị thông tin môn học đã chọn
            document.getElementById('existing-subject-info').classList.remove('hidden');
            document.getElementById('selected-subject-name').textContent = 
                `${selectedOption.getAttribute('data-code')} - ${selectedOption.getAttribute('data-name')}`;
            
            // Điền thông tin vào form
            document.querySelector('input[name="code"]').value = selectedOption.getAttribute('data-code');
            document.querySelector('input[name="name"]').value = selectedOption.getAttribute('data-name');
            
            // Disable các trường mã và tên để tránh chỉnh sửa
            document.querySelector('input[name="code"]').setAttribute('readonly', 'true');
            document.querySelector('input[name="name"]').setAttribute('readonly', 'true');
        }

        // Hàm xóa lựa chọn
        function clearSubjectSelection() {
            document.getElementById('existing-subject-info').classList.add('hidden');
            document.getElementById('select-existing-subject').value = '';
            document.querySelector('input[name="code"]').removeAttribute('readonly');
            document.querySelector('input[name="name"]').removeAttribute('readonly');
            document.querySelector('input[name="code"]').value = '';
            document.querySelector('input[name="name"]').value = '';
        }

        // Biến lưu trữ timeout cho debounce
        let instructorSearchTimeout = null;

        // Hàm tìm kiếm giảng viên với debounce
        function searchInstructors(query, targetInput) {
            if (instructorSearchTimeout) {
                clearTimeout(instructorSearchTimeout);
            }
            
            // Clear suggestions nếu query quá ngắn
            if (query.length < 2) {
                clearInstructorSuggestions(targetInput);
                return;
            }
            
            instructorSearchTimeout = setTimeout(() => {
                fetch(`/api/search-instructors/?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        console.log('API response status:', response.status); // Debug
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(instructors => {
                        console.log('API returned instructors:', instructors); // Debug
                        showInstructorSuggestions(instructors, targetInput);
                    })
                    .catch(error => {
                        console.error('Error searching instructors:', error);
                        clearInstructorSuggestions(targetInput);
                    });
            }, 300);
        }

        // Hàm hiển thị suggestions
        function showInstructorSuggestions(instructors, targetInput) {            
            // Tìm datalist liên kết với input
            const datalist = targetInput.nextElementSibling;
            if (!datalist || datalist.tagName !== 'DATALIST') {
                console.error('Datalist not found for input:', targetInput);
                return;
            }
            
            datalist.innerHTML = '';
            
            if (instructors.length === 0) {
                return;
            }
            
            instructors.forEach(instructor => {
                const option = document.createElement('option');
                option.value = instructor.full_name;
                option.textContent = `${instructor.full_name} (${instructor.code})`;
                option.setAttribute('data-instructor-id', instructor.id);
                datalist.appendChild(option);
            });
            
        }

        // Hàm xóa suggestions
        function clearInstructorSuggestions(targetInput) {
            const datalist = targetInput.nextElementSibling;
            if (datalist && datalist.tagName === 'DATALIST') {
                datalist.innerHTML = '';
            }
        }

        // Hàm xử lý khi chọn một suggestion
        function handleInstructorSelection(input) {
            // Có thể thêm logic xử lý khi chọn suggestion ở đây
            console.log('Instructor selected:', input.value);
        }

        // Hàm khởi tạo autocomplete cho tất cả input giảng viên
        function initializeInstructorAutocomplete() {
            document.querySelectorAll('.instructor-autocomplete').forEach(input => {
                // Kiểm tra xem input đã có event listeners chưa
                if (input.hasAttribute('data-autocomplete-initialized')) {
                    return; // Đã khởi tạo rồi, bỏ qua
                }
                                
                // Đánh dấu đã khởi tạo
                input.setAttribute('data-autocomplete-initialized', 'true');
                
                // Thêm event listeners
                input.addEventListener('input', function(e) {
                    if (!this.readOnly && !this.disabled) {
                        console.log('Input event:', this.value); // Debug
                        searchInstructors(this.value, this);
                    }
                });
                
                input.addEventListener('focus', function(e) {
                    if (!this.readOnly && !this.disabled && this.value.length >= 2) {
                        console.log('Focus event, searching:', this.value); // Debug
                        searchInstructors(this.value, this);
                    }
                });
                
                input.addEventListener('blur', function(e) {
                    // Delay clearing để cho phép click vào suggestions
                    setTimeout(() => {
                        clearInstructorSuggestions(this);
                    }, 200);
                });
                
                input.addEventListener('change', function(e) {
                    handleInstructorSelection(this);
                });
            });
        }

        // Hàm load tất cả môn học để populate dropdowns
        function loadAllSubjects() {
            if (allSubjects.length > 0 && isSubjectsLoaded) {
		        console.log('Subjects already loaded:', allSubjects.length);
		        return Promise.resolve(allSubjects);
		    }
    		console.log('Loading all subjects from API...');
			return safeFetch('/api/all-subjects/')
		        .then(result => {
		            console.log('API result:', result);
		            
		            if (result.success) {
		                // Kiểm tra cấu trúc response mới
		                if (result.data.status === 'success') {
		                    allSubjects = result.data.data || [];
		                    console.log('Successfully loaded', allSubjects.length, 'subjects');
		                } else if (Array.isArray(result.data)) {
		                    // Fallback cho response cũ (nếu vẫn là array)
		                    allSubjects = result.data || [];
		                    console.log('Loaded (legacy format)', allSubjects.length, 'subjects');
		                } else {
		                    console.warn('Unexpected API response format:', result.data);
		                    allSubjects = [];
		                }
		            } else {
		                console.warn('API call failed:', result.message);
		                allSubjects = [];
		            }
		            
		            isSubjectsLoaded = true;
		            return allSubjects;
		        })
		        .catch(error => {
		            console.error('Error in loadAllSubjects:', error);
		            
		            // Fallback data
		            const fallbackSubjects = [
		                { id: 1, code: 'MH001', name: 'Toán cao cấp', credits: 3, total_hours: 45, theory_hours: 30, practice_hours: 15 },
		                { id: 2, code: 'MH002', name: 'Lập trình cơ bản', credits: 4, total_hours: 60, theory_hours: 30, practice_hours: 30 },
		                { id: 3, code: 'MH003', name: 'Cơ sở dữ liệu', credits: 3, total_hours: 45, theory_hours: 25, practice_hours: 20 },
		                { id: 4, code: 'MH004', name: 'Mạng máy tính', credits: 3, total_hours: 45, theory_hours: 30, practice_hours: 15 },
		                { id: 5, code: 'MH005', name: 'Phần mềm mã nguồn mở', credits: 2, total_hours: 30, theory_hours: 15, practice_hours: 15 },
		            ];
		            
		            allSubjects = fallbackSubjects;
		            isSubjectsLoaded = true;
		            
		            console.log('Using fallback subjects:', allSubjects.length);
		            return allSubjects;
		        });
        }

		function enableModalInputs() {
		    const modal = document.getElementById('modal-them-mon-hoc');
		    if (!modal) return;
		    
		    const allInputs = modal.querySelectorAll('input, select, textarea');
		    allInputs.forEach(input => {
		        // Remove any blocking attributes
		        input.removeAttribute('disabled');
		        input.removeAttribute('readonly');
		        
		        // Force styles
		        input.style.pointerEvents = 'auto';
		        input.style.cursor = 'text';
		        input.style.userSelect = 'auto';
		        input.style.webkitUserSelect = 'auto';
		        input.style.backgroundColor = 'white';
		        input.style.color = '#000';
		        input.style.opacity = '1';
		        
		        // Add event listeners to ensure they work
		        input.addEventListener('mousedown', function(e) {
		            e.stopPropagation();
		        });
		        
		        input.addEventListener('click', function(e) {
		            e.stopPropagation();
		        });
		        
		        input.addEventListener('focus', function(e) {
		            this.style.outline = '2px solid #3b82f6';
		        });
		        
		        input.addEventListener('blur', function(e) {
		            this.style.outline = '';
		        });
		    });
		}

        // Hàm lấy CSRF token
        function getCookie(name) {
            try {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            } catch (error) {
                console.error('Error getting cookie:', error);
                return null;
            }
        }
        
        // Xử lý sự kiện khi trang tải xong
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded - initializing...');
			// Khởi tạo dropdowns từ dữ liệu Django template
            initializeDropdowns();

			// Render bảng với dữ liệu hiện có
            renderTable();
            
            // Khởi tạo Select2 sau khi DOM đã sẵn sàng
            setTimeout(() => {
                initializeSelect2();
            }, 300);
            
            // Pre-load danh sách môn học nhưng không block render
			setTimeout(() => {
    			loadAllSubjects();
			}, 500);
			    
            // Kiểm tra các input trong modal
            const modalInputs = document.querySelectorAll('#modal-them-chuong-trinh input, #modal-them-chuong-trinh select, #modal-them-chuong-trinh textarea');
            console.log('Found inputs in modal:', modalInputs.length);
            
            modalInputs.forEach(input => {
                console.log('Input:', input.name, 'Type:', input.type, 'Readonly:', input.readOnly, 'Disabled:', input.disabled);
                
                // Xóa các attribute có thể chặn input
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
                
                // Thêm event listener để debug
                input.addEventListener('focus', function() {
                    console.log('Input focused:', this.name);
                });
                
                input.addEventListener('input', function() {
                    console.log('Input changed:', this.name, 'Value:', this.value);
                });
            });

            // Cập nhật sự kiện cho dropdown chính sử dụng jQuery
            $(document).on('change', '#khoa-dao-tao', function() {
                const departmentId = this.value;
                
                // Reset các dropdown phía sau
                $('#to-bo-mon').val('').trigger('change');
                $('#chuong-trinh-dao-tao').val('').trigger('change');
                $('#khoa-hoc').val('').trigger('change');
                
                // Load subject groups theo department
                if (departmentId) {
                    fetch(`/api/subject-groups/?department_id=${departmentId}`)
                        .then(response => response.json())
                        .then(data => {
                            // Cập nhật dropdown tổ bộ môn
                            const select = $('#to-bo-mon');
                            select.empty();
                            select.append($('<option>', {
                                value: '',
                                text: '-- Chọn tổ bộ môn --'
                            }));
                            
                            data.forEach(item => {
                                select.append($('<option>', {
                                    value: item.id,
                                    text: item.name
                                }));
                            });
                            
                            select.trigger('change');
                        });
                }
                
                loadFilteredData();
            });
            
            $(document).on('change', '#chuong-trinh-dao-tao', function() {
			    const curriculumId = this.value;
			    $('#khoa-hoc').val('').trigger('change');
			    
			    if (curriculumId) {
			        // 1. Đầu tiên, thử filter từ dữ liệu đã có (allCourses từ template)
			        const localCourses = allCourses.filter(course => {
			            // Kiểm tra cả số và chuỗi để đảm bảo matching
			            return course.curriculum_id == curriculumId || 
			                   (course.curriculum && course.curriculum.id == curriculumId) ||
			                   (typeof course.curriculum_id !== 'undefined' && course.curriculum_id == curriculumId);
			        });
			        
			        const courseSelect = $('#khoa-hoc');
			        courseSelect.empty();
			        
			        if (localCourses.length > 0) {
			            console.log('Using local courses data:', localCourses.length);
			            
			            courseSelect.append($('<option>', {
			                value: '',
			                text: '-- Chọn khóa học --'
			            }));
			            
			            localCourses.forEach(item => {
			                const displayText = item.code ? 
			                    `${item.name} (${item.code})` : 
			                    item.name;
			                
			                courseSelect.append($('<option>', {
			                    value: item.id,
			                    text: displayText
			                }));
			            });
			            
			            courseSelect.trigger('change');
			        } else {
			            // 2. Nếu không có dữ liệu cục bộ, mới gọi API
			            console.log('No local courses, fetching from API...');
			            
			            courseSelect.append($('<option>', {
			                value: '',
			                text: 'Đang tải...'
			            }));
			            courseSelect.prop('disabled', true);
			            
			            // Gọi API với timeout ngắn hơn
			            setTimeout(() => {
			                safeFetch(`/api/courses/?curriculum_id=${curriculumId}`)
			                    .then(result => {
			                        courseSelect.empty();
			                        courseSelect.append($('<option>', {
			                            value: '',
			                            text: '-- Chọn khóa học --'
			                        }));
			                        
			                        if (result.success && Array.isArray(result.data)) {
			                            result.data.forEach(item => {
			                                const displayText = item.code ? 
			                                    `${item.name} (${item.code})` : 
			                                    item.name;
			                                
			                                courseSelect.append($('<option>', {
			                                    value: item.id,
			                                    text: displayText
			                                }));
			                            });
			                        } else {
			                            console.warn('No courses from API:', result.message);
			                            courseSelect.append($('<option>', {
			                                value: '',
			                                text: '-- Không có khóa học --',
			                                disabled: true
			                            }));
			                        }
			                    })
			                    .catch(error => {
			                        console.error('Error loading courses:', error);
			                        courseSelect.empty();
			                        courseSelect.append($('<option>', {
			                            value: '',
			                            text: '-- Lỗi tải dữ liệu --',
			                            disabled: true
			                        }));
			                    })
			                    .finally(() => {
			                        courseSelect.prop('disabled', false);
			                        courseSelect.trigger('change');
			                    });
			            }, 100);
			        }
			    }
			    
			    loadFilteredData();
			});
            
            $(document).on('change', '#khoa-hoc', loadFilteredData);
            
            // Cập nhật sự kiện cho dropdown chọn môn học có sẵn
            $(document).on('change', '#select-existing-subject', function() {
                if (this.value) {
                    handleUseExistingSubject();
                }
            });

            // Thêm cho chức năng chọn môn học có sẵn
            document.getElementById('btn-use-existing')?.addEventListener('click', function() {
		        const select = document.getElementById('select-existing-subject');
		        if (select && select.value) {
		            const selectedOption = select.options[select.selectedIndex];
		            const subjectData = selectedOption.getAttribute('data-subject');
		            
		            if (subjectData) {
		                try {
		                    const subject = JSON.parse(subjectData);
		                    fillSubjectFormFromExisting(subject);
		                } catch (e) {
		                    console.error('Error parsing subject data:', e);
		                }
		            }
		        } else {
		            alert('Vui lòng chọn một môn học từ danh sách');
		        }
		    });
			
            // Sự kiện cho nút Xóa lựa chọn
		    document.getElementById('btn-clear-selection')?.addEventListener('click', clearSubjectSelection);

            // Xử lý sự kiện cho nút sửa
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-sua')) {
                    const button = e.target.closest('.btn-sua');
                    const row = button.closest('tr');
                    const inputs = row.querySelectorAll('input');
                    const id = button.getAttribute('data-id');
                    const editables = row.querySelectorAll('input, select');
                    
                    // Chuyển đổi giữa chế độ chỉnh sửa và xem
                    if (button.innerHTML.includes('fa-edit')) {
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        button.classList.remove('text-blue-600');
                        button.classList.add('text-green-600');
                        button.title = 'Lưu thay đổi';
                        
                        const editables = row.querySelectorAll('input, select');
                        inputs.forEach(input => {
                            input.classList.add('border', 'border-blue-400', 'bg-white');
                            input.removeAttribute('readonly');
                            
                    		// Thêm sự kiện Enter để lưu nhanh (chỉ cho input)
                            
                            input.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    button.click();
                                }
                            });
                            
                        });
                    } else {
                        button.innerHTML = '<i class="fas fa-edit"></i>';
                        button.classList.remove('text-green-600');
                        button.classList.add('text-blue-600');
                        button.title = 'Sửa';
                        
                        let hasChanges = false;
                        const editables = row.querySelectorAll('input, select');
                        
                        editables.forEach(editable => {
                            editable.classList.remove('border', 'border-blue-400', 'bg-white');
                            
                            if (editable.tagName === 'SELECT') {
                                editable.disabled = true;
                            } else {
                                editable.setAttribute('readonly', true);
                            }
                            
                            // Gửi yêu cầu cập nhật đến server
                            const field = editable.getAttribute('data-field');
                            const value = editable.value;
                            const originalValue = editable.getAttribute('data-original-value');
                            
                            // Kiểm tra xem giá trị có thay đổi không
                            if (value !== originalValue) {
                                hasChanges = true;
                                
                                if (field && id) {
                                    if (field.startsWith('hk')) {
                                        const semester = parseInt(field.replace('hk', ''));
                                        updateSemesterAllocation(id, semester, value);
                                    } else {
                                        updateMonHoc(id, field, value);
                                    }
                                }
                            }
                            
                            // Cập nhật giá trị gốc mới
                            editable.setAttribute('data-original-value', value);
                        });
                        
                        if (hasChanges) {
                            console.log('Có thay đổi được gửi đến server');
							setTimeout(() => {
								loadFilteredData();
							}, 1000);
                        }
                    }
                }
                
                // Xử lý xóa môn học
                if (e.target.closest('.btn-xoa')) {
                    const button = e.target.closest('.btn-xoa');
                    const id = button.getAttribute('data-id');
                    if (id) {
                        deleteMonHoc(id);
                    }
                }
            });

            // Xử lý thêm chương trình đào tạo
            document.getElementById('btn-them')?.addEventListener('click', openThemChuongTrinhModal);
            
            // Đóng modal bằng nút hủy
            document.getElementById('btn-huy-chuong-trinh')?.addEventListener('click', closeThemChuongTrinhModal);
            
            // Đóng modal bằng nút X
            document.getElementById('btn-dong-chuong-trinh')?.addEventListener('click', closeThemChuongTrinhModal);
            
            // Lưu chương trình
            document.getElementById('btn-luu-chuong-trinh')?.addEventListener('click', createCurriculum);
            
            // Đóng modal khi click outside
            document.getElementById('modal-them-chuong-trinh').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeThemChuongTrinhModal();
                }
            });

            // Ngăn sự kiện click trong modal lan ra ngoài
            document.getElementById('form-them-chuong-trinh').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Kiểm tra modal sau khi load
            //setTimeout(fixModalInputs, 1000);
            
            /// Xử lý import Excel
            document.getElementById('btn-import').addEventListener('click', function() {
                console.log('Button Import clicked');
                openImportModal();
            });

            // Cập nhật dropdown sheet khi chọn file
            document.getElementById('excel-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const sheetSelect = document.getElementById('sheet-select');
                
                if (file) {
                    // Hiển thị loading
                    const originalHTML = sheetSelect.innerHTML;
                    sheetSelect.innerHTML = '<option value="">Đang tải danh sách sheet...</option>';
                    
                    getSheetNamesFromFile(file)
                        .then(sheetNames => {
                            sheetSelect.innerHTML = '<option value="">-- Tự động chọn sheet đầu tiên --</option>';
                            
                            sheetNames.forEach(sheetName => {
                                const option = document.createElement('option');
                                option.value = sheetName;
                                option.textContent = sheetName;
                                sheetSelect.appendChild(option);
                            });
                            
                            // Tự động chọn sheet đầu tiên nếu chỉ có một sheet
                            if (sheetNames.length === 1) {
                                sheetSelect.value = sheetNames[0];
                            }
                        })
                        .catch(error => {
                            console.error('Error loading sheet names:', error);
                            sheetSelect.innerHTML = originalHTML;
                            alert('Không thể đọc danh sách sheet từ file. Vui lòng kiểm tra định dạng file.');
                        });
                } else {
                    // Reset dropdown nếu không có file
                    sheetSelect.innerHTML = '<option value="">-- Tự động chọn sheet đầu tiên --</option>';
                }
            });
            
            // Đóng modal import bằng nút hủy
            document.getElementById('btn-huy-import')?.addEventListener('click', closeImportModal);
            // Đóng modal import bằng nút X
            document.getElementById('btn-dong-import')?.addEventListener('click', closeImportModal);
            
            // Lưu import
            document.getElementById('btn-luu-import')?.addEventListener('click', importExcel);

            // Đóng modal lỗi
            document.getElementById('btn-close-errors')?.addEventListener('click', closeImportErrorsModal);
            document.getElementById('btn-dong-errors')?.addEventListener('click', closeImportErrorsModal);

            // Đóng modal khi click outside
            document.getElementById('modal-import').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportModal();
                }
            });

            document.getElementById('modal-import-errors').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportErrorsModal();
                }
            });
            
            // Tải file mẫu
            document.getElementById('btn-download-template')?.addEventListener('click', function(e) {
                e.preventDefault();
                downloadTemplate();
            });
            
            // Xử lý nút cập nhật
            document.getElementById('btn-cap-nhat')?.addEventListener('click', function() {
                loadFilteredData();
                alert('Đã cập nhật dữ liệu');
            });
            
            // Thiết lập các ô input ban đầu là readonly
            document.querySelectorAll('input').forEach(input => {
                input.setAttribute('readonly', true);
            });

            // Xử lý thêm môn học
            document.getElementById('btn-them-mon-hoc')?.addEventListener('click', openThemMonHocModal);
            // Đóng modal bằng nút hủy
            document.getElementById('btn-huy-mon-hoc')?.addEventListener('click', closeThemMonHocModal);
            
            // Đóng modal bằng nút X
            document.getElementById('btn-dong-mon-hoc')?.addEventListener('click', closeThemMonHocModal);
            
            // Lưu môn học
            document.getElementById('btn-luu-mon-hoc').addEventListener('click', function(e) {
		        e.preventDefault();
		        e.stopPropagation();
		        createMonHoc();
		    });
            
            // Đóng modal khi click outside
            const modalThemMonHoc = document.getElementById('modal-them-mon-hoc');
            modalThemMonHoc.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeThemMonHocModal();
                }
            });
            // Prevent modal content clicks from closing modal
		    const modalContent = document.querySelector('#modal-them-mon-hoc > div');
		    if (modalContent) {
		        modalContent.addEventListener('click', function(e) {
		            e.stopPropagation();
		        });
		    }

			// ===== CRITICAL FIX: Force enable inputs when modal opens =====
		    // Observer to detect when modal becomes visible
		    const modalObserver = new MutationObserver(function(mutations) {
		        mutations.forEach(function(mutation) {
		            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
		                const modal = document.getElementById('modal-them-mon-hoc');
		                if (modal && !modal.classList.contains('hidden')) {
		                    console.log('Modal opened, enabling inputs...');
		                    
		                    // Small delay to ensure DOM is ready
		                    setTimeout(() => {
		                        enableModalInputs();
		                        
		                        // Also force select2 reinitialization
		                        if (typeof initializeSelect2ForSubjectModal === 'function') {
		                            setTimeout(initializeSelect2ForSubjectModal, 100);
		                        }
		                    }, 100);
		                }
		            }
		        });
		    });
		    
		    // Start observing the modal
		    const modal = document.getElementById('modal-them-mon-hoc');
		    if (modal) {
		        modalObserver.observe(modal, { attributes: true });
		    }
			
            
            // Cập nhật thông tin ngành khi chọn chương trình trong modal
            const themMonHocCurriculum = document.getElementById('them-mon-hoc-curriculum');
            if (themMonHocCurriculum) {
                themMonHocCurriculum.addEventListener('change', function() {
                    updateMajorInfo(this.value);
                });
            }
            
            // Lọc tổ bộ môn khi chọn đơn vị
            const departmentSelect = document.querySelector('select[name="department_id"]');
            if (departmentSelect) {
                departmentSelect.addEventListener('change', function() {
                    filterSubjectGroupsByDepartment(this.value);
                });
            }
            
            // Tự động tính tổng số giờ
            const hourInputs = ['theory_hours', 'practice_hours', 'tests_hours', 'exam_hours'];
            hourInputs.forEach(field => {
                const input = document.querySelector(`input[name="${field}"]`);
                if (input) {
                    input.addEventListener('input', function() {
                        calculateTotalHours();
                    });
                }
            });
            
            function calculateTotalHours() {
                const theory = parseInt(document.querySelector('input[name="theory_hours"]')?.value) || 0;
                const practice = parseInt(document.querySelector('input[name="practice_hours"]')?.value) || 0;
                const test = parseInt(document.querySelector('input[name="tests_hours"]')?.value) || 0;
                const exam = parseInt(document.querySelector('input[name="exam_hours"]')?.value) || 0;
                const total = theory + practice + test + exam;
                const totalInput = document.querySelector('input[name="total_hours"]');
                if (totalInput) {
                    totalInput.value = total || '';
                }
            }

            // Xử lý phím Enter trong modal
            document.addEventListener('keydown', function(e) {
                // ESC để đóng tất cả modal
                if (e.key === 'Escape') {
                    closeThemMonHocModal();
                    closeThemChuongTrinhModal();
                    closeImportModal();
                    closeImportErrorsModal();
                    document.body.classList.remove('overflow-hidden');
                }
                
                // Enter trong modal import (với Ctrl)
                if (!document.getElementById('modal-import').classList.contains('hidden')) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        importExcel();
                    }
                }
                
                // Enter trong modal thêm chương trình (với Ctrl)
                if (!document.getElementById('modal-them-chuong-trinh').classList.contains('hidden')) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        createCurriculum();
                    }
                }
                            
                if (!document.getElementById('modal-them-mon-hoc').classList.contains('hidden')) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        createMonHoc();
                    }
                }
            });
        });
    </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/i18n/vi.js"></script>
</body>
</html>

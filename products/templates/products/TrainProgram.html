<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Chương trình Đào tạo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .editable:focus {
            outline: 2px solid #3b82f6;
            background-color: #f0f9ff;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        /* Đảm bảo nội dung trong ô không bị tràn */
        table td, table th {
           overflow: hidden;
           text-overflow: ellipsis;
           white-space: nowrap;
        }

        .wrap-cell {
           white-space: normal;
           word-wrap: break-word;
        }

        /* Độ rộng cụ thể cho từng cột */
        .col-tt { width: 48px; }
        .col-ma { width: 80px; }
        .col-ten { width: 192px; min-width: 192px; }
        .col-tinchi { width: 64px; }
        .col-gio { width: 80px; }
        .col-lythuyet { width: 64px; }
        .col-thuchanh { width: 64px; }
        .col-kiemtra { width: 80px; }
        .col-hk { width: 48px; }
        .col-donvi { width: 128px; }
        .col-giangvien { width: 160px; }
        .col-thaotac { width: 80px; }
        
        /* Fix z-index cho tất cả modal và header */
        .fixed.inset-0 {
            z-index: 1000 !important;
        }
        
        /* Header table phải có z-index thấp hơn modal */
        .bg-gray-50.sticky {
            z-index: 10;
        }
        
        /* Modal backdrop */
        .bg-gray-600.bg-opacity-50 {
            z-index: 1000;
        }
        
        /* Modal content */
        .relative.top-10.mx-auto {
            z-index: 1001;
        }
        
        /* Đảm bảo modal không bị ảnh hưởng bởi các element khác */
        .modal-overlay {
            z-index: 1000;
            position: fixed;
        }
        
        /* Style cho input focus */
        input:focus, select:focus, textarea:focus {
            outline: none;
            ring: 2px;
            ring-color: #3b82f6;
        }
        
        /* Ngăn scroll body khi modal mở */
        body.modal-open {
            overflow: hidden;
        }

        /* Đảm bảo input trong modal có thể nhập */
        #modal-them-chuong-trinh input,
        #modal-them-chuong-trinh select,
        #modal-them-chuong-trinh textarea {
            background-color: white !important;
            cursor: text !important;
            pointer-events: auto !important;
        }
        
        /* Xóa mọi style có thể chặn input */
        #modal-them-chuong-trinh input:not([type="submit"]):not([type="button"]),
        #modal-them-chuong-trinh select,
        #modal-them-chuong-trinh textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        /* Đảm bảo modal không bị ảnh hưởng bởi các style khác */
        #modal-them-chuong-trinh {
            pointer-events: auto !important;
        }
        
        #modal-them-chuong-trinh * {
            pointer-events: auto !important;
        }

        /* Đảm bảo input trong modal có thể nhập */
        #modal-them-mon-hoc input,
        #modal-them-mon-hoc select,
        #modal-them-mon-hoc textarea {
            background-color: white !important;
            cursor: text !important;
            pointer-events: auto !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        /* Đảm bảo modal không bị ảnh hưởng bởi các style khác */
        #modal-them-mon-hoc {
            pointer-events: auto !important;
        }
        
        #modal-them-mon-hoc * {
            pointer-events: auto !important;
        }
        
        /* Fix cho các nút trong modal */
        #modal-them-mon-hoc button {
            cursor: pointer !important;
            pointer-events: auto !important;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-800">QUẢN LÝ CHƯƠNG TRÌNH ĐÀO TẠO</h1>
        
        <!-- Thông tin chung -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khoa đào tạo</label>
                    <select id="khoa-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn khoa --</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Tổ bộ môn</label>
                    <select id="to-bo-mon" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn tổ bộ môn --</option>
                        {% for group in subject_groups %}
                        <option value="{{ group.id }}" data-department="{{ group.department_id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Chương trình đào tạo</label>
                    <select id="chuong-trinh-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn chương trình --</option>
                        {% for curriculum in curricula %}
                        <option value="{{ curriculum.id }}">{{ curriculum.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khóa học</label>
                    <select id="khoa-hoc" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn khóa học --</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}" data-curriculum="{{ course.curriculum_id }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Nút chức năng -->
		<div class="flex flex-wrap justify-between mb-6">
			<div class="flex space-x-2 mb-4">
    			<button id="btn-them" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-plus mr-2"></i> Thêm chương trình đào tạo
    			</button>
    			<button id="btn-them-mon-hoc" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-book-medical mr-2"></i> Thêm môn học
    			</button>
    			<button id="btn-cap-nhat" class="bg-gray-600 hover:bg-gray-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-sync-alt mr-2"></i> Cập nhật
    			</button>
			</div>
    
			<div>
    			<button id="btn-import" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
        			<i class="fas fa-file-excel mr-2"></i> Import Excel
    			</button>
			</div>
		</div>

        <!-- Modal import Excel -->
        <div id="modal-import" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Import từ Excel</h3>
                    <button id="btn-dong-import" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="form-import" class="space-y-4" enctype="multipart/form-data">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                        <select id="import-curriculum" name="curriculum_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn chương trình --</option>
                            {% for curriculum in curricula %}
                            <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">File Excel *</label>
                        <input type="file" id="excel-file" name="excel_file" accept=".xlsx, .xls" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            required>
                        <p class="text-xs text-gray-500 mt-1">Chỉ chấp nhận file .xlsx hoặc .xls, tối đa 10MB</p>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p>
                            <a href="#" id="btn-download-template" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                                <i class="fas fa-download mr-2"></i>Tải file mẫu
                            </a>
                        </p>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                        <h4 class="text-sm font-semibold text-yellow-800 mb-2">Lưu ý khi import:</h4>
                        <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
                            <li>File Excel phải theo đúng định dạng mẫu</li>
                            <li>Các cột bắt buộc: Mã môn học, Tên học phần, Số tín chỉ</li>
                            <li>Mã môn học không được trùng trong cùng chương trình</li>
                        </ul>
                    </div>
                </form>
                
                <div class="flex justify-end mt-6 space-x-3">
                    <button id="btn-huy-import" type="button" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-times mr-2"></i>Hủy
                    </button>
                    <button id="btn-luu-import" type="button" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-upload mr-2"></i>Import Excel
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal hiển thị lỗi import -->
        <div id="modal-import-errors" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Chi tiết lỗi khi import</h3>
                    <button id="btn-dong-errors" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="import-errors-content" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded border">
                    <!-- Nội dung lỗi sẽ được điền ở đây -->
                </div>
                <div class="flex justify-end">
                    <button id="btn-close-errors" 
                            class="bg-blue-500 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                        <i class="fas fa-check mr-2"></i>Đóng
                    </button>
                </div>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200 table-fixed">
                    <thead class="bg-gray-50 sticky top-0" style="z-index: 10;">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">TT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Mã môn học</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Tên học phần</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Số tín chỉ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Tổng số giờ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Lý thuyết</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">Thực hành</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Kiểm tra/Thi</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK2</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider wg-12">HK3</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider wg-12">HK4</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK5</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">HK6</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-60">Đơn vị</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Giảng viên</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Thông tin tổng kết -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-gray-600">Tổng số tín chỉ</p>
                    <p id="tong-tin-chi" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tổng số giờ</p>
                    <p id="tong-gio" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tỷ lệ lý thuyết</p>
                    <p id="ty-le-ly-thuyet" class="text-xl font-bold text-blue-700">0%</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tỷ lệ thực hành</p>
                    <p id="ty-le-thuc-hanh" class="text-xl font-bold text-blue-700">0%</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục lưu trữ dữ liệu
        let allDepartments = {{ departments|safe }};
        let allSubjectGroups = {{ subject_groups|safe }};
        let allCurricula = {{ curricula|safe }};
        let allCourses = {{ courses|safe }};
        let allSubjectTypes = {{ subject_types|safe }};
        let allMajors = {{ majors|safe }};
        let monHocData = {{ mon_hoc_data|safe }};
        
        // Khởi tạo dropdowns
        function initializeDropdowns() {
            populateDropdown('khoa-dao-tao', allDepartments, 'name');
            populateDropdown('to-bo-mon', allSubjectGroups, 'name');
            populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
            populateDropdown('khoa-hoc', allCourses, 'name');
            populateDropdown('import-curriculum', allCurricula, 'name');
        }
        
        function populateDropdown(elementId, data, displayField) {
            const dropdown = document.getElementById(elementId);
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">-- Chọn --</option>';
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[displayField];
                if (item.academic_year) {
                    option.textContent += ` (${item.academic_year})`;
                }
                dropdown.appendChild(option);
            });
        }
        
        // Render bảng dữ liệu
		function renderTable() {
            const tableBody = document.getElementById('table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (monHocData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="17" class="px-4 py-4 text-center text-gray-500">Không có dữ liệu môn học</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            monHocData.forEach((monHoc, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-2 py-2 text-center text-sm col-tt">${index + 1}</td>
                    <td class="px-2 py-2 col-ma">
                        <input type="text" value="${monHoc.ma_mon_hoc || ''}" 
                            class="editable w-full bg-transparent border-none text-sm" 
                            data-field="code" data-id="${monHoc.id}" readonly
                            data-original-value="${monHoc.ma_mon_hoc || ''}">
                    </td>
                    <td class="px-2 py-2 col-ten wrap-cell">
                        <input type="text" value="${monHoc.ten_mon_hoc || ''}" 
                            class="editable w-full bg-transparent border-none text-sm" 
                            data-field="name" data-id="${monHoc.id}" readonly
                            data-original-value="${monHoc.ten_mon_hoc || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-tinchi">
                        <input type="number" value="${monHoc.so_tin_chi || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="credits" data-id="${monHoc.id}" readonly step="0.5" min="0"
                            data-original-value="${monHoc.so_tin_chi || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-gio">
                        <input type="number" value="${monHoc.tong_so_gio || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="total_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.tong_so_gio || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-lythuyet">
                        <input type="number" value="${monHoc.ly_thuyet || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="theory_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.ly_thuyet || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-thuchanh">
                        <input type="number" value="${monHoc.thuc_hanh || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="practice_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.thuc_hanh || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-kiemtra">
                        <input type="number" value="${monHoc.kiem_tra_thi || 0}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="exam_hours" data-id="${monHoc.id}" readonly min="0"
                            data-original-value="${monHoc.kiem_tra_thi || 0}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk1 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk1" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk1 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk2 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk2" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk2 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk3 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk3" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk3 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk4 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk4" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk4 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk5 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk5" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk5 || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-hk">
                        <input type="number" value="${monHoc.hk6 || ''}" 
                            class="editable w-full bg-transparent border-none text-sm text-center" 
                            data-field="hk6" data-id="${monHoc.id}" readonly step="0.5" min="0" placeholder="-"
                            data-original-value="${monHoc.hk6 || ''}">
                    </td>
                    <td class="px-2 py-2 col-donvi">
                        <input type="text" value="${monHoc.don_vi || ''}" 
                            class="editable w-full bg-transparent border-none text-sm" 
                            data-field="department" data-id="${monHoc.id}" readonly
                            data-original-value="${monHoc.don_vi || ''}">
                    </td>
                    <td class="px-2 py-2 col-giangvien">
                        <input type="text" value="${monHoc.giang_vien || ''}" 
                            class="editable w-full bg-transparent border-none text-sm" 
                            data-field="instructor" data-id="${monHoc.id}" readonly
                            data-original-value="${monHoc.giang_vien || ''}">
                    </td>
                    <td class="px-2 py-2 text-center col-thaotac">
                        <button class="btn-sua text-blue-600 hover:text-blue-900 mr-2" data-id="${monHoc.id}" title="Sửa">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-xoa text-red-600 hover:text-red-900" data-id="${monHoc.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Cập nhật thống kê
            updateStatistics();
        }
        
        // Cập nhật thống kê
        function updateStatistics() {
            const totalCredits = monHocData.reduce((sum, item) => sum + (parseFloat(item.so_tin_chi) || 0), 0);
            const totalHours = monHocData.reduce((sum, item) => sum + (parseInt(item.tong_so_gio) || 0), 0);
            const totalTheory = monHocData.reduce((sum, item) => sum + (parseInt(item.ly_thuyet) || 0), 0);
            const totalPractice = monHocData.reduce((sum, item) => sum + (parseInt(item.thuc_hanh) || 0), 0);
            
            const tyLeLyThuyet = totalHours > 0 ? (totalTheory / totalHours * 100).toFixed(1) : 0;
            const tyLeThucHanh = totalHours > 0 ? (totalPractice / totalHours * 100).toFixed(1) : 0;
            
            document.getElementById('tong-tin-chi').textContent = totalCredits.toFixed(1);
            document.getElementById('tong-gio').textContent = totalHours;
            document.getElementById('ty-le-ly-thuyet').textContent = `${tyLeLyThuyet}%`;
            document.getElementById('ty-le-thuc-hanh').textContent = `${tyLeThucHanh}%`;
        }
        
        // Load dữ liệu theo bộ lọc
        function loadFilteredData() {
            const departmentId = document.getElementById('khoa-dao-tao').value;
            const subjectGroupId = document.getElementById('to-bo-mon').value;
            const curriculumId = document.getElementById('chuong-trinh-dao-tao').value;
            const courseId = document.getElementById('khoa-hoc').value;
            
            let url = '/api/subjects/?';
            const params = [];
            
            if (curriculumId) params.push(`curriculum_id=${curriculumId}`);
            if (departmentId) params.push(`department_id=${departmentId}`);
            if (subjectGroupId) params.push(`subject_group_id=${subjectGroupId}`);
            if (courseId) params.push(`course_id=${courseId}`);
            
            url += params.join('&');
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    monHocData = data;
                    renderTable();
                    
                    // Load thống kê nếu có curriculum
                    if (curriculumId) {
                        loadThongKe(curriculumId);
                    } else {
                        updateStatistics();
                    }
                })
                .catch(error => {
                    console.error('Error loading filtered data:', error);
                    alert('Có lỗi xảy ra khi tải dữ liệu');
                });
        }
        
        // Load thống kê
        function loadThongKe(curriculumId) {
            fetch(`/thong-ke/?curriculum_id=${curriculumId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tong-tin-chi').textContent = data.tong_tin_chi;
                    document.getElementById('tong-gio').textContent = data.tong_gio;
                    document.getElementById('ty-le-ly-thuyet').textContent = data.ty_le_ly_thuyet;
                    document.getElementById('ty-le-thuc-hanh').textContent = data.ty_le_thuc_hanh;
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    updateStatistics();
                });
        }

		// Cập nhật môn học
        function updateMonHoc(id, field, value) {
            // Bỏ qua nếu giá trị không thay đổi hoặc là trường instructor
            if (field === 'instructor') {
                console.log('Trường instructor được bỏ qua');
                return;
            }
            
            const data = {
                id: id,
                field: field,
                value: value
            };
            
            console.log('Sending update request:', data); // Debug log
            
            fetch(`/train-program/${id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Update error:', data.message);
                    alert('Có lỗi khi cập nhật: ' + data.message);
                    // Reload data to reset values
                    loadFilteredData();
                } else {
                    console.log('Update success:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật: ' + error.message);
                loadFilteredData();
            });
        }

        // Cập nhật phân bố học kỳ
        function updateSemesterAllocation(subjectId, semester, credits) {
            const data = {
                id: subjectId,
                field: `hk${semester}`,
                value: credits
            };
            
            console.log('Sending semester update:', data); // Debug log
            
            fetch(`/train-program/${subjectId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status !== 'success') {
                    console.error('Semester update error:', data.message);
                    alert('Có lỗi khi cập nhật học kỳ: ' + data.message);
                    // Reload data to reset values
                    loadFilteredData();
                } else {
                    console.log('Semester update success:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật học kỳ: ' + error.message);
                loadFilteredData();
            });
        }
        
        // Xóa môn học
        function deleteMonHoc(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa môn học này?')) {
                return;
            }
            
            fetch(`/train-program/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã xóa môn học thành công');
                    loadFilteredData();
                } else {
                    alert('Có lỗi khi xóa: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa');
            });
        }
        
        // Tạo chương trình đào tạo mới
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Validate
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã tạo chương trình đào tạo thành công');
                    document.getElementById('modal-them-chuong-trinh').classList.add('hidden');
                    form.reset();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tạo chương trình');
            });
        }
        
        // Mở modal import Excel
        function openImportModal() {
            document.getElementById('modal-import').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        // Đóng modal import Excel
        function closeImportModal() {
            document.getElementById('modal-import').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            document.getElementById('form-import').reset();
        }

        // Mở modal lỗi import
        function openImportErrorsModal() {
            document.getElementById('modal-import-errors').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        // Đóng modal lỗi import
        function closeImportErrorsModal() {
            document.getElementById('modal-import-errors').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // Hiển thị lỗi import
        function showImportErrors(errors) {
            const errorsContent = document.getElementById('import-errors-content');
            if (errors && errors.length > 0) {
                errorsContent.innerHTML = `
                    <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded">
                        <h4 class="font-semibold text-red-800 mb-2">Có ${errors.length} lỗi cần xem xét:</h4>
                    </div>
                    <div class="space-y-2">
                        ${errors.map(error => 
                            `<div class="flex items-start text-red-700 py-2 border-b border-red-100">
                                <i class="fas fa-exclamation-circle mt-1 mr-2 text-red-500 flex-shrink-0"></i>
                                <span class="text-sm">${error}</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
            } else {
                errorsContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <div class="text-green-600 font-semibold">Không có lỗi nào trong quá trình import</div>
                    </div>
                `;
            }
            openImportErrorsModal();
        }

        // Import Excel với xử lý lỗi chi tiết
        function importExcel() {
            const form = document.getElementById('form-import');
            const formData = new FormData(form);
            const curriculumId = document.getElementById('import-curriculum').value;
            const fileInput = document.getElementById('excel-file');
            
            if (!curriculumId) {
                alert('Vui lòng chọn chương trình đào tạo');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file Excel');
                return;
            }
            
            // Hiển thị loading
            const importBtn = document.getElementById('btn-luu-import');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
            importBtn.disabled = true;
            
            fetch('/import-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ ' + data.message);
                    closeImportModal();
                    
                    // Hiển thị chi tiết lỗi nếu có
                    if (data.data && data.data.errors && data.data.errors.length > 0) {
                        showImportErrors(data.data.errors);
                    }
                    
                    // Reload data
                    loadFilteredData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi import file: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            });
        }

        // Tải file mẫu
        function downloadTemplate() {
            window.open('/download-excel-template/', '_blank');
        }
        
        // Load lại danh sách curricula
        function loadCurricula() {
            fetch('/api/curricula/')
                .then(response => response.json())
                .then(data => {
                    allCurricula = data;
                    populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
                    populateDropdown('import-curriculum', allCurricula, 'name');
                })
                .catch(error => {
                    console.error('Error loading curricula:', error);
                });
        }
        
        // Mở modal thêm chương trình
        function openThemChuongTrinhModal() {
            const modal = document.getElementById('modal-them-chuong-trinh');
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Đảm bảo các input có thể nhập
            setTimeout(() => {
                const inputs = modal.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                    input.style.pointerEvents = 'auto';
                    input.style.userSelect = 'auto';
                });
                
                // Focus vào input đầu tiên
                const firstInput = modal.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }
            }, 100);
        }

        // Đóng modal thêm chương trình
        function closeThemChuongTrinhModal() {
            const modal = document.getElementById('modal-them-chuong-trinh');
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            
            // Reset form
            const form = document.getElementById('form-them-chuong-trinh');
            if (form) {
                form.reset();
            }
        }

        // Hàm kiểm tra và sửa lỗi input trong modal
        function fixModalInputs() {
            const modal = document.getElementById('modal-them-chuong-trinh');
            if (!modal) return;
            
            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                // Xóa các attribute chặn input
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
                
                // Đảm bảo các thuộc tính style đúng
                input.style.pointerEvents = 'auto';
                input.style.userSelect = 'auto';
                input.style.backgroundColor = 'white';
                input.style.cursor = 'text';
                
                // Thêm event listener để debug
                input.addEventListener('click', function(e) {
                    e.stopPropagation();
                    console.log('Input clicked:', this.name);
                });
                
                input.addEventListener('focus', function(e) {
                    e.stopPropagation();
                    console.log('Input focused:', this.name);
                    this.style.borderColor = '#3b82f6';
                    this.style.boxShadow = '0 0 0 2px rgba(59, 130, 246, 0.2)';
                });
                
                input.addEventListener('blur', function(e) {
                    e.stopPropagation();
                    this.style.borderColor = '#d1d5db';
                    this.style.boxShadow = 'none';
                });
            });
        }

        // Tạo chương trình đào tạo mới
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            if (!form) {
                console.error('Form not found');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            console.log('Form data:', data);
            
            // Validate dữ liệu
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }
            
            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-chuong-trinh');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo chương trình đào tạo thành công!');
                    closeThemChuongTrinhModal();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi tạo chương trình: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Mở modal thêm môn học
        function openThemMonHocModal() {
            const modal = document.getElementById('modal-them-mon-hoc');
            if (!modal) {
                console.error('Modal them mon hoc not found');
                return;
            }
            
            const selectedCurriculumId = document.getElementById('chuong-trinh-dao-tao').value;
            
            // Nếu đã chọn chương trình từ dropdown, set giá trị mặc định
            if (selectedCurriculumId) {
                const curriculumSelect = document.getElementById('them-mon-hoc-curriculum');
                if (curriculumSelect) {
                    curriculumSelect.value = selectedCurriculumId;
                    // Cập nhật thông tin ngành đào tạo
                    updateMajorInfo(selectedCurriculumId);
                }
            }
            
            // Reset form và mở modal
            const form = document.getElementById('form-them-mon-hoc');
            if (form) {
                form.reset();
            }
            
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Đảm bảo các input có thể nhập
            setTimeout(() => {
                const inputs = modal.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.removeAttribute('disabled');
                    input.style.pointerEvents = 'auto';
                    input.style.userSelect = 'auto';
                    input.style.cursor = 'text';
                });
                
                // Focus vào input đầu tiên
                const firstInput = modal.querySelector('input[name="code"]');
                if (firstInput) {
                    firstInput.focus();
                    firstInput.select();
                }
            }, 100);
        }

        // Đóng modal thêm môn học
        function closeThemMonHocModal() {
            const modal = document.getElementById('modal-them-mon-hoc');
            if (modal) {
                modal.classList.add('hidden');
            }
            document.body.classList.remove('overflow-hidden');
        }

        // Cập nhật thông tin ngành đào tạo khi chọn chương trình
        function updateMajorInfo(curriculumId) {
            const majorField = document.getElementById('them-mon-hoc-major');
            if (!majorField || !curriculumId) {
                return;
            }
            
            // Tìm thông tin chương trình
            const curriculum = allCurricula.find(c => c.id == curriculumId);
            if (curriculum && curriculum.major_id) {
                const major = allMajors.find(m => m.id == curriculum.major_id);
                if (major) {
                    majorField.value = `${major.name} (${major.code})`;
                    return;
                }
            }
            majorField.value = 'Không xác định';
        }

        // Tạo môn học mới
        function createMonHoc() {
            const form = document.getElementById('form-them-mon-hoc');
            if (!form) {
                console.error('Form them mon hoc not found');
                alert('Không tìm thấy form thêm môn học');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
                        
            // Validate dữ liệu
            if (!data.curriculum_id || !data.code || !data.name || !data.credits || !data.subject_type_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc (*)');
                return;
            }
            
            // Chuẩn bị dữ liệu học kỳ
            const semesterData = {};
            for (let i = 1; i <= 6; i++) {
                const hkValue = data[`hk${i}`];
                if (hkValue && hkValue !== '') {
                    try {
                        semesterData[`hk${i}`] = parseFloat(hkValue);
                    } catch (e) {
                        console.error(`Error parsing HK${i} value:`, hkValue);
                    }
                }
            }
            
            // Chuẩn bị dữ liệu gửi đi
            const postData = {
                ...data,
                semester_allocations: semesterData,
                is_elective: document.getElementById('is_elective').checked
            };
                        
            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-mon-hoc');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;
            
            fetch('/api/subjects/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(postData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo môn học thành công!');
                    closeThemMonHocModal();
                    // Reload dữ liệu
                    loadFilteredData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                alert('❌ Có lỗi xảy ra khi tạo môn học: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Lọc tổ bộ môn theo khoa
        function filterSubjectGroupsByDepartment(departmentId) {
            const subjectGroupSelect = document.querySelector('select[name="subject_group_id"]');
            if (!subjectGroupSelect) return;
            
            const options = subjectGroupSelect.querySelectorAll('option');
            
            options.forEach(option => {
                if (option.value === '') return; // Giữ option "-- Chọn tổ bộ môn --"
                
                const optionDepartmentId = option.getAttribute('data-department');
                if (!departmentId || optionDepartmentId == departmentId) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Reset selection nếu option hiện tại bị ẩn
            if (subjectGroupSelect.value) {
                const selectedOption = subjectGroupSelect.querySelector(`option[value="${subjectGroupSelect.value}"]`);
                if (selectedOption && selectedOption.style.display === 'none') {
                    subjectGroupSelect.value = '';
                }
            }
        }

        // Thêm hàm để tải danh sách môn học có sẵn
        function loadExistingSubjects() {
            fetch('/api/all-subjects/')
                .then(response => response.json())
                .then(subjects => {
                    const select = document.getElementById('select-existing-subject');
                    select.innerHTML = '<option value="">-- Chọn môn học có sẵn --</option>';
                    
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.id;
                        option.textContent = `${subject.code} - ${subject.name}`;
                        option.setAttribute('data-name', subject.name);
                        option.setAttribute('data-code', subject.code);
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading existing subjects:', error);
                });
        }

        // Hàm xử lý khi chọn môn học có sẵn
        function handleUseExistingSubject() {
            const select = document.getElementById('select-existing-subject');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                alert('Vui lòng chọn một môn học');
                return;
            }
            
            // Hiển thị thông tin môn học đã chọn
            document.getElementById('existing-subject-info').classList.remove('hidden');
            document.getElementById('selected-subject-name').textContent = 
                `${selectedOption.getAttribute('data-code')} - ${selectedOption.getAttribute('data-name')}`;
            
            // Điền thông tin vào form
            document.querySelector('input[name="code"]').value = selectedOption.getAttribute('data-code');
            document.querySelector('input[name="name"]').value = selectedOption.getAttribute('data-name');
            
            // Disable các trường mã và tên để tránh chỉnh sửa
            document.querySelector('input[name="code"]').setAttribute('readonly', 'true');
            document.querySelector('input[name="name"]').setAttribute('readonly', 'true');
        }

        // Hàm xóa lựa chọn
        function clearSubjectSelection() {
            document.getElementById('existing-subject-info').classList.add('hidden');
            document.getElementById('select-existing-subject').value = '';
            document.querySelector('input[name="code"]').removeAttribute('readonly');
            document.querySelector('input[name="name"]').removeAttribute('readonly');
            document.querySelector('input[name="code"]').value = '';
            document.querySelector('input[name="name"]').value = '';
        }

        // Hàm lấy CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Xử lý sự kiện khi trang tải xong
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropdowns();
            renderTable();
            
            console.log('DOM loaded - checking modal inputs...');
    
            // Kiểm tra các input trong modal
            const modalInputs = document.querySelectorAll('#modal-them-chuong-trinh input, #modal-them-chuong-trinh select, #modal-them-chuong-trinh textarea');
            console.log('Found inputs in modal:', modalInputs.length);
            
            modalInputs.forEach(input => {
                console.log('Input:', input.name, 'Type:', input.type, 'Readonly:', input.readOnly, 'Disabled:', input.disabled);
                
                // Xóa các attribute có thể chặn input
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
                
                // Thêm event listener để debug
                input.addEventListener('focus', function() {
                    console.log('Input focused:', this.name);
                });
                
                input.addEventListener('input', function() {
                    console.log('Input changed:', this.name, 'Value:', this.value);
                });
            });

            // Xử lý sự kiện thay đổi dropdown
            document.getElementById('khoa-dao-tao').addEventListener('change', function() {
                const departmentId = this.value;
                
                // Reset các dropdown phía sau
                document.getElementById('to-bo-mon').value = '';
                document.getElementById('chuong-trinh-dao-tao').value = '';
                document.getElementById('khoa-hoc').value = '';
                
                // Load subject groups theo department
                if (departmentId) {
                    fetch(`/api/subject-groups/?department_id=${departmentId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown('to-bo-mon', data, 'name');
                        });
                } else {
                    populateDropdown('to-bo-mon', allSubjectGroups, 'name');
                }
                
                loadFilteredData();
            });
            
            document.getElementById('to-bo-mon').addEventListener('change', function() {
                document.getElementById('chuong-trinh-dao-tao').value = '';
                document.getElementById('khoa-hoc').value = '';
                loadFilteredData();
            });
            
            document.getElementById('chuong-trinh-dao-tao').addEventListener('change', function() {
                const curriculumId = this.value;
                document.getElementById('khoa-hoc').value = '';
                
                if (curriculumId) {
                    fetch(`/api/courses/?curriculum_id=${curriculumId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown('khoa-hoc', data, 'name');
                        });
                } else {
                    populateDropdown('khoa-hoc', allCourses, 'name');
                }
                
                loadFilteredData();
            });
            
            document.getElementById('khoa-hoc').addEventListener('change', loadFilteredData);
            
            // Xử lý sự kiện cho nút sửa
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-sua')) {
                    const button = e.target.closest('.btn-sua');
                    const row = button.closest('tr');
                    const inputs = row.querySelectorAll('input');
                    const id = button.getAttribute('data-id');
                    
                    // Chuyển đổi giữa chế độ chỉnh sửa và xem
                    if (button.innerHTML.includes('fa-edit')) {
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        button.classList.remove('text-blue-600');
                        button.classList.add('text-green-600');
                        button.title = 'Lưu thay đổi';
                        
                        inputs.forEach(input => {
                            input.classList.add('border', 'border-blue-400', 'bg-white');
                            input.removeAttribute('readonly');
                            
                            // Thêm sự kiện Enter để lưu nhanh
                            input.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    button.click(); // Kích hoạt nút lưu
                                }
                            });
                        });
                    } else {
                        button.innerHTML = '<i class="fas fa-edit"></i>';
                        button.classList.remove('text-green-600');
                        button.classList.add('text-blue-600');
                        button.title = 'Sửa';
                        
                        let hasChanges = false;
                        
                        inputs.forEach(input => {
                            input.classList.remove('border', 'border-blue-400', 'bg-white');
                            input.setAttribute('readonly', true);
                            
                            // Gửi yêu cầu cập nhật đến server
                            const field = input.getAttribute('data-field');
                            const value = input.value;
                            const originalValue = input.getAttribute('data-original-value');
                            
                            // Kiểm tra xem giá trị có thay đổi không
                            if (value !== originalValue) {
                                hasChanges = true;
                                
                                if (field && id) {
                                    if (field.startsWith('hk')) {
                                        // Xử lý cập nhật học kỳ
                                        const semester = parseInt(field.replace('hk', ''));
                                        updateSemesterAllocation(id, semester, value);
                                    } else {
                                        // Xử lý cập nhật các trường khác
                                        updateMonHoc(id, field, value);
                                    }
                                }
                            }
                            
                            // Cập nhật giá trị gốc mới
                            input.setAttribute('data-original-value', value);
                        });
                        
                        if (hasChanges) {
                            console.log('Có thay đổi được gửi đến server');
                        }
                    }
                }
                
                // Xử lý xóa môn học
                if (e.target.closest('.btn-xoa')) {
                    const button = e.target.closest('.btn-xoa');
                    const id = button.getAttribute('data-id');
                    if (id) {
                        deleteMonHoc(id);
                    }
                }
            });
                
            // Xử lý thêm chương trình đào tạo
            document.getElementById('btn-them').addEventListener('click', function() {
                openThemChuongTrinhModal();
                // Sửa lỗi input sau khi mở modal
                setTimeout(fixModalInputs, 50);
            });

            // Xử lý thêm chương trình đào tạo
            document.getElementById('btn-them').addEventListener('click', openThemChuongTrinhModal);
            
            // Đóng modal bằng nút hủy
            document.getElementById('btn-huy-chuong-trinh').addEventListener('click', closeThemChuongTrinhModal);
            
            // Đóng modal bằng nút X
            document.getElementById('btn-dong-chuong-trinh').addEventListener('click', closeThemChuongTrinhModal);
            
            // Lưu chương trình
            document.getElementById('btn-luu-chuong-trinh').addEventListener('click', createCurriculum);
            
            // Đóng modal khi click outside
            document.getElementById('modal-them-chuong-trinh').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeThemChuongTrinhModal();
                }
            });

            // Ngăn sự kiện click trong modal lan ra ngoài
            document.getElementById('form-them-chuong-trinh').addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Kiểm tra modal sau khi load
            setTimeout(fixModalInputs, 1000);
            
            /// Xử lý import Excel
            document.getElementById('btn-import').addEventListener('click', openImportModal);
            
            // Đóng modal import bằng nút hủy
            document.getElementById('btn-huy-import').addEventListener('click', closeImportModal);
            // Đóng modal import bằng nút X
            document.getElementById('btn-dong-import').addEventListener('click', closeImportModal);
            
            // Lưu import
            document.getElementById('btn-luu-import').addEventListener('click', importExcel);

            // Đóng modal lỗi
            document.getElementById('btn-close-errors').addEventListener('click', closeImportErrorsModal);
            document.getElementById('btn-dong-errors').addEventListener('click', closeImportErrorsModal);

            // Đóng modal khi click outside
            document.getElementById('modal-import').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportModal();
                }
            });

            document.getElementById('modal-import-errors').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportErrorsModal();
                }
            });
            
            // Tải file mẫu
            document.getElementById('btn-download-template').addEventListener('click', function(e) {
                e.preventDefault();
                downloadTemplate();
            });
            
            // Xử lý nút cập nhật
            document.getElementById('btn-cap-nhat').addEventListener('click', function() {
                loadFilteredData();
                alert('Đã cập nhật dữ liệu');
            });
            
            // Thiết lập các ô input ban đầu là readonly
            document.querySelectorAll('input').forEach(input => {
                input.setAttribute('readonly', true);
            });

            // Xử lý thêm môn học
            const btnThemMonHoc = document.getElementById('btn-them-mon-hoc');
            if (btnThemMonHoc) {
                btnThemMonHoc.addEventListener('click', openThemMonHocModal);
                console.log('Registered event for btn-them-mon-hoc');
            } else {
                console.error('Button them mon hoc not found');
            }
            
            // Đóng modal bằng nút hủy
            const btnHuyMonHoc = document.getElementById('btn-huy-mon-hoc');
            if (btnHuyMonHoc) {
                btnHuyMonHoc.addEventListener('click', closeThemMonHocModal);
                console.log('Registered event for btn-huy-mon-hoc');
            } else {
                console.error('Button huy mon hoc not found');
            }
            
            // Đóng modal bằng nút X
            const btnDongMonHoc = document.getElementById('btn-dong-mon-hoc');
            if (btnDongMonHoc) {
                btnDongMonHoc.addEventListener('click', closeThemMonHocModal);
                console.log('Registered event for btn-dong-mon-hoc');
            } else {
                console.error('Button dong mon hoc not found');
            }
            
            // Lưu môn học
            const btnLuuMonHoc = document.getElementById('btn-luu-mon-hoc');
            if (btnLuuMonHoc) {
                btnLuuMonHoc.addEventListener('click', createMonHoc);
                console.log('Registered event for btn-luu-mon-hoc');
            } else {
                console.error('Button luu mon hoc not found');
            }
            
            // Đóng modal khi click outside
            const modalThemMonHoc = document.getElementById('modal-them-mon-hoc');
            if (modalThemMonHoc) {
                modalThemMonHoc.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeThemMonHocModal();
                    }
                });
                console.log('Registered outside click for modal-them-mon-hoc');
            } else {
                console.error('Modal them mon hoc not found');
            }
            
            // Cập nhật thông tin ngành khi chọn chương trình trong modal
            const themMonHocCurriculum = document.getElementById('them-mon-hoc-curriculum');
            if (themMonHocCurriculum) {
                themMonHocCurriculum.addEventListener('change', function() {
                    updateMajorInfo(this.value);
                });
            }
            
            // Lọc tổ bộ môn khi chọn đơn vị
            const departmentSelect = document.querySelector('select[name="department_id"]');
            if (departmentSelect) {
                departmentSelect.addEventListener('change', function() {
                    filterSubjectGroupsByDepartment(this.value);
                });
            }
            
            // Tự động tính tổng số giờ
            const hourInputs = ['theory_hours', 'practice_hours', 'exam_hours'];
            hourInputs.forEach(field => {
                const input = document.querySelector(`input[name="${field}"]`);
                if (input) {
                    input.addEventListener('input', function() {
                        calculateTotalHours();
                    });
                }
            });

            // Thêm cho chức năng chọn môn học có sẵn
            document.getElementById('btn-use-existing').addEventListener('click', handleUseExistingSubject);
            document.getElementById('btn-clear-selection').addEventListener('click', clearSubjectSelection);
            
            // Tải danh sách môn học có sẵn khi mở modal
            document.getElementById('btn-them-mon-hoc').addEventListener('click', function() {
                setTimeout(loadExistingSubjects, 100);
            });
            
            function calculateTotalHours() {
                const theory = parseInt(document.querySelector('input[name="theory_hours"]')?.value) || 0;
                const practice = parseInt(document.querySelector('input[name="practice_hours"]')?.value) || 0;
                const exam = parseInt(document.querySelector('input[name="exam_hours"]')?.value) || 0;
                const total = theory + practice + exam;
                const totalInput = document.querySelector('input[name="total_hours"]');
                if (totalInput) {
                    totalInput.value = total || '';
                }
            }

            // Xử lý phím Enter trong modal
            document.addEventListener('keydown', function(e) {
                // ESC để đóng tất cả modal
                if (e.key === 'Escape') {
                    closeThemMonHocModal();
                    closeThemChuongTrinhModal();
                    closeImportModal();
                    closeImportErrorsModal();
                    document.body.classList.remove('overflow-hidden');
                }
                
                // Enter trong modal import (với Ctrl)
                if (!document.getElementById('modal-import').classList.contains('hidden')) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        importExcel();
                    }
                }
                
                // Enter trong modal thêm chương trình (với Ctrl)
                if (!document.getElementById('modal-them-chuong-trinh').classList.contains('hidden')) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        createCurriculum();
                    }
                }
                            
                if (!document.getElementById('modal-them-mon-hoc').classList.contains('hidden')) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        createMonHoc();
                    }
                }
            });
        });
    </script>


	<!-- Modal thêm môn học -->
	<div id="modal-them-mon-hoc" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
		<div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
    		<div class="flex justify-between items-center mb-4">
        		<h3 class="text-xl font-bold text-gray-900">Thêm môn học mới</h3>
        		<button type="button" id="btn-dong-mon-hoc" class="text-gray-500 hover:text-gray-700">
            		<i class="fas fa-times text-xl"></i>
        		</button>
    		</div>
        
    		<form id="form-them-mon-hoc" class="space-y-4">
        		<!-- Thông tin chương trình -->
        		<div class="bg-blue-50 p-4 rounded-md">
            		<h4 class="text-sm font-semibold text-blue-800 mb-2">Thông tin chương trình đào tạo</h4>
            		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                		<div>
                    		<label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                    		<select id="them-mon-hoc-curriculum" name="curriculum_id" 
                            		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            		required>
                        		<option value="">-- Chọn chương trình --</option>
                        		{% for curriculum in curricula %}
                        		<option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                        		{% endfor %}
                    		</select>
                		</div>
                		<div>
                    		<label class="block text-gray-700 text-sm font-bold mb-2">Ngành đào tạo</label>
                    		<input type="text" id="them-mon-hoc-major" 
                            		class="w-full p-3 border border-gray-300 rounded-md bg-gray-100" 
                            		readonly>
                		</div>
            		</div>
        		</div>

        		<!-- Thông tin cơ bản môn học -->
        		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Mã môn học *</label>
                		<input type="text" name="code" 
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="Vd: MH01"
                        		required
                        		autocomplete="off">
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Tên môn học *</label>
                		<input type="text" name="name" 
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="Vd: Giáo dục chính trị"
                        		required
                        		autocomplete="off">
            		</div>
        		</div>

        		<!-- Số tín chỉ và giờ -->
        		<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Số tín chỉ *</label>
                		<input type="number" name="credits" step="0.5" min="0" max="10"
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="0"
                        		required
                        		autocomplete="off">
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Tổng số giờ</label>
                		<input type="number" name="total_hours" min="0"
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="0"
                        		autocomplete="off">
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Lý thuyết</label>
                		<input type="number" name="theory_hours" min="0"
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="0"
                        		autocomplete="off">
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Thực hành</label>
                		<input type="number" name="practice_hours" min="0"
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="0"
                        		autocomplete="off">
            		</div>
        		</div>

        		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Kiểm tra/Thi</label>
                		<input type="number" name="exam_hours" min="0"
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="0"
                        		autocomplete="off">
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Thứ tự</label>
                		<input type="number" name="order_number" min="0"
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		placeholder="0"
                        		autocomplete="off">
            		</div>
        		</div>

        		<!-- Phân bố học kỳ -->
        		<div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
            		<h4 class="text-sm font-semibold text-yellow-800 mb-3">Phân bố học kỳ (số tín chỉ)</h4>
            		<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                		{% for i in "123456" %}
                		<div>
                    		<label class="block text-gray-700 text-sm font-medium mb-1">Học kỳ {{ i }}</label>
                    		<input type="number" name="hk{{ i }}" step="0.5" min="0" max="10"
                            		class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center" 
                            		placeholder="-"
                            		autocomplete="off">
                		</div>
                		{% endfor %}
            		</div>
        		</div>

        		<!-- Thông tin bổ sung -->
        		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Đơn vị quản lý</label>
                		<select name="department_id" 
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    		<option value="">-- Chọn đơn vị --</option>
                    		{% for department in departments %}
                    		<option value="{{ department.id }}">{{ department.name }}</option>
                    		{% endfor %}
                		</select>
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Loại môn *</label>
                		<select name="subject_type_id" 
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        		required>
                    		<option value="">-- Chọn loại môn --</option>
                    		{% for subject_type in subject_types %}
                    		<option value="{{ subject_type.id }}">{{ subject_type.name }}</option>
                    		{% endfor %}
                		</select>
            		</div>
        		</div>

        		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Tổ bộ môn</label>
                		<select name="subject_group_id" 
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    		<option value="">-- Chọn tổ bộ môn --</option>
                    		{% for subject_group in subject_groups %}
                    		<option value="{{ subject_group.id }}" data-department="{{ subject_group.department_id }}">{{ subject_group.name }}</option>
                    		{% endfor %}
                		</select>
            		</div>
            		<div>
                		<label class="block text-gray-700 text-sm font-bold mb-2">Học kỳ mặc định</label>
                		<select name="semester" 
                        		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    		<option value="">-- Chọn học kỳ --</option>
                    		{% for i in "123456" %}
                    		<option value="{{ i }}">Học kỳ {{ i }}</option>
                    		{% endfor %}
                		</select>
            		</div>
        		</div>

        		<div>
            		<label class="block text-gray-700 text-sm font-bold mb-2">Mô tả môn học</label>
            		<textarea name="description" 
                        	class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        	rows="3"
                        	placeholder="Nhập mô tả về môn học..."
                        	autocomplete="off"></textarea>
        		</div>

        		<div>
            		<label class="block text-gray-700 text-sm font-bold mb-2">Điều kiện tiên quyết</label>
            		<textarea name="prerequisites" 
                        	class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        	rows="2"
                        	placeholder="Nhập điều kiện tiên quyết (nếu có)..."
                        	autocomplete="off"></textarea>
        		</div>

        		<div>
            		<label class="block text-gray-700 text-sm font-bold mb-2">Chuẩn đầu ra</label>
            		<textarea name="learning_outcomes" 
                        	class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                        	rows="2"
                        	placeholder="Nhập chuẩn đầu ra của môn học..."
                        	autocomplete="off"></textarea>
        		</div>

        		<!-- Thông tin môn tự chọn -->
        		<div class="bg-green-50 p-4 rounded-md border border-green-200">
            		<h4 class="text-sm font-semibold text-green-800 mb-3">Thông tin môn tự chọn (nếu có)</h4>
            		<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                		<div class="flex items-center">
                    		<input type="checkbox" name="is_elective" id="is_elective" 
                            		class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    		<label for="is_elective" class="ml-2 block text-sm text-gray-700 font-medium">
                        		Là môn tự chọn
                    		</label>
                		</div>
                		<div>
                    		<label class="block text-gray-700 text-sm font-bold mb-2">Nhóm môn tự chọn</label>
                    		<input type="text" name="elective_group" 
                            		class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            		placeholder="Vd: Nhóm 1"
                            		autocomplete="off">
                		</div>
            		</div>
        		</div>
    		</form>
        
    		<div class="flex justify-end mt-6 space-x-3">
        		<button type="button" id="btn-huy-mon-hoc" 
                		class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
            		<i class="fas fa-times mr-2"></i>Hủy
        		</button>
        		<button type="button" id="btn-luu-mon-hoc" 
                		class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
            		<i class="fas fa-save mr-2"></i>Lưu môn học
        		</button>
    		</div>
		</div>
	</div>
	
	{% comment %} <!-- Modal thêm chương trình đào tạo --> {% endcomment %}
	<div id="modal-them-chuong-trinh" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm chương trình đào tạo mới</h3>
                <button type="button" id="btn-dong-chuong-trinh" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-chuong-trinh" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã chương trình *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: CNTT_2022"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên chương trình *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: Chương trình Tin học ứng dụng"
                            required
                            autocomplete="off">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Năm học áp dụng *</label>
                        <input type="text" name="academic_year" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: 2022 - 2025"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngành đào tạo *</label>
                        <select name="major_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                required>
                            <option value="">-- Chọn ngành --</option>
                            {% for major in majors %}
                            <option value="{{ major.id }}">{{ major.name }} ({{ major.code }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="3"
                            placeholder="Nhập mô tả về chương trình đào tạo..."
                            autocomplete="off"></textarea>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-md">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Thông tin bổ sung:</h4>
                    <p class="text-sm text-blue-700">
                        • Chương trình sẽ được tạo với trạng thái "Bản nháp"<br>
                        • Bạn có thể import môn học sau khi tạo chương trình
                    </p>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-chuong-trinh" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-chuong-trinh" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-save mr-2"></i>Lưu chương trình
                </button>
            </div>
        </div>
    </div>

    <!-- Modal thêm môn học -->
    <div id="modal-them-mon-hoc" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white" style="z-index: 1001;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm môn học mới</h3>
                <button type="button" id="btn-dong-mon-hoc" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="bg-blue-50 p-4 rounded-md mb-4">
                <h4 class="text-sm font-semibold text-blue-800 mb-2">Chọn từ môn học có sẵn</h4>
                <div class="flex space-x-2">
                    <select id="select-existing-subject" class="flex-1 p-2 border border-gray-300 rounded-md">
                        <option value="">-- Chọn môn học có sẵn --</option>
                        <!-- Options sẽ được điền bằng JavaScript -->
                    </select>
                    <button type="button" id="btn-use-existing" 
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-check mr-1"></i> Chọn
                    </button>
                </div>
                <p class="text-xs text-blue-600 mt-1">Chọn môn học từ danh sách có sẵn để thêm vào chương trình này</p>
            </div>

            <!-- Thêm phần hiển thị thông tin môn học đã chọn -->
            <div id="existing-subject-info" class="bg-green-50 p-3 rounded-md border border-green-200 hidden mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h4 class="text-sm font-semibold text-green-800">Đã chọn môn học có sẵn</h4>
                        <p class="text-sm text-green-700" id="selected-subject-name"></p>
                    </div>
                    <button type="button" id="btn-clear-selection" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <form id="form-them-mon-hoc" class="space-y-4">
                <!-- Thông tin chương trình -->
                <div class="bg-blue-50 p-4 rounded-md">
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Thông tin chương trình đào tạo</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                            <select id="them-mon-hoc-curriculum" name="curriculum_id" 
                                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                    required>
                                <option value="">-- Chọn chương trình --</option>
                                {% for curriculum in curricula %}
                                <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Ngành đào tạo</label>
                            <input type="text" id="them-mon-hoc-major" 
                                class="w-full p-3 border border-gray-300 rounded-md bg-gray-100" 
                                readonly>
                        </div>
                    </div>
                </div>

                <!-- Thông tin cơ bản môn học -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã môn học *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: MH01"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên môn học *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="Vd: Giáo dục chính trị"
                            required
                            autocomplete="off">
                    </div>
                </div>

                <!-- Số tín chỉ và giờ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Số tín chỉ *</label>
                        <input type="number" name="credits" step="0.5" min="0" max="10"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            required
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tổng số giờ</label>
                        <input type="number" name="total_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Lý thuyết</label>
                        <input type="number" name="theory_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thực hành</label>
                        <input type="number" name="practice_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Kiểm tra/Thi</label>
                        <input type="number" name="exam_hours" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Thứ tự</label>
                        <input type="number" name="order_number" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            placeholder="0"
                            autocomplete="off">
                    </div>
                </div>

                <!-- Phân bố học kỳ -->
                <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-3">Phân bố học kỳ (số tín chỉ)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        {% for i in "123456" %}
                        <div>
                            <label class="block text-gray-700 text-sm font-medium mb-1">Học kỳ {{ i }}</label>
                            <input type="number" name="hk{{ i }}" step="0.5" min="0" max="10"
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center" 
                                placeholder="-"
                                autocomplete="off">
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Thông tin bổ sung -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Đơn vị quản lý</label>
                        <select name="department_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn đơn vị --</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Loại môn *</label>
                        <select name="subject_type_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                required>
                            <option value="">-- Chọn loại môn --</option>
                            {% for subject_type in subject_types %}
                            <option value="{{ subject_type.id }}">{{ subject_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tổ bộ môn</label>
                        <select name="subject_group_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn tổ bộ môn --</option>
                            {% for subject_group in subject_groups %}
                            <option value="{{ subject_group.id }}" data-department="{{ subject_group.department_id }}">{{ subject_group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Học kỳ mặc định</label>
                        <select name="semester" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Chọn học kỳ --</option>
                            {% for i in "123456" %}
                            <option value="{{ i }}">Học kỳ {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả môn học</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="3"
                            placeholder="Nhập mô tả về môn học..."
                            autocomplete="off"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Điều kiện tiên quyết</label>
                    <textarea name="prerequisites" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="2"
                            placeholder="Nhập điều kiện tiên quyết (nếu có)..."
                            autocomplete="off"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chuẩn đầu ra</label>
                    <textarea name="learning_outcomes" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                            rows="2"
                            placeholder="Nhập chuẩn đầu ra của môn học..."
                            autocomplete="off"></textarea>
                </div>

                <!-- Thông tin môn tự chọn -->
                <div class="bg-green-50 p-4 rounded-md border border-green-200">
                    <h4 class="text-sm font-semibold text-green-800 mb-3">Thông tin môn tự chọn (nếu có)</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" name="is_elective" id="is_elective" 
                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <label for="is_elective" class="ml-2 block text-sm text-gray-700 font-medium">
                                Là môn tự chọn
                            </label>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Nhóm môn tự chọn</label>
                            <input type="text" name="elective_group" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                placeholder="Vd: Nhóm 1"
                                autocomplete="off">
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-mon-hoc" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-mon-hoc" 
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-6 rounded-md transition duration-200">
                    <i class="fas fa-save mr-2"></i>Lưu môn học
                </button>
            </div>
        </div>
    </div>
</body>
</html>

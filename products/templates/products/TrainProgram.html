<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Chương trình Đào tạo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .editable:focus {
            outline: 2px solid #3b82f6;
            background-color: #f0f9ff;
        }
        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-800">QUẢN LÝ CHƯƠNG TRÌNH ĐÀO TẠO</h1>
        
        <!-- Thông tin chung -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khoa đào tạo</label>
                    <select id="khoa-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn khoa --</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Tổ bộ môn</label>
                    <select id="to-bo-mon" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn tổ bộ môn --</option>
                        {% for group in subject_groups %}
                        <option value="{{ group.id }}" data-department="{{ group.department_id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Chương trình đào tạo</label>
                    <select id="chuong-trinh-dao-tao" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn chương trình --</option>
                        {% for curriculum in curricula %}
                        <option value="{{ curriculum.id }}">{{ curriculum.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Khóa học</label>
                    <select id="khoa-hoc" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn khóa học --</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}" data-curriculum="{{ course.curriculum_id }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Nút chức năng -->
        <div class="flex flex-wrap justify-between mb-6">
            <div class="flex space-x-2 mb-4">
                <button id="btn-them" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
                    <i class="fas fa-plus mr-2"></i> Thêm chương trình đào tạo
                </button>
                <button id="btn-cap-nhat" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
                    <i class="fas fa-sync-alt mr-2"></i> Cập nhật
                </button>
            </div>
            
            <div>
                <button id="btn-import" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md flex items-center">
                    <i class="fas fa-file-excel mr-2"></i> Import Excel
                </button>
                <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
            </div>
        </div>
        
        <!-- Modal thêm chương trình đào tạo -->
        <div id="modal-them-chuong-trinh" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Thêm chương trình đào tạo mới</h3>
                    <form id="form-them-chuong-trinh" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Mã chương trình *</label>
                                <input type="text" name="code" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Tên chương trình *</label>
                                <input type="text" name="name" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Năm học áp dụng *</label>
                                <input type="text" name="academic_year" class="w-full p-2 border border-gray-300 rounded-md" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2">Ngành đào tạo *</label>
                                <select name="major_id" class="w-full p-2 border border-gray-300 rounded-md" required>
                                    <option value="">-- Chọn ngành --</option>
                                    {% for major in majors %}
                                    <option value="{{ major.id }}">{{ major.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                            <textarea name="description" class="w-full p-2 border border-gray-300 rounded-md" rows="3"></textarea>
                        </div>
                    </form>
                    <div class="flex justify-end mt-4 space-x-2">
                        <button id="btn-huy-chuong-trinh" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                            Hủy
                        </button>
                        <button id="btn-luu-chuong-trinh" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Lưu
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal import Excel -->
        <div id="modal-import" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Import từ Excel</h3>
                    <form id="form-import" class="space-y-4" enctype="multipart/form-data">
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                            <select id="import-curriculum" name="curriculum_id" class="w-full p-2 border border-gray-300 rounded-md" required>
                                <option value="">-- Chọn chương trình --</option>
                                {% for curriculum in curricula %}
                                <option value="{{ curriculum.id }}">{{ curriculum.name }} ({{ curriculum.academic_year }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-bold mb-2">File Excel *</label>
                            <input type="file" id="excel-file" name="excel_file" accept=".xlsx, .xls" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <p class="text-xs text-gray-500 mt-1">Chỉ chấp nhận file .xlsx hoặc .xls, tối đa 10MB</p>
                        </div>
                        <div class="text-sm text-gray-600">
                            <p><a href="#" id="btn-download-template" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-download mr-1"></i>Tải file mẫu
                            </a></p>
                        </div>
                    </form>
                    <div class="flex justify-end mt-4 space-x-2">
                        <button id="btn-huy-import" type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                            Hủy
                        </button>
                        <button id="btn-luu-import" type="button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-upload mr-2"></i>Import
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal hiển thị lỗi import -->
        <div id="modal-import-errors" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Chi tiết lỗi khi import</h3>
                    <div id="import-errors-content" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded">
                        <!-- Nội dung lỗi sẽ được điền ở đây -->
                    </div>
                    <div class="flex justify-end">
                        <button id="btn-close-errors" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Đóng
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bảng dữ liệu -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TT</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã môn học</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên học phần</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số tín chỉ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổng số giờ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lý thuyết</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thực hành</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kiểm tra/Thi</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK2</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK3</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK4</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK5</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK6</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đơn vị</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giảng viên</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Thông tin tổng kết -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-gray-600">Tổng số tín chỉ</p>
                    <p id="tong-tin-chi" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tổng số giờ</p>
                    <p id="tong-gio" class="text-xl font-bold text-blue-700">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tỷ lệ lý thuyết</p>
                    <p id="ty-le-ly-thuyet" class="text-xl font-bold text-blue-700">0%</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">Tỷ lệ thực hành</p>
                    <p id="ty-le-thuc-hanh" class="text-xl font-bold text-blue-700">0%</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal thêm môn học -->
    <div id="modal-them" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Thêm môn học mới</h3>
                <form id="form-them" class="mt-4 text-left">
                    <!-- Form fields sẽ được thêm ở đây -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Mã môn học</label>
                            <input type="text" name="ma_mon_hoc" class="w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Tên học phần</label>
                            <input type="text" name="ten_mon_hoc" class="w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                    </div>
                    <!-- Thêm các trường khác tương tự -->
                </form>
                <div class="flex justify-end mt-4 space-x-2">
                    <button id="btn-huy" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                        Hủy
                    </button>
                    <button id="btn-luu" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục lưu trữ dữ liệu
        let allDepartments = {{ departments|safe }};
        let allSubjectGroups = {{ subject_groups|safe }};
        let allCurricula = {{ curricula|safe }};
        let allCourses = {{ courses|safe }};
        let allSubjectTypes = {{ subject_types|safe }};
        let allMajors = {{ majors|safe }};
        let monHocData = {{ mon_hoc_data|safe }};
        
        // Khởi tạo dropdowns
        function initializeDropdowns() {
            populateDropdown('khoa-dao-tao', allDepartments, 'name');
            populateDropdown('to-bo-mon', allSubjectGroups, 'name');
            populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
            populateDropdown('khoa-hoc', allCourses, 'name');
            populateDropdown('import-curriculum', allCurricula, 'name');
        }
        
        function populateDropdown(elementId, data, displayField) {
            const dropdown = document.getElementById(elementId);
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">-- Chọn --</option>';
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[displayField];
                if (item.academic_year) {
                    option.textContent += ` (${item.academic_year})`;
                }
                dropdown.appendChild(option);
            });
        }
        
        // Render bảng dữ liệu
        function renderTable() {
            const tableBody = document.getElementById('table-body');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (monHocData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="17" class="px-4 py-4 text-center text-gray-500">Không có dữ liệu môn học</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            monHocData.forEach((monHoc, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-2 whitespace-nowrap text-center">${index + 1}</td>
                    <td class="px-4 py-2">
                        <input type="text" value="${monHoc.ma_mon_hoc || ''}" 
                            class="editable w-full bg-transparent border-none" 
                            data-field="code" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" value="${monHoc.ten_mon_hoc || ''}" 
                            class="editable w-full bg-transparent border-none" 
                            data-field="name" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.so_tin_chi || 0}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="credits" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.tong_so_gio || 0}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="total_hours" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.ly_thuyet || 0}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="theory_hours" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.thuc_hanh || 0}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="practice_hours" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.kiem_tra_thi || 0}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="exam_hours" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.hk1 || ''}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="hk1" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.hk2 || ''}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="hk2" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.hk3 || ''}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="hk3" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.hk4 || ''}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="hk4" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.hk5 || ''}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="hk5" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="number" value="${monHoc.hk6 || ''}" 
                            class="editable w-full bg-transparent border-none text-center" 
                            data-field="hk6" data-id="${monHoc.id}" readonly step="0.5">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" value="${monHoc.don_vi || ''}" 
                            class="editable w-full bg-transparent border-none" 
                            data-field="department" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" value="${monHoc.giang_vien || ''}" 
                            class="editable w-full bg-transparent border-none" 
                            data-field="instructor" data-id="${monHoc.id}" readonly>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button class="btn-sua text-blue-600 hover:text-blue-900 mr-2" data-id="${monHoc.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-xoa text-red-600 hover:text-red-900" data-id="${monHoc.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Cập nhật thống kê
            updateStatistics();
        }
        
        // Cập nhật thống kê
        function updateStatistics() {
            const totalCredits = monHocData.reduce((sum, item) => sum + (parseFloat(item.so_tin_chi) || 0), 0);
            const totalHours = monHocData.reduce((sum, item) => sum + (parseInt(item.tong_so_gio) || 0), 0);
            const totalTheory = monHocData.reduce((sum, item) => sum + (parseInt(item.ly_thuyet) || 0), 0);
            const totalPractice = monHocData.reduce((sum, item) => sum + (parseInt(item.thuc_hanh) || 0), 0);
            
            const tyLeLyThuyet = totalHours > 0 ? (totalTheory / totalHours * 100).toFixed(1) : 0;
            const tyLeThucHanh = totalHours > 0 ? (totalPractice / totalHours * 100).toFixed(1) : 0;
            
            document.getElementById('tong-tin-chi').textContent = totalCredits.toFixed(1);
            document.getElementById('tong-gio').textContent = totalHours;
            document.getElementById('ty-le-ly-thuyet').textContent = `${tyLeLyThuyet}%`;
            document.getElementById('ty-le-thuc-hanh').textContent = `${tyLeThucHanh}%`;
        }
        
        // Load dữ liệu theo bộ lọc
        function loadFilteredData() {
            const departmentId = document.getElementById('khoa-dao-tao').value;
            const subjectGroupId = document.getElementById('to-bo-mon').value;
            const curriculumId = document.getElementById('chuong-trinh-dao-tao').value;
            const courseId = document.getElementById('khoa-hoc').value;
            
            let url = '/api/subjects/?';
            const params = [];
            
            if (curriculumId) params.push(`curriculum_id=${curriculumId}`);
            if (departmentId) params.push(`department_id=${departmentId}`);
            if (subjectGroupId) params.push(`subject_group_id=${subjectGroupId}`);
            if (courseId) params.push(`course_id=${courseId}`);
            
            url += params.join('&');
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    monHocData = data;
                    renderTable();
                    
                    // Load thống kê nếu có curriculum
                    if (curriculumId) {
                        loadThongKe(curriculumId);
                    } else {
                        updateStatistics();
                    }
                })
                .catch(error => {
                    console.error('Error loading filtered data:', error);
                    alert('Có lỗi xảy ra khi tải dữ liệu');
                });
        }
        
        // Load thống kê
        function loadThongKe(curriculumId) {
            fetch(`/thong-ke/?curriculum_id=${curriculumId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tong-tin-chi').textContent = data.tong_tin_chi;
                    document.getElementById('tong-gio').textContent = data.tong_gio;
                    document.getElementById('ty-le-ly-thuyet').textContent = data.ty_le_ly_thuyet;
                    document.getElementById('ty-le-thuc-hanh').textContent = data.ty_le_thuc_hanh;
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    updateStatistics();
                });
        }
        
        // Cập nhật môn học
        function updateMonHoc(id, field, value) {
            const data = {
                id: id,
                field: field,
                value: value
            };
            
            fetch(`/train-program/${id}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    alert('Có lỗi khi cập nhật: ' + data.message);
                    // Reload data to reset values
                    loadFilteredData();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi cập nhật');
                loadFilteredData();
            });
        }
        
        // Xóa môn học
        function deleteMonHoc(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa môn học này?')) {
                return;
            }
            
            fetch(`/train-program/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã xóa môn học thành công');
                    loadFilteredData();
                } else {
                    alert('Có lỗi khi xóa: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi xóa');
            });
        }
        
        // Tạo chương trình đào tạo mới
        function createCurriculum() {
            const form = document.getElementById('form-them-chuong-trinh');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            // Validate
            if (!data.code || !data.name || !data.academic_year || !data.major_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }
            
            fetch('/api/curriculum/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã tạo chương trình đào tạo thành công');
                    document.getElementById('modal-them-chuong-trinh').classList.add('hidden');
                    form.reset();
                    // Reload dropdown curricula
                    loadCurricula();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tạo chương trình');
            });
        }
        
        // Import Excel
        function importExcel() {
            const form = document.getElementById('form-import');
            const formData = new FormData(form);
            const curriculumId = document.getElementById('import-curriculum').value;
            const fileInput = document.getElementById('excel-file');
            
            if (!curriculumId) {
                alert('Vui lòng chọn chương trình đào tạo');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file Excel');
                return;
            }
            
            fetch('/import-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    document.getElementById('modal-import').classList.add('hidden');
                    form.reset();
                    // Reload data
                    loadFilteredData();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi import file');
            });
        }
        
        // Hiển thị lỗi import
        function showImportErrors(errors) {
            const errorsContent = document.getElementById('import-errors-content');
            if (errors && errors.length > 0) {
                errorsContent.innerHTML = errors.map(error => 
                    `<div class="text-red-600 py-1 border-b border-gray-300">${error}</div>`
                ).join('');
            } else {
                errorsContent.innerHTML = '<div class="text-green-600">Không có lỗi nào</div>';
            }
            document.getElementById('modal-import-errors').classList.remove('hidden');
        }

        // Import Excel với xử lý lỗi chi tiết
        function importExcel() {
            const form = document.getElementById('form-import');
            const formData = new FormData(form);
            const curriculumId = document.getElementById('import-curriculum').value;
            const fileInput = document.getElementById('excel-file');
            
            if (!curriculumId) {
                alert('Vui lòng chọn chương trình đào tạo');
                return;
            }
            
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file Excel');
                return;
            }
            
            // Hiển thị loading
            const importBtn = document.getElementById('btn-luu-import');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
            importBtn.disabled = true;
            
            fetch('/import-excel/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    document.getElementById('modal-import').classList.add('hidden');
                    form.reset();
                    
                    // Hiển thị chi tiết lỗi nếu có
                    if (data.data && data.data.errors && data.data.errors.length > 0) {
                        showImportErrors(data.data.errors);
                    }
                    
                    // Reload data
                    loadFilteredData();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi import file: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            });
        }

        // Đóng modal lỗi
        document.getElementById('btn-close-errors').addEventListener('click', function() {
            document.getElementById('modal-import-errors').classList.add('hidden');
        });

        // Tải file mẫu
        function downloadTemplate() {
            window.open('/download-excel-template/', '_blank');
        }
        
        // Load lại danh sách curricula
        function loadCurricula() {
            fetch('/api/curricula/')
                .then(response => response.json())
                .then(data => {
                    allCurricula = data;
                    populateDropdown('chuong-trinh-dao-tao', allCurricula, 'name');
                    populateDropdown('import-curriculum', allCurricula, 'name');
                })
                .catch(error => {
                    console.error('Error loading curricula:', error);
                });
        }
        
        // Hàm lấy CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Xử lý sự kiện khi trang tải xong
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropdowns();
            renderTable();
            
            // Xử lý sự kiện thay đổi dropdown
            document.getElementById('khoa-dao-tao').addEventListener('change', function() {
                const departmentId = this.value;
                
                // Reset các dropdown phía sau
                document.getElementById('to-bo-mon').value = '';
                document.getElementById('chuong-trinh-dao-tao').value = '';
                document.getElementById('khoa-hoc').value = '';
                
                // Load subject groups theo department
                if (departmentId) {
                    fetch(`/api/subject-groups/?department_id=${departmentId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown('to-bo-mon', data, 'name');
                        });
                } else {
                    populateDropdown('to-bo-mon', allSubjectGroups, 'name');
                }
                
                loadFilteredData();
            });
            
            document.getElementById('to-bo-mon').addEventListener('change', function() {
                document.getElementById('chuong-trinh-dao-tao').value = '';
                document.getElementById('khoa-hoc').value = '';
                loadFilteredData();
            });
            
            document.getElementById('chuong-trinh-dao-tao').addEventListener('change', function() {
                const curriculumId = this.value;
                document.getElementById('khoa-hoc').value = '';
                
                if (curriculumId) {
                    fetch(`/api/courses/?curriculum_id=${curriculumId}`)
                        .then(response => response.json())
                        .then(data => {
                            populateDropdown('khoa-hoc', data, 'name');
                        });
                } else {
                    populateDropdown('khoa-hoc', allCourses, 'name');
                }
                
                loadFilteredData();
            });
            
            document.getElementById('khoa-hoc').addEventListener('change', loadFilteredData);
            
            // Xử lý sự kiện cho nút sửa
            document.addEventListener('click', function(e) {
                if (e.target.closest('.btn-sua')) {
                    const button = e.target.closest('.btn-sua');
                    const row = button.closest('tr');
                    const inputs = row.querySelectorAll('input');
                    const id = button.getAttribute('data-id');
                    
                    // Chuyển đổi giữa chế độ chỉnh sửa và xem
                    if (button.innerHTML.includes('fa-edit')) {
                        button.innerHTML = '<i class="fas fa-check"></i>';
                        button.classList.remove('text-blue-600');
                        button.classList.add('text-green-600');
                        inputs.forEach(input => {
                            input.classList.add('border', 'border-blue-400', 'bg-white');
                            input.removeAttribute('readonly');
                        });
                    } else {
                        button.innerHTML = '<i class="fas fa-edit"></i>';
                        button.classList.remove('text-green-600');
                        button.classList.add('text-blue-600');
                        inputs.forEach(input => {
                            input.classList.remove('border', 'border-blue-400', 'bg-white');
                            input.setAttribute('readonly', true);
                            
                            // Gửi yêu cầu cập nhật đến server
                            const field = input.getAttribute('data-field');
                            const value = input.value;
                            
                            if (field && id) {
                                updateMonHoc(id, field, value);
                            }
                        });
                    }
                }
                
                // Xử lý xóa môn học
                if (e.target.closest('.btn-xoa')) {
                    const button = e.target.closest('.btn-xoa');
                    const id = button.getAttribute('data-id');
                    if (id) {
                        deleteMonHoc(id);
                    }
                }
            });
            
            // Xử lý thêm chương trình đào tạo
            document.getElementById('btn-them').addEventListener('click', function() {
                document.getElementById('modal-them-chuong-trinh').classList.remove('hidden');
            });
            
            document.getElementById('btn-huy-chuong-trinh').addEventListener('click', function() {
                document.getElementById('modal-them-chuong-trinh').classList.add('hidden');
            });
            
            document.getElementById('btn-luu-chuong-trinh').addEventListener('click', createCurriculum);
            
            // Xử lý import Excel
            document.getElementById('btn-import').addEventListener('click', function() {
                document.getElementById('modal-import').classList.remove('hidden');
            });
            
            document.getElementById('btn-huy-import').addEventListener('click', function() {
                document.getElementById('modal-import').classList.add('hidden');
            });
            
            document.getElementById('btn-luu-import').addEventListener('click', importExcel);
            
            // Tải file mẫu
            document.getElementById('btn-download-template').addEventListener('click', function(e) {
                e.preventDefault();
                downloadTemplate();
            });
            
            // Xử lý nút cập nhật
            document.getElementById('btn-cap-nhat').addEventListener('click', function() {
                loadFilteredData();
                alert('Đã cập nhật dữ liệu');
            });
            
            // Thiết lập các ô input ban đầu là readonly
            document.querySelectorAll('input').forEach(input => {
                input.setAttribute('readonly', true);
            });
        });
        
        // Xử lý phím Enter trong modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                // Nếu đang trong modal thêm chương trình
                if (!document.getElementById('modal-them-chuong-trinh').classList.contains('hidden')) {
                    createCurriculum();
                }
                // Nếu đang trong modal import
                else if (!document.getElementById('modal-import').classList.contains('hidden')) {
                    importExcel();
                }
            }
            
            // ESC để đóng modal
            if (e.key === 'Escape') {
                document.getElementById('modal-them-chuong-trinh').classList.add('hidden');
                document.getElementById('modal-import').classList.add('hidden');
            }
        });
    </script>
</body>
</html>

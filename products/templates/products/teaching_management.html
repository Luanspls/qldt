<!-- products/teaching_management.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Phân công Giảng dạy</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
		/* ===== RESET VÀ BASE STYLES ===== */
        * {
            box-sizing: border-box;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            /* position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;*/
            z-index: 99990 !important;
            /* padding: 20px;*/
        }

        .modal.hidden {
            display: none !important;
        }

        .modal > div {
            /* position: relative !important;
            background: white !important;
            border-radius: 8px !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2) !important;
            width: 100% !important;
            max-width: 800px !important;
            max-height: 90vh !important;
            overflow-y: auto !important;*/
            z-index: 99991 !important;
        }

        /* ===== SELECT2 STYLES - QUAN TRỌNG: ĐƠN GIẢN HÓA ===== */
        .select2-container {
            z-index: 1000;
        }

        .select2-dropdown {
            z-index: 1001 !important;
        }

        /* Select2 trong modal */
        .modal .select2-container {
            z-index: 99992 !important;
			display: block !important;
    		visibility: visible !important;
			opacity: 1 !important;
    		pointer-events: auto !important;
        }

        .modal .select2-dropdown {
            z-index: 99993 !important;
            display: block !important;
			visibility: visible !important;
    		opacity: 1 !important;
    		pointer-events: auto !important;
        }

		/* Đảm bảo backdrop của modal không bị ảnh hưởng */
		.modal-backdrop {
    		z-index: 99989 !important;
		}

		/* Ẩn tất cả dropdown ngoại trừ trong modal đang active */
		body.modal-open .select2-container--open:not(.modal .select2-container--open) {
    		display: none !important;
		}
		
        /* ===== TAB STYLES ===== */
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #2563eb;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ===== SELECT2 CUSTOM STYLES ===== */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #d1d5db !important;
            border-radius: 0.375rem !important;
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
        }

        .select2-container--default .select2-selection--multiple {
            height: auto !important;
            padding: 0.5rem 0.75rem !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #3b82f6 !important;
            color: white !important;
            border: none !important;
            border-radius: 0.25rem !important;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: white !important;
            margin-right: 5px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100% !important;
        }

        /* ===== EDITABLE STYLES ===== */
        .editable:focus {
            outline: 2px solid #3b82f6;
            background-color: #f0f9ff;
        }

        /* ===== FIX QUAN TRỌNG CHO SELECT2 HIỂN THỊ ===== */
        /* Đảm bảo dropdown không bị ẩn */
        .select2-container--open .select2-dropdown {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Đảm bảo tất cả dropdown đều hiển thị */
        .select2-dropdown {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        /* Reset các style có thể ảnh hưởng đến việc hiển thị */
        body.modal-open .select2-dropdown:not(.modal .select2-dropdown) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
			z-index: 1 !important;
        }

		/* Select2 bên ngoài modal khi modal mở */
		body.modal-open .select2-container:not(.modal .select2-container) {
    		display: none !important;
    		visibility: hidden !important;
			opacity: 0 !important;
    		pointer-events: none !important;
			z-index: 1 !important;
		}

		/* Hiệu ứng làm mờ cho nền khi modal mở */
		body.modal-open .container {
    		filter: blur(1px);
    		transition: filter 0.3s ease;
		}
		body.modal-open .container:not(.modal) {
    		filter: none;
		}

        /* ===== RESPONSIVE FIXES ===== */
        @media (max-width: 768px) {
            .modal {
                padding: 10px !important;
            }
            
            .modal > div {
                width: 95% !important;
                max-width: none !important;
            }
        }

        /* ===== ANIMATION (optional) ===== */
        .modal > div {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .select2-dropdown {
            animation: dropdownFadeIn 0.2s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            .modal {
                display: none !important;
            }
            
            .select2-dropdown {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-800">QUẢN LÝ LỚP HỌC VÀ PHÂN CÔNG GIẢNG DẠY</h1>
        
        <!-- Tab navigation -->
        <div class="mb-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button id="tab-classes" class="tab-button py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600 active">
                        Lớp học
                    </button>
                    <button id="tab-combined-classes" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Lớp học ghép
                    </button>
                    <button id="tab-instructors" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Giảng viên
                    </button>
                    <button id="tab-teaching-assignments" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Phân công giảng dạy
                    </button>
                    <button id="tab-statistics" class="tab-button py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Thống kê
                    </button>
                </nav>
            </div>
        </div>

        <!-- Tab content -->
        <div id="tab-content">
            <!-- Lớp học -->
            <div id="classes-tab" class="tab-panel active">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Quản lý lớp học</h3>
                    <div class="flex space-x-2">
                        <button id="btn-them-lop-hoc" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-plus mr-2"></i> Thêm lớp học
                        </button>
                        <button onclick="openImportModal('class')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                        </button>
                    </div>
                </div>
                
                <!-- Bộ lọc lớp học -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chương trình</label>
                        <select id="filter-class-curriculum" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả chương trình</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Khóa học</label>
                        <select id="filter-class-course" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả khóa học</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loại lớp</label>
                        <select id="filter-class-type" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả</option>
                            <option value="false">Lớp thường</option>
                            <option value="true">Lớp ghép</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btn-filter-classes" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md w-full">
                            Lọc
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã lớp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên lớp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chương trình</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khóa học</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loại</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày bắt đầu</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="classes-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lớp học ghép -->
            <div id="combined-classes-tab" class="tab-panel hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Quản lý lớp học ghép</h3>
                    <div class="flex space-x-2">
                        <button id="btn-them-lop-ghep" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-plus mr-2"></i> Thêm lớp ghép
                        </button>
                        <button onclick="openImportModal('combined-class')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                        </button>
                    </div>
                </div>
                
                <!-- Bộ lọc lớp ghép -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chương trình</label>
                        <select id="filter-combined-curriculum" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả chương trình</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btn-filter-combined" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md w-full">
                            Lọc
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã lớp ghép</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tên lớp ghép</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chương trình</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số lớp ghép</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Các lớp thành phần</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="combined-classes-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Giảng viên -->
            <div id="instructors-tab" class="tab-panel hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Quản lý Giảng viên</h3>
                    <div class="flex space-x-2">
                        <button id="btn-them-giang-vien" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-plus mr-2"></i> Thêm giảng viên
                        </button>
                        <button onclick="openImportModal('instructor')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                        </button>
                    </div>
                </div>
                
                <!-- Bộ lọc giảng viên -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Khoa</label>
                        <select id="filter-instructor-department" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả khoa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tổ bộ môn</label>
                        <select id="filter-instructor-subject-group" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả tổ bộ môn</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Trạng thái</label>
                        <select id="filter-instructor-status" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả</option>
                            <option value="true">Đang hoạt động</option>
                            <option value="false">Ngừng hoạt động</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btn-filter-instructors" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md w-full">
                            Lọc
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mã GV</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Họ và tên</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số điện thoại</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khoa</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tổ BM</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="instructors-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Phân công giảng dạy -->
            <div id="teaching-assignments-tab" class="tab-panel hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Phân công giảng dạy</h3>
                    <div class="flex space-x-2">
                        <button id="btn-them-phan-cong" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-plus mr-2"></i> Thêm phân công
                        </button>
                        <button onclick="openImportModal('teaching-assignment')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> Import Excel
                        </button>
                    </div>
                </div>
                
                <!-- Bộ lọc -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Giảng viên</label>
                        <select id="filter-instructor" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả giảng viên</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chương trình</label>
                        <select id="filter-curriculum" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả chương trình</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loại lớp</label>
                        <select id="filter-class-type-assignment" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Tất cả</option>
                            <option value="regular">Lớp thường</option>
                            <option value="combined">Lớp ghép</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Năm học</label>
                        <input type="text" id="filter-academic-year" class="w-full p-2 border border-gray-300 rounded-md" placeholder="VD: 2023-2024">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giảng viên</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Môn học</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lớp học</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Năm học</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">HK</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vai trò</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Số SV</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giờ dạy</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="teaching-assignments-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Dữ liệu sẽ được thêm bằng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Thống kê -->
            <div id="statistics-tab" class="tab-panel hidden">
                <h3 class="text-lg font-semibold mb-4">Thống kê phân công giảng dạy</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-800 mb-2">Theo giảng viên</h4>
                        <div id="instructor-stats" class="space-y-2 max-h-80 overflow-y-auto">
                            <!-- Thống kê sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="text-lg font-semibold text-green-800 mb-2">Theo chương trình</h4>
                        <div id="curriculum-stats" class="space-y-2 max-h-80 overflow-y-auto">
                            <!-- Thống kê sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="text-lg font-semibold text-purple-800 mb-2">Theo đơn vị</h4>
                        <div id="department-stats" class="space-y-2 max-h-80 overflow-y-auto">
                            <!-- Thống kê sẽ được thêm bằng JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal thêm lớp học -->
    <div id="modal-them-lop-hoc" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm lớp học mới</h3>
                <button type="button" id="btn-dong-lop-hoc" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-lop-hoc" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã lớp *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: DHTI001"
                            required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên lớp *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: Lớp Công nghệ Thông tin 001"
                            required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                        <select name="curriculum_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn chương trình --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Khóa học *</label>
                        <select name="course_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn khóa học --</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngày bắt đầu</label>
                        <input type="date" name="start_date" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ngày kết thúc</label>
                        <input type="date" name="end_date" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="flex items-center">
                    <input type="checkbox" name="is_combined" id="is_combined" 
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="is_combined" class="ml-2 block text-sm text-gray-700 font-medium">
                        Là lớp ghép
                    </label>
                </div>
                
                <div id="combined-class-fields" class="hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mã lớp ghép</label>
                    <input type="text" name="combined_class_code" 
                        class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="Vd: GHÉP001">
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            rows="3"
                            placeholder="Nhập mô tả về lớp học..."></textarea>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-lop-hoc" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-lop-hoc" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-save mr-2"></i>Lưu lớp học
                </button>
            </div>
        </div>
    </div>

    <!-- Modal thêm lớp học ghép -->
    <div id="modal-them-lop-ghep" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm lớp học ghép mới</h3>
                <button type="button" id="btn-dong-lop-ghep" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-lop-ghep" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã lớp ghép *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: GHÉP001"
                            required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tên lớp ghép *</label>
                        <input type="text" name="name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: Lớp ghép Công nghệ Thông tin"
                            required>
                    </div>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chương trình đào tạo *</label>
                    <select name="curriculum_id" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            required>
                        <option value="">-- Chọn chương trình --</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Các lớp thành phần *</label>
                    <select name="classes" id="classes" multiple
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            required>
                        <option value="">-- Chọn các lớp --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Giữ phím Ctrl để chọn nhiều lớp</p>
                </div>
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Mô tả</label>
                    <textarea name="description" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            rows="3"
                            placeholder="Nhập mô tả về lớp học ghép..."></textarea>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-lop-ghep" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-lop-ghep" 
                        class="bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-save mr-2"></i>Lưu lớp ghép
                </button>
            </div>
        </div>
    </div>

    <!-- Modal thêm giảng viên -->
    <div id="modal-them-giang-vien" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm giảng viên mới</h3>
                <button type="button" id="btn-dong-giang-vien" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-giang-vien" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Mã giảng viên *</label>
                        <input type="text" name="code" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: GV001"
                            required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Họ và tên *</label>
                        <input type="text" name="full_name" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: Nguyễn Văn A"
                            required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                        <input type="email" name="email" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: nva@example.com">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Số điện thoại</label>
                        <input type="text" name="phone" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: 0123456789">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Khoa</label>
                        <select name="department_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Chọn khoa --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Tổ bộ môn</label>
                        <select name="subject_group_id" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Chọn tổ bộ môn --</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" name="is_active" id="is_active" 
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                    <label for="is_active" class="ml-2 block text-sm text-gray-700 font-medium">
                        Đang hoạt động
                    </label>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-giang-vien" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-giang-vien" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-save mr-2"></i>Lưu giảng viên
                </button>
            </div>
        </div>
    </div>

    <!-- Modal thêm phân công giảng dạy -->
    <div id="modal-them-phan-cong" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Thêm phân công giảng dạy mới</h3>
                <button type="button" id="btn-dong-phan-cong" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-them-phan-cong" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Giảng viên *</label>
                        <select name="instructor_id" id="instructor_id"
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn giảng viên --</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Môn học *</label>
                        <select name="curriculum_subject_id" id="curriculum_subject_id"
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn môn học --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Loại lớp *</label>
                        <select name="class_type" id="class_type" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn loại lớp --</option>
                            <option value="regular">Lớp thường</option>
                            <option value="combined">Lớp ghép</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Lớp học *</label>
                        <select name="class_id" id="class_regular" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 hidden">
                            <option value="">-- Chọn lớp --</option>
                        </select>
                        <select name="combined_class_id" id="class_combined" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 hidden">
                            <option value="">-- Chọn lớp ghép --</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Năm học *</label>
                        <input type="text" name="academic_year" 
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            placeholder="Vd: 2023-2024"
                            required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Học kỳ *</label>
                        <select name="semester" 
                                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                required>
                            <option value="">-- Chọn học kỳ --</option>
                            {% for i in "123456" %}
                            <option value="{{ i }}">Học kỳ {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex items-center">
                        <input type="checkbox" name="is_main_instructor" id="is_main_instructor" 
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                        <label for="is_main_instructor" class="ml-2 block text-sm text-gray-700 font-medium">
                            Là giảng viên chính
                        </label>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Số lượng sinh viên</label>
                        <input type="number" name="student_count" min="0"
                            class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                            value="0">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Số giờ giảng dạy</label>
                    <input type="number" name="teaching_hours" min="0"
                        class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        value="0">
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-phan-cong" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-phan-cong" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-save mr-2"></i>Lưu phân công
                </button>
            </div>
        </div>
    </div>


    <!-- Modal import dữ liệu -->
    <div id="modal-import" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="import-modal-title">Import dữ liệu</h3>
                <button type="button" id="btn-dong-import" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="form-import" class="space-y-4" enctype="multipart/form-data">
                <input type="hidden" id="import-object-type" name="object_type" value="">
                
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">File Excel *</label>
                    <input type="file" id="excel-file" name="excel_file" accept=".xlsx, .xls" 
                        class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        required>
                    <p class="text-xs text-gray-500 mt-1">Chỉ chấp nhận file .xlsx hoặc .xls, tối đa 10MB</p>
                </div>
                
                <!-- Dropdown chọn sheet -->
                <div id="sheet-selection" class="hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Chọn sheet</label>
                    <select id="selected-sheet" name="selected_sheet" 
                        class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn sheet --</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Chọn sheet chứa dữ liệu cần import</p>
                </div>
                
                <div class="text-sm text-gray-600">
                    <p>
                        <a href="#" id="btn-download-template" class="text-blue-600 hover:text-blue-800 inline-flex items-center">
                            <i class="fas fa-download mr-2"></i>Tải file mẫu
                        </a>
                    </p>
                </div>
                
                <div class="bg-yellow-50 p-4 rounded-md border border-yellow-200">
                    <h4 class="text-sm font-semibold text-yellow-800 mb-2" id="import-notes-title">Lưu ý khi import:</h4>
                    <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1" id="import-notes-list">
                        <!-- Nội dung sẽ được điền bằng JavaScript -->
                    </ul>
                </div>
            </form>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button type="button" id="btn-huy-import" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-times mr-2"></i>Hủy
                </button>
                <button type="button" id="btn-luu-import" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-upload mr-2"></i>Import Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal hiển thị lỗi import -->
    <div id="modal-import-errors" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Chi tiết lỗi khi import</h3>
                <button id="btn-dong-errors" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="import-errors-content" class="max-h-96 overflow-y-auto mb-4 p-4 bg-gray-100 rounded border">
                <!-- Nội dung lỗi sẽ được điền ở đây -->
            </div>
            <div class="flex justify-end">
                <button id="btn-close-errors" 
                        class="bg-blue-500 hover:bg-blue-700 text-white font-medium py-2.5 px-6 rounded-md">
                    <i class="fas fa-check mr-2"></i>Đóng
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/vi.js"></script>

    <script>
		// Hàm khởi tạo Select2 cho tất cả dropdown
        function initializeSelect2() {
            console.log('Initializing Select2...');
            
            // Đóng tất cả dropdown Select2 đang mở trước khi khởi tạo lại
            $('.select2-container--open').select2('close');

            // Khởi tạo cho các dropdown thông thường
            $('select:not([multiple]):not(.select2-hidden-accessible)').each(function() {
                try {
                    const $select = $(this);
                    const isInModal = $select.closest('.modal').length > 0;
                    
                    $select.select2({
                        language: 'vi',
                        placeholder: "Chọn hoặc nhập để tìm kiếm...",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: isInModal ? $select.closest('.modal') : $(document.body),
                        dropdownAutoWidth: true,
                        minimumResultsForSearch: 0
                    });
                } catch (e) {
                    console.error('Error initializing Select2 for:', this, e);
                }
            });

            // Khởi tạo cho các dropdown multiple
            $('select[multiple]:not(.select2-hidden-accessible)').each(function() {
                try {
                    const $select = $(this);
                    const isInModal = $select.closest('.modal').length > 0;
                    
                    $select.select2({
                        language: 'vi',
                        placeholder: "Chọn hoặc nhập để tìm kiếm...",
                        allowClear: true,
                        width: '100%',
                        dropdownParent: isInModal ? $select.closest('.modal') : $(document.body),
                        dropdownAutoWidth: true,
                        closeOnSelect: false
                    });
                } catch (e) {
                    console.error('Error initializing Select2 for multiple:', this, e);
                }
            });
        }

		// Hàm tải dữ liệu từ API và điền vào dropdown với Select2
		function populateSelect2Dropdown(elementId, data, displayField, searchFields = []) {
            const dropdown = $(`#${elementId}`);
            if (!dropdown.length) {
                console.error(`Element #${elementId} not found`);
                return;
            }

            // Hủy Select2 nếu đã được khởi tạo trước đó
            if (dropdown.hasClass('select2-hidden-accessible')) {
                dropdown.select2('destroy');
            }

            // Giữ option đầu tiên nếu có
            const firstOption = dropdown.find('option').first();
            dropdown.empty();
            if (firstOption.length) {
                dropdown.append(firstOption);
            }

            // Thêm dữ liệu
            data.forEach(item => {
                const displayText = item[displayField] + (item.academic_year ? ` (${item.academic_year})` : '');
                const option = new Option(displayText, item.id, false, false);
                
                // Thêm dữ liệu tìm kiếm vào option
                if (searchFields.length > 0) {
                    const searchText = searchFields.map(field => item[field] || '').join(' ');
                    $(option).data('search-text', searchText);
                }
                
                dropdown.append(option);
            });

            // Khởi tạo lại Select2
            dropdown.select2({
                language: 'vi',
                placeholder: "Chọn hoặc nhập để tìm kiếm...",
                allowClear: true,
                width: '100%',
                dropdownParent: dropdown.closest('.modal').length ? dropdown.closest('.modal') : $(document.body),
                dropdownAutoWidth: true,
                minimumResultsForSearch: 0,
                matcher: function(params, data) {
                    if ($.trim(params.term) === '') {
                        return data;
                    }
                    
                    if (data.text && data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    
                    const searchText = $(data.element).data('search-text');
                    if (searchText && searchText.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                        return data;
                    }
                    
                    return null;
                }
            });
            
            console.log(`Select2 initialized for ${elementId} with`, data.length, 'items');
        }

		// Hàm tải dữ liệu cho dropdown với tìm kiếm theo điều kiện
		function loadSelect2Data(url, elementId, displayField, searchFields = []) {
            console.log(`Loading data for ${elementId} from ${url}`);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(`Data loaded for ${elementId}:`, data.length, 'items');
                    populateSelect2Dropdown(elementId, data, displayField, searchFields);
                })
                .catch(error => {
                    console.error(`Error loading data for ${elementId}:`, error);
                    // Fallback: khởi tạo Select2 ngay cả khi không có dữ liệu
                    setTimeout(() => {
                        $(`#${elementId}`).select2({
                            language: 'vi',
                            placeholder: "Không có dữ liệu",
                            allowClear: true,
                            width: '100%',
                            dropdownParent: $(`#${elementId}`).closest('.modal').length ? $(`#${elementId}`).closest('.modal') : $(document.body)
                        });
                    }, 100);
                });
        }

        // Hàm đóng tất cả dropdown Select2 đang mở
        function closeAllSelect2Dropdowns() {
            $('.select2-container--open').select2('close');
            // Alternative approach if above doesn't work
            $('select.select2-hidden-accessible').each(function() {
                const $select = $(this);
                if ($select.data('select2')) {
                    $select.select2('close');
                }
            });
        }
        
        // Biến toàn cục lưu trữ dữ liệu
        let allInstructors = [];
        let allCurricula = [];
        let allSubjects = [];
        let allDepartments = [];
        let allCourses = [];
        let allClasses = [];
        let allCombinedClasses = [];
        let allSubjectGroups = [];

        // Đóng dropdown khi click outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.select2-container').length && 
                !$(e.target).closest('.modal').length) {
                closeAllSelect2Dropdowns();
            }
        });

        // Đặc biệt xử lý cho modal
        $(document).on('click', '.modal', function(e) {
            if ($(e.target).hasClass('modal')) {
                closeAllSelect2Dropdowns();
            }
        });

        // Khởi tạo khi trang tải xong
        document.addEventListener('DOMContentLoaded', function() {
            // Đợi dữ liệu khởi tạo xong rồi mới load dữ liệu bảng
            loadInitialData().then(() => {
                console.log('Initial data loaded, setting up UI...');
                setupEventListeners();
                loadClassesData();
                // Khởi tạo Select2 sau khi tất cả dữ liệu đã tải
                setTimeout(initializeSelect2, 500);
            }).catch(error => {
                console.error('Error loading initial data:', error);
                // Vẫn tiếp tục setup UI ngay cả khi có lỗi
                setupEventListeners();
                loadClassesData();
            });
        });

        // Tải dữ liệu ban đầu
        function loadInitialData() {
			console.log('Loading initial data...');
    
            // Tải danh sách cho các dropdown filter
            const loadPromises = [
                loadSelect2Data('/api/instructors/', 'filter-instructor', 'full_name', ['code', 'full_name']),
                loadSelect2Data('/api/curricula/', 'filter-class-curriculum', 'name', ['code', 'name', 'academic_year']),
                loadSelect2Data('/api/curricula/', 'filter-combined-curriculum', 'name', ['code', 'name', 'academic_year']),
                loadSelect2Data('/api/curricula/', 'filter-curriculum', 'name', ['code', 'name', 'academic_year']),
                loadSelect2Data('/api/courses/', 'filter-class-course', 'name', ['code', 'name']),
                loadSelect2Data('/api/departments/', 'filter-instructor-department', 'name', ['code', 'name']),
                loadSelect2Data('/api/subject-groups/', 'filter-instructor-subject-group', 'name', ['code', 'name'])
            ];
            
            // Khởi tạo Select2 sau khi tất cả dữ liệu đã tải
            //Promise.all(loadPromises).then(() => {
            //    console.log('All data loaded, initializing Select2...');
            //    setTimeout(initializeSelect2, 500);
            //}).catch(error => {
            //    console.error('Error loading initial data:', error);
            //    // Vẫn thử khởi tạo Select2 ngay cả khi có lỗi
            //    setTimeout(initializeSelect2, 500);
            //});

             // Tạo promises cho tất cả API calls
            const promises = [
                // Tải danh sách chương trình
                new Promise((resolve) => {
                    // Tải danh sách chương trình
                    fetch('/api/curricula/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allCurricula = data;
                            console.log('Loaded curricula:', data.length);
                            resolve();
                            // Cập nhật các dropdown cần thiết
                            //populateSelect2Dropdown('filter-class-curriculum', data, 'name', ['code', 'name', 'academic_year']);
                            //populateSelect2Dropdown('filter-combined-curriculum', data, 'name', ['code', 'name', 'academic_year']);
                            //populateSelect2Dropdown('filter-curriculum', data, 'name', ['code', 'name', 'academic_year']);
                        })
                        .catch(error => {
                            console.error('Error loading curricula:', error);
                            allCurricula = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách khóa học
                    fetch('/api/courses/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allCourses = data;
                            console.log('Loaded courses:', data.length);
                            resolve();
                            //populateSelect2Dropdown('filter-class-course', data, 'name', ['code', 'name']);
                        })
                        .catch(error => {
                            console.error('Error loading courses:', error);
                            allCourses = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách Đơn vị
                    fetch('/api/departments/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allDepartments = data;
                            console.log('Loaded Departments:', data.length);
                            resolve();
                            //populateSelect2Dropdown('filter-instructor-department', data, 'name', ['code', 'name']);
                            //populateSelect2Dropdown('department_id', data, 'name', ['code', 'name']);
                        })
                        .catch(error => {
                            console.error('Error loading Departments:', error);
                            allDepartments = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách tổ bộ môn
                    fetch('/api/subject-groups/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allSubjectGroups = data;
                            console.log('Loaded SubjectGroups:', data.length);
                            resolve();
                            //populateSelect2Dropdown('filter-instructor-subject-group', data, 'name', ['code', 'name']);
                        })
                        .catch(error => {
                            console.error('Error loading SubjectGroups:', error);
                            allSubjectGroups = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách môn học
                    fetch('/api/all-subjects/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allSubjects = data;
                            console.log('Loaded Subjects:', data.length);
                            resolve();
                            //populateSelect2Dropdown('curriculum_subject_id', data, 'name', ['code', 'name']);
                        })
                        .catch(error => {
                            console.error('Error loading Subjects:', error);
                            allSubjects = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách Giảng viên
                    fetch('/api/instructors/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allInstructors = data;
                            console.log('Loaded Instructors:', data.length);
                            resolve();
                            //populateSelect2Dropdown('filter-instructor', data, 'full_name', ['code', 'full_name']);
                            //populateSelect2Dropdown('instructor_id', data, 'full_name', ['code', 'full_name']);
                        })
                        .catch(error => {
                            console.error('Error loading Instructors:', error);
                            allInstructors = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách Lớp học
                    fetch('/api/classes/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allClasses = data;
                            console.log('Loaded classes:', data.length);
                            resolve();
                            //populateSelect2Dropdown('classes', data, 'name', ['code', 'name']);
                            //populateSelect2Dropdown('class_regular', data, 'name', ['code', 'name']);
                        })
                        .catch(error => {
                            console.error('Error loading classes:', error);
                            allClasses = [];
                            resolve();
                        });
                }),
                new Promise((resolve) => {
                    // Tải danh sách Lớp ghép
                    fetch('/api/combined-classes/')
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                        .then(data => {
                            allCombinedClasses = data;
                            console.log('Loaded CombinedClasses:', data.length);
                            resolve();
                            //populateSelect2Dropdown('class_combined', data, 'name', ['code', 'name']);
                        })
                        .catch(error => {
                            console.error('Error loading CombinedClasses:', error);
                            allCombinedClasses = [];
                            resolve();
                        });
                })
            ];
            return Promise.all(promises);
        }

		function disableOutsideSelect2() {
			// Đóng tất cả dropdown đang mở
			$('.select2-container--open').select2('close');
    
			// Vô hiệu hóa tất cả Select2 bên ngoài modal
			$('select.select2-hidden-accessible').not('.modal select').each(function() {
    			$(this).next('.select2-container').css('display', 'none').css('opacity', '0').css('pointer-events', 'none');
			});
		}

		// Hàm kích hoạt lại Select2 bên ngoài modal
		function enableOutsideSelect2() {
			$('select.select2-hidden-accessible').not('.modal select').each(function() {
    			$(this).next('.select2-container').css('opacity', '1').css('pointer-events', 'auto');
			});
		}

        // Thiết lập event listeners
        function setupEventListeners() {
            // Xử lý tab navigation
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.id.replace('tab-', '') + '-tab';
                    
                    // Ẩn tất cả tab panels
                    tabPanels.forEach(panel => {
                        panel.classList.add('hidden');
                        panel.classList.remove('active');
                    });
                    
                    // Hiển thị tab panel được chọn
                    document.getElementById(targetTab).classList.remove('hidden');
                    document.getElementById(targetTab).classList.add('active');
                    
                    // Cập nhật trạng thái tab buttons
                    tabButtons.forEach(btn => {
                        btn.classList.remove('border-blue-500', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    this.classList.add('border-blue-500', 'text-blue-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Cập nhật tiêu đề trang theo tab
                    updatePageTitle(this.textContent.trim());
                    
                    // Load dữ liệu cho tab được chọn
                    loadTabData(targetTab);
                });
            });

			// Khởi tạo Select2 khi trang tải xong
			setTimeout(initializeSelect2, 1000);
            
            // Xử lý modal lớp học
            document.getElementById('btn-them-lop-hoc').addEventListener('click', openThemLopHocModal);
            document.getElementById('btn-dong-lop-hoc').addEventListener('click', closeThemLopHocModal);
            document.getElementById('btn-huy-lop-hoc').addEventListener('click', closeThemLopHocModal);
            document.getElementById('btn-luu-lop-hoc').addEventListener('click', createLopHoc);

            // Xử lý checkbox lớp ghép
            document.getElementById('is_combined').addEventListener('change', function() {
                const combinedFields = document.getElementById('combined-class-fields');
                if (this.checked) {
                    combinedFields.classList.remove('hidden');
                } else {
                    combinedFields.classList.add('hidden');
                }
            });

            // Xử lý bộ lọc
            document.getElementById('btn-filter-classes').addEventListener('click', loadClassesData);
            document.getElementById('btn-filter-combined').addEventListener('click', loadCombinedClassesData);
            document.getElementById('btn-filter-instructors').addEventListener('click', loadInstructorsData);

            // Xử lý bộ lọc phân công giảng dạy
            document.getElementById('filter-instructor').addEventListener('change', loadTeachingAssignmentsData);
            document.getElementById('filter-curriculum').addEventListener('change', loadTeachingAssignmentsData);
            document.getElementById('filter-class-type-assignment').addEventListener('change', loadTeachingAssignmentsData);
            document.getElementById('filter-academic-year').addEventListener('input', loadTeachingAssignmentsData);

            // Xử lý modal lớp học ghép
            document.getElementById('btn-them-lop-ghep').addEventListener('click', openThemLopGhepModal);
            document.getElementById('btn-dong-lop-ghep').addEventListener('click', closeThemLopGhepModal);
            document.getElementById('btn-huy-lop-ghep').addEventListener('click', closeThemLopGhepModal);
            document.getElementById('btn-luu-lop-ghep').addEventListener('click', createLopGhep);

            // Xử lý modal phân công giảng dạy
            document.getElementById('btn-them-phan-cong').addEventListener('click', openThemPhanCongModal);
            document.getElementById('btn-dong-phan-cong').addEventListener('click', closeThemPhanCongModal);
            document.getElementById('btn-huy-phan-cong').addEventListener('click', closeThemPhanCongModal);
            document.getElementById('btn-luu-phan-cong').addEventListener('click', createPhanCong);

            // Xử lý thay đổi loại lớp trong modal phân công giảng dạy
            document.getElementById('class_type').addEventListener('change', function() {
                const classRegular = document.getElementById('class_regular');
                const classCombined = document.getElementById('class_combined');
                if (this.value === 'regular') {
                    classRegular.classList.remove('hidden');
                    classCombined.classList.add('hidden');
                } else if (this.value === 'combined') {
                    classRegular.classList.add('hidden');
                    classCombined.classList.remove('hidden');
                } else {
                    classRegular.classList.add('hidden');
                    classCombined.classList.add('hidden');
                }
            });

            // Điền dữ liệu dropdown khi mở modal thêm lớp học
            document.getElementById('btn-them-lop-hoc').addEventListener('click', function() {
                setTimeout(populateClassModalDropdowns, 100);
            });

            // Xử lý import
            document.getElementById('btn-download-template').addEventListener('click', function(e) {
                e.preventDefault();
                downloadTemplate();
            });

            document.getElementById('btn-huy-import').addEventListener('click', closeImportModal);
            document.getElementById('btn-dong-import').addEventListener('click', closeImportModal);
            document.getElementById('btn-luu-import').addEventListener('click', importExcel);

            document.getElementById('btn-close-errors').addEventListener('click', closeImportErrorsModal);
            document.getElementById('btn-dong-errors').addEventListener('click', closeImportErrorsModal);

            // Đóng modal khi click outside
            document.getElementById('modal-import').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportModal();
                }
            });

            document.getElementById('modal-import-errors').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeImportErrorsModal();
                }
            });

            document.getElementById('excel-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Gửi file đến server để lấy danh sách sheet
                    const formData = new FormData();
                    formData.append('excel_file', file);
                    
                    fetch('/api/get-sheet-names/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        const sheetSelection = document.getElementById('sheet-selection');
                        const sheetSelect = document.getElementById('selected-sheet');
                        
                        if (data.status === 'success' && data.sheet_names.length > 0) {
                            // Hiển thị dropdown chọn sheet
                            sheetSelection.classList.remove('hidden');
                            
                            // Điền danh sách sheet vào dropdown
                            sheetSelect.innerHTML = '<option value="">-- Chọn sheet --</option>';
                            data.sheet_names.forEach(sheetName => {
                                const option = document.createElement('option');
                                option.value = sheetName;
                                option.textContent = sheetName;
                                sheetSelect.appendChild(option);
                            });
                        } else {
                            sheetSelection.classList.add('hidden');
                        }
                    })
                    .catch(error => {
                        console.error('Error getting sheet names:', error);
                        document.getElementById('sheet-selection').classList.add('hidden');
                    });
                }
            });

            // Xử lý modal giảng viên
            document.getElementById('btn-them-giang-vien').addEventListener('click', openThemGiangVienModal);
            document.getElementById('btn-dong-giang-vien').addEventListener('click', closeThemGiangVienModal);
            document.getElementById('btn-huy-giang-vien').addEventListener('click', closeThemGiangVienModal);
            document.getElementById('btn-luu-giang-vien').addEventListener('click', createGiangVien);
			
            // NGĂN CHẶN HOÀN TOÀN SUBMIT FORM
			document.addEventListener('submit', function(e) {
                if (e.target.closest('form')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            });
        }

        // Hàm cập nhật tiêu đề trang
        function updatePageTitle(tabName) {
            const baseTitle = 'Quản lý Phân công Giảng dạy';
            document.title = `${baseTitle} - ${tabName}`;
            
            // Cũng có thể cập nhật tiêu đề h1 nếu muốn
            const mainTitle = document.querySelector('h1');
            if (mainTitle) {
                mainTitle.textContent = `QUẢN LÝ ${tabName.toUpperCase()}`;
            }
        }

        // Load dữ liệu cho tab
        function loadTabData(tabId) {
            switch(tabId) {
                case 'classes-tab':
                    loadClassesData();
                    break;
                case 'combined-classes-tab':
                    loadCombinedClassesData();
                    break;
                case 'teaching-assignments-tab':
                    loadTeachingAssignmentsData();
                    break;
                case 'instructors-tab':
                    loadInstructorsData();
                    break;
                case 'statistics-tab':
                    loadStatisticsData();
                    break;
            }
        }

        // Các hàm xử lý dữ liệu (giữ nguyên từ code trước)
        function populateDropdown(elementId, data, displayField) {
            const dropdown = document.getElementById(elementId);
            if (!dropdown) return;
            
            // Giữ option đầu tiên nếu có
            const firstOption = dropdown.options[0];
            dropdown.innerHTML = '';
            if (firstOption) {
                dropdown.appendChild(firstOption);
            }
            
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[displayField];
                if (item.academic_year) {
                    option.textContent += ` (${item.academic_year})`;
                }
                dropdown.appendChild(option);
            });
        }

        function loadClassesData() {
            const curriculumId = document.getElementById('filter-class-curriculum').value;
            const courseId = document.getElementById('filter-class-course').value;
            const isCombined = document.getElementById('filter-class-type').value;
            
            let url = '/api/classes/?';
            const params = [];
            
            if (curriculumId) params.push(`curriculum_id=${curriculumId}`);
            if (courseId) params.push(`course_id=${courseId}`);
            if (isCombined) params.push(`is_combined=${isCombined}`);
            
            url += params.join('&');
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
				}) 
                .then(data => {
                    const tbody = document.getElementById('classes-table-body');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                    Không có dữ liệu lớp học
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.forEach((classItem, index) => {
                        const row = document.createElement('tr');
						// Sử dụng hàm helper đã sửa
            			const curriculumName = getCurriculumName(classItem.curriculum || classItem.curriculum_id);
            			const courseName = getCourseName( classItem.course || classItem.course_id);
                        row.innerHTML = `
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${classItem.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${classItem.name || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${curriculumName}</td>
                			<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${courseName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${classItem.is_combined ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${classItem.is_combined ? 'Lớp ghép' : 'Lớp thường'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${classItem.start_date || 'Chưa có'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="editClass(${classItem.id})">Sửa</button>
                                <button class="text-red-600 hover:text-red-900" onclick="deleteClass(${classItem.id})">Xóa</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading classes:', error));
        }

        function loadCombinedClassesData() {
            const curriculumId = document.getElementById('filter-combined-curriculum').value;
            
            let url = '/api/combined-classes/';
            if (curriculumId) {
                url += `?curriculum_id=${curriculumId}`;
            }
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
				}) 
                .then(data => {
                    const tbody = document.getElementById('combined-classes-table-body');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    Không có dữ liệu lớp học ghép
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.forEach((combinedClass, index) => {
                        const row = document.createElement('tr');
						const curriculumName = getCurriculumName(combinedClass.curriculum || combinedClass.curriculum_id);
                        row.innerHTML = `
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${combinedClass.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${combinedClass.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${curriculumName}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${combinedClass.classes_count} lớp</td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                ${combinedClass.class_codes ? combinedClass.class_codes.join(', ') : 'Không có'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="editCombinedClass(${combinedClass.id})">Sửa</button>
                                <button class="text-red-600 hover:text-red-900" onclick="deleteCombinedClass(${combinedClass.id})">Xóa</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading combined classes:', error));
        }

		// Hàm tải dữ liệu giảng viên
        function loadInstructorsData() {
            const departmentId = document.getElementById('filter-instructor-department').value;
            const subjectGroupId = document.getElementById('filter-instructor-subject-group').value;
            const status = document.getElementById('filter-instructor-status').value;
            
            let url = '/api/instructors/?';
            const params = [];
            
            if (departmentId) params.push(`department_id=${departmentId}`);
            if (subjectGroupId) params.push(`subject_group_id=${subjectGroupId}`);
            if (status) params.push(`is_active=${status}`);
            
            url += params.join('&');
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
				}) 
                .then(data => {
                    const tbody = document.getElementById('instructors-table-body');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                    Không có dữ liệu giảng viên
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.forEach((instructorItem, index) => {
                        const row = document.createElement('tr');
						const departmentName = getDepartmentName(instructorItem.department || instructorItem.department_id);
						const subjectGroupName = getSubjectGroupName(instructorItem.subject_group || instructorItem.subject_group_id);
                        row.innerHTML = `
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${instructorItem.code}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${instructorItem.full_name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${instructorItem.email || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${instructorItem.phone || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${departmentName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${subjectGroupName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${instructorItem.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${instructorItem.is_active ? 'Đang hoạt động' : 'Ngừng hoạt động'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="editInstructor(${instructorItem.id})">Sửa</button>
                                <button class="text-red-600 hover:text-red-900" onclick="deleteInstructor(${instructorItem.id})">Xóa</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading instructors:', error));
        }

        function loadTeachingAssignmentsData() {
            const instructorFilter = document.getElementById('filter-instructor').value;
            const curriculumFilter = document.getElementById('filter-curriculum').value;
            const classTypeFilter = document.getElementById('filter-class-type-assignment').value;
            const academicYearFilter = document.getElementById('filter-academic-year').value;
            
            let url = '/api/teaching-assignments/?';
            const params = [];
            
            if (instructorFilter) params.push(`instructor_id=${instructorFilter}`);
            if (curriculumFilter) params.push(`curriculum_id=${curriculumFilter}`);
            if (classTypeFilter) params.push(`class_type=${classTypeFilter}`);
            if (academicYearFilter) params.push(`academic_year=${academicYearFilter}`);
            
            url += params.join('&');
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
				}) 
                .then(data => {
                    const tbody = document.getElementById('teaching-assignments-table-body');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" class="px-6 py-4 text-center text-gray-500">
                                    Không có dữ liệu phân công giảng dạy
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.forEach((assignment, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${assignment.instructor_name}</div>
                                <div class="text-sm text-gray-500">${assignment.instructor_code}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${assignment.subject_code}</div>
                                <div class="text-sm text-gray-500">${assignment.subject_name}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">${assignment.class_code}</div>
                                <div class="text-sm text-gray-500">${assignment.class_type === 'combined' ? '(Ghép)' : '(Thường)'}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.academic_year}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.semester}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${assignment.is_main_instructor ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                                    ${assignment.is_main_instructor ? 'Chính' : 'Phụ'}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.student_count}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.teaching_hours}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="editTeachingAssignment(${assignment.id})">Sửa</button>
                                <button class="text-red-600 hover:text-red-900" onclick="deleteTeachingAssignment(${assignment.id})">Xóa</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading teaching assignments:', error));
        }

        // Thêm hàm điền dữ liệu vào modal thêm lớp học
        function populateClassModalDropdowns() {
            console.log('Populating class modal dropdowns...');
            // Điền chương trình với tìm kiếm
			const curriculumSelect = $('select[name="curriculum_id"]');
			curriculumSelect.empty().append('<option value="">-- Chọn chương trình --</option>');

            if (allCurricula && allCurricula.length > 0) {
                allCurricula.forEach(curriculum => {
                    const option = new Option(
                        `${curriculum.name} (${curriculum.academic_year})`,
                        curriculum.id,
                        false,
                        false
                    );
                    $(option).data('search-text', `${curriculum.code} ${curriculum.name} ${curriculum.academic_year}`);
                    curriculumSelect.append(option);
                });
            } else {
                console.warn('No curricula data available');
            }
            
            // Điền khóa học với tìm kiếm
			const courseSelect = $('select[name="course_id"]');
			courseSelect.empty().append('<option value="">-- Chọn khóa học --</option>');
            if (allCourses && allCourses.length > 0) {
                allCourses.forEach(course => {
                    const option = new Option(course.name, course.id, false, false);
                    $(option).data('search-text', `${course.code} ${course.name}`);
                    courseSelect.append(option);
                });
            } else {
                console.warn('No courses data available');
            }

			// Khởi tạo lại Select2
			curriculumSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn chương trình...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
    
			courseSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn khóa học...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
        }

		function populateCombinedClassModalDropdowns() {
			// Điền chương trình với tìm kiếm
			const curriculumSelect = $('select[name="curriculum_id"]');
			curriculumSelect.empty().append('<option value="">-- Chọn chương trình --</option>');
			allCurricula.forEach(curriculum => {
    			const option = new Option(
        			`${curriculum.name} (${curriculum.academic_year})`,
        			curriculum.id,
        			false,
        			false
    			);
    			$(option).data('search-text', `${curriculum.code} ${curriculum.name} ${curriculum.academic_year}`);
    			curriculumSelect.append(option);
			});

			// Điền lớp học với tìm kiếm
			const classesSelect = $('select[name="classes"]');
			classesSelect.empty().append('<option value="">-- Chọn các lớp --</option>');
			allClasses.forEach(classItem => {
    			const option = new Option(
        			`${classItem.code} - ${classItem.name}`,
        			classItem.id,
        			false,
        			false
    			);
    			$(option).data('search-text', `${classItem.code} ${classItem.name}`);
    			classesSelect.append(option);
			});

			// Khởi tạo lại Select2
			curriculumSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn chương trình...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
    
			classesSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn các lớp...",
    			allowClear: true,
    			width: '100%',
    			closeOnSelect: false
			});
		}

		function populateTeachingAssignmentModalDropdowns() {
			// Điền giảng viên với tìm kiếm
			const instructorSelect = $('select[name="instructor_id"]');
			instructorSelect.empty().append('<option value="">-- Chọn giảng viên --</option>');
			allInstructors.forEach(instructor => {
    			const option = new Option(
        			`${instructor.full_name} (${instructor.code})`,
        			instructor.id,
        			false,
        			false
    			);
    			$(option).data('search-text', `${instructor.code} ${instructor.full_name}`);
    			instructorSelect.append(option);
			});

			// Điền môn học với tìm kiếm
			const subjectSelect = $('select[name="curriculum_subject_id"]');
			subjectSelect.empty().append('<option value="">-- Chọn môn học --</option>');
    
			fetch('/api/curriculum-subjects/')
    			.then(response => response.json())
    			.then(data => {
        			data.forEach(subject => {
            			const option = new Option(
                			`${subject.subject_code} - ${subject.subject_name}`,
                			subject.id,
                			false,
                			false
            			);
            			$(option).data('search-text', `${subject.subject_code} ${subject.subject_name}`);
            			subjectSelect.append(option);
        			});
            
        			subjectSelect.select2({
            			language: 'vi',
            			placeholder: "Chọn môn học...",
            			allowClear: true,
            			width: '100%',
            			minimumResultsForSearch: 0
        			});
    			});

			// Điền lớp học thường với tìm kiếm
			const classRegularSelect = $('#class_regular');
			classRegularSelect.empty().append('<option value="">-- Chọn lớp --</option>');
			allClasses.forEach(classItem => {
    			const option = new Option(
        			`${classItem.code} - ${classItem.name}`,
        			classItem.id,
        			false,
        			false
    			);
    			$(option).data('search-text', `${classItem.code} ${classItem.name}`);
    			classRegularSelect.append(option);
			});

			// Điền lớp học ghép với tìm kiếm
			const classCombinedSelect = $('#class_combined');
			classCombinedSelect.empty().append('<option value="">-- Chọn lớp ghép --</option>');
			allCombinedClasses.forEach(combinedClass => {
    			const option = new Option(
        			`${combinedClass.code} - ${combinedClass.name}`,
        			combinedClass.id,
        			false,
        			false
    			);
    			$(option).data('search-text', `${combinedClass.code} ${combinedClass.name}`);
    			classCombinedSelect.append(option);
			});

			// Khởi tạo lại Select2
			instructorSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn giảng viên...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
    
			classRegularSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn lớp...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
    
			classCombinedSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn lớp ghép...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
		}

		function populateInstructorModalDropdowns() {
			// Điền khoa với tìm kiếm
			const departmentSelect = $('select[name="department_id"]');
			departmentSelect.empty().append('<option value="">-- Chọn khoa --</option>');
			allDepartments.forEach(department => {
    			const option = new Option(department.name, department.id, false, false);
    			$(option).data('search-text', `${department.code} ${department.name}`);
    			departmentSelect.append(option);
			});

			// Điền tổ bộ môn với tìm kiếm
			const subjectGroupSelect = $('select[name="subject_group_id"]');
				subjectGroupSelect.empty().append('<option value="">-- Chọn tổ bộ môn --</option>');
			allSubjectGroups.forEach(subjectGroup => {
    			const option = new Option(subjectGroup.name, subjectGroup.id, false, false);
    			$(option).data('search-text', `${subjectGroup.code} ${subjectGroup.name}`);
    			subjectGroupSelect.append(option);
			});

			// Khởi tạo lại Select2
			departmentSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn khoa...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
    
			subjectGroupSelect.select2({
    			language: 'vi',
    			placeholder: "Chọn tổ bộ môn...",
    			allowClear: true,
    			width: '100%',
    			minimumResultsForSearch: 0
			});
		}
        
        function loadStatisticsData() {
            fetch('/api/teaching-statistics/')
                .then(response => response.json())
                .then(data => {
                    // Hiển thị thống kê theo giảng viên
                    const instructorStats = document.getElementById('instructor-stats');
                    instructorStats.innerHTML = '';
                    
                    if (data.instructor_statistics.length === 0) {
                        instructorStats.innerHTML = '<p class="text-gray-500">Không có dữ liệu</p>';
                    } else {
                        data.instructor_statistics.forEach(stat => {
                            const statItem = document.createElement('div');
                            statItem.className = 'bg-white p-3 rounded border mb-2';
                            statItem.innerHTML = `
                                <div class="font-medium text-gray-900">${stat.instructor__full_name}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <div>Phân công: ${stat.total_assignments}</div>
                                    <div>Số giờ: ${stat.total_hours || 0}</div>
                                    <div>Số lớp: ${stat.class_count || 0}</div>
                                    <div>Số môn: ${stat.subject_count}</div>
                                </div>
                            `;
                            instructorStats.appendChild(statItem);
                        });
                    }
                    
                    // Hiển thị thống kê theo chương trình
                    const curriculumStats = document.getElementById('curriculum-stats');
                    curriculumStats.innerHTML = '';
                    
                    if (data.curriculum_statistics.length === 0) {
                        curriculumStats.innerHTML = '<p class="text-gray-500">Không có dữ liệu</p>';
                    } else {
                        data.curriculum_statistics.forEach(stat => {
                            const statItem = document.createElement('div');
                            statItem.className = 'bg-white p-3 rounded border mb-2';
                            statItem.innerHTML = `
                                <div class="font-medium text-gray-900">${stat.curriculum_subject__curriculum__name}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <div>Phân công: ${stat.total_assignments}</div>
                                    <div>Giảng viên: ${stat.total_instructors}</div>
                                    <div>Môn học: ${stat.total_subjects}</div>
                                </div>
                            `;
                            curriculumStats.appendChild(statItem);
                        });
                    }
                    
                    // Hiển thị thống kê theo đơn vị
                    const departmentStats = document.getElementById('department-stats');
                    departmentStats.innerHTML = '';
                    
                    if (data.department_statistics.length === 0) {
                        departmentStats.innerHTML = '<p class="text-gray-500">Không có dữ liệu</p>';
                    } else {
                        data.department_statistics.forEach(stat => {
                            const statItem = document.createElement('div');
                            statItem.className = 'bg-white p-3 rounded border mb-2';
                            statItem.innerHTML = `
                                <div class="font-medium text-gray-900">${stat.instructor__department__name}</div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <div>Phân công: ${stat.total_assignments}</div>
                                    <div>Giảng viên: ${stat.total_instructors}</div>
                                    <div>Số giờ: ${stat.total_hours || 0}</div>
                                </div>
                            `;
                            departmentStats.appendChild(statItem);
                        });
                    }
                })
                .catch(error => console.error('Error loading statistics:', error));
        }

		function openThemLopHocModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // Đóng tất cả dropdown trước khi mở modal
            closeAllSelect2Dropdowns();
			// Vô hiệu hóa Select2 bên ngoài
			disableOutsideSelect2();
			// document.body.classList.add('modal-open');

            populateClassModalDropdowns();
            document.getElementById('modal-them-lop-hoc').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Khởi tạo lại Select2 sau khi modal hiển thị
            setTimeout(() => {
                // Hủy tất cả Select2 trong modal trước
                $('#modal-them-lop-hoc select').each(function() {
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2('destroy');
                    }
                });
                
                // Khởi tạo lại chỉ các dropdown trong modal này
                $('#modal-them-lop-hoc select').select2({
                    language: 'vi',
                    placeholder: "Chọn hoặc nhập để tìm kiếm...",
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#modal-them-lop-hoc'),
                    dropdownAutoWidth: true,
                    minimumResultsForSearch: 0
                });
            }, 100);
        }

		function openThemLopGhepModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

			closeAllSelect2Dropdowns();
			// Vô hiệu hóa Select2 bên ngoài
			disableOutsideSelect2();
			// document.body.classList.add('modal-open');
			
            populateCombinedClassModalDropdowns();
			document.getElementById('modal-them-lop-ghep').classList.remove('hidden');
			document.body.classList.add('overflow-hidden');
    
			setTimeout(() => {
    			// Hủy tất cả Select2 trong modal trước
                $('#modal-them-lop-ghep select').each(function() {
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2('destroy');
                    }
                });
                
                // Khởi tạo lại chỉ các dropdown trong modal này
                $('#modal-them-lop-ghep select').select2({
                    language: 'vi',
                    placeholder: "Chọn hoặc nhập để tìm kiếm...",
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#modal-them-lop-ghep'),
                    dropdownAutoWidth: true,
                    minimumResultsForSearch: 0
                });
            }, 100);
		}

		function openThemPhanCongModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

			// Đóng tất cả dropdown trước khi mở modal
            closeAllSelect2Dropdowns();
			// Vô hiệu hóa Select2 bên ngoài
			disableOutsideSelect2();
			// document.body.classList.add('modal-open');
			
			populateTeachingAssignmentModalDropdowns();
			document.getElementById('modal-them-phan-cong').classList.remove('hidden');
			document.body.classList.add('overflow-hidden');
    
			setTimeout(() => {
    			// Hủy tất cả Select2 trong modal trước
                $('#modal-them-phan-cong select').each(function() {
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2('destroy');
                    }
                });
                
                // Khởi tạo lại chỉ các dropdown trong modal này
                $('#modal-them-phan-cong select').select2({
                    language: 'vi',
                    placeholder: "Chọn hoặc nhập để tìm kiếm...",
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#modal-them-phan-cong'),
                    dropdownAutoWidth: true,
                    minimumResultsForSearch: 0
                });
            }, 100);
		}

		function openThemGiangVienModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

			// Đóng tất cả dropdown trước khi mở modal
            closeAllSelect2Dropdowns();
			// Vô hiệu hóa Select2 bên ngoài
			disableOutsideSelect2();
			// document.body.classList.add('modal-open');
			populateInstructorModalDropdowns();
			document.getElementById('modal-them-giang-vien').classList.remove('hidden');
			document.body.classList.add('overflow-hidden');
    
			setTimeout(() => {
    			// Hủy tất cả Select2 trong modal trước
                $('#modal-them-giang-vien select').each(function() {
                    if ($(this).hasClass('select2-hidden-accessible')) {
                        $(this).select2('destroy');
                    }
                });
                
                // Khởi tạo lại chỉ các dropdown trong modal này
                $('#modal-them-giang-vien select').select2({
                    language: 'vi',
                    placeholder: "Chọn hoặc nhập để tìm kiếm...",
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#modal-them-giang-vien'),
                    dropdownAutoWidth: true,
                    minimumResultsForSearch: 0
                });
            }, 100);
		}

		function closeThemLopHocModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // Đóng tất cả dropdown trước
            closeAllSelect2Dropdowns();
			// Kích hoạt lại Select2 bên ngoài
			enableOutsideSelect2();
			// document.body.classList.remove('modal-open');
			
			// Hủy Select2 trước khi đóng modal
			$('select').select2('destroy');
			document.getElementById('modal-them-lop-hoc').classList.add('hidden');
			document.body.classList.remove('overflow-hidden');
			// document.getElementById('form-them-lop-hoc').reset();
			setTimeout(() => {
                resetModalToAddState('modal-them-lop-hoc', 'form-them-lop-hoc', 'btn-luu-lop-hoc', '<i class="fas fa-save mr-2"></i>Lưu lớp học');
                initializeSelect2; // Khởi tạo lại Select2 cho các dropdown bên ngoài
            }, 100);
		}

		function closeThemLopGhepModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // Đóng tất cả dropdown trước
            closeAllSelect2Dropdowns();
			// Kích hoạt lại Select2 bên ngoài
			enableOutsideSelect2();
			// document.body.classList.remove('modal-open');
			
			$('select').select2('destroy');
			document.getElementById('modal-them-lop-ghep').classList.add('hidden');
			document.body.classList.remove('overflow-hidden');
			// document.getElementById('form-them-lop-ghep').reset();
			setTimeout(() => {
                resetModalToAddState('modal-them-lop-ghep', 'form-them-lop-ghep', 'btn-luu-lop-ghep', '<i class="fas fa-save mr-2"></i>Lưu lớp ghép');
                initializeSelect2; // Khởi tạo lại Select2 cho các dropdown bên ngoài
            }, 100);
		}

		function closeThemPhanCongModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // Đóng tất cả dropdown trước
            closeAllSelect2Dropdowns();
			// Kích hoạt lại Select2 bên ngoài
			enableOutsideSelect2();
			// document.body.classList.remove('modal-open');
			
			$('select').select2('destroy');
			document.getElementById('modal-them-phan-cong').classList.add('hidden');
			document.body.classList.remove('overflow-hidden');
			// document.getElementById('form-them-phan-cong').reset();
			setTimeout(() => {
                resetModalToAddState('modal-them-phan-cong', 'form-them-phan-cong', 'btn-luu-phan-cong', '<i class="fas fa-save mr-2"></i>Lưu phân công');
                // Khởi tạo lại Select2 cho các dropdown bên ngoài
                initializeSelect2;
            }, 100);
		}

		function closeThemGiangVienModal() {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            // Đóng tất cả dropdown trước
            closeAllSelect2Dropdowns();
			// Kích hoạt lại Select2 bên ngoài
			enableOutsideSelect2();
			// document.body.classList.remove('modal-open');
			
			$('select').select2('destroy');
			document.getElementById('modal-them-giang-vien').classList.add('hidden');
			document.body.classList.remove('overflow-hidden');
			// document.getElementById('form-them-giang-vien').reset();
			setTimeout(() => {
                resetModalToAddState('modal-them-giang-vien', 'form-them-giang-vien', 'btn-luu-giang-vien', '<i class="fas fa-save mr-2"></i>Lưu giảng viên');
                // Khởi tạo lại Select2 cho các dropdown bên ngoài
                initializeSelect2;
            }, 100);
		}

		function closeImportModal() {
            // Đóng tất cả dropdown trước
            closeAllSelect2Dropdowns();
			// Kích hoạt lại Select2 bên ngoài
			enableOutsideSelect2();
			// document.body.classList.remove('modal-open');
			
			$('select').select2('destroy');
			document.getElementById('modal-import').classList.add('hidden');
			document.body.classList.remove('overflow-hidden');
			document.getElementById('form-import').reset();
            // Khởi tạo lại Select2 cho các dropdown bên ngoài
            setTimeout(initializeSelect2, 100);
		}
        
        // Các hàm helper để xử lý cả object và ID
		function getCurriculumName(curriculum) {
			if (!curriculum) return 'N/A';
    
			if (typeof curriculum === 'object' && curriculum !== null) {
    			return curriculum.name || curriculum.code || 'N/A';
			}
    
			// Nếu curriculum là ID, tìm trong allCurricula
			if (allCurricula && allCurricula.length > 0) {
				const curriculumObj = allCurricula.find(c => c.id == curriculum);
				return curriculumObj ? (curriculumObj.name || curriculumObj.code || 'N/A') : 'N/A';
			}
            return 'N/A';
		}

		function getCourseName(course) {
			if (!course) return 'N/A';
    
			if (typeof course === 'object' && course !== null && course.code) {
    			return course.name || course.code || 'N/A';
			}
    
			// Nếu course là ID, tìm trong allCourses
            if (allCourses && allCourses.length > 0) {
                const courseObj = allCourses.find(c => c.id == course);
                return courseObj ? (courseObj.name || courseObj.code || 'N/A') : 'N/A';
            }
            return 'N/A';
		}

		function getDepartmentName(department) {
			if (!department) return 'N/A';
    
			if (typeof department === 'object' && department !== null && department.code) {
    			return department.name || department.code || 'N/A';
			}
    
			if (allDepartments && allDepartments.length > 0) {
                const departmentObj = allDepartments.find(d => d.id == department);
                return departmentObj ? (departmentObj.name || departmentObj.code || 'N/A') : 'N/A';
            }
            return 'N/A';
		}

		function getSubjectGroupName(subjectGroup) {
			if (!subjectGroup) return 'N/A';
    
			if (typeof subjectGroup === 'object' && subjectGroup !== null && subjectGroup.code) {
    			return subjectGroup.name || subjectGroup.code || 'N/A';
			}
    
			if (allSubjectGroups && allSubjectGroups.length > 0) {
                const subjectGroupObj = allSubjectGroups.find(sg => sg.id == subjectGroup);
                return subjectGroupObj ? (subjectGroupObj.name || subjectGroupObj.code || 'N/A') : 'N/A';
            }
            return 'N/A';
		}

        function createLopHoc() {
            const form = document.getElementById('form-them-lop-hoc');
            const formData = new FormData(form);
            
            // Chuẩn bị dữ liệu
            const data = {
                code: formData.get('code'),
                name: formData.get('name'),
                curriculum_id: formData.get('curriculum_id'),
                course_id: formData.get('course_id'),
                is_combined: formData.get('is_combined') === 'on',
                description: formData.get('description')
            };
            
            // Xử lý ngày tháng - chỉ thêm nếu có giá trị
            const startDate = formData.get('start_date');
            if (startDate) {
                data.start_date = startDate;
            }
            
            const endDate = formData.get('end_date');
            if (endDate) {
                data.end_date = endDate;
            }
            
            // Xử lý mã lớp ghép - chỉ thêm nếu có giá trị và là lớp ghép
            if (data.is_combined) {
                const combinedClassCode = formData.get('combined_class_code');
                if (combinedClassCode) {
                    data.combined_class_code = combinedClassCode;
                }
            }
            
            // Validate
            if (!data.code || !data.name || !data.curriculum_id || !data.course_id) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }

            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-lop-hoc');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;
            
            // Gửi request tạo lớp học
            fetch('/api/classes/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo lớp học thành công!');
                    closeThemLopHocModal();
                    loadClassesData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi tạo lớp học: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        function createLopGhep() {
            const form = document.getElementById('form-them-lop-ghep');
            const formData = new FormData(form);
            const data = {
                code: formData.get('code'),
                name: formData.get('name'),
                curriculum_id: formData.get('curriculum_id'),
                classes: Array.from(formData.getAll('classes')).map(id => parseInt(id))
            };

            // Xử lý description - chỉ thêm nếu có giá trị
            const description = formData.get('description');
            if (description) {
                data.description = description;
            }

            // Validate
            if (!data.code || !data.name || !data.curriculum_id || data.classes.length === 0) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }

            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-lop-ghep');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;

            // Gửi request tạo lớp ghép
            fetch('/api/combined-classes/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo lớp ghép thành công!');
                    closeThemLopGhepModal();
                    loadCombinedClassesData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi tạo lớp ghép: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        function createPhanCong() {
            const form = document.getElementById('form-them-phan-cong');
            const formData = new FormData(form);
            const classType = formData.get('class_type');
            const data = {
                instructor_id: formData.get('instructor_id'),
                curriculum_subject_id: formData.get('curriculum_subject_id'),
                academic_year: formData.get('academic_year'),
                semester: formData.get('semester'),
                is_main_instructor: formData.get('is_main_instructor') === 'on',
                student_count: parseInt(formData.get('student_count')) || 0,
                teaching_hours: parseInt(formData.get('teaching_hours')) || 0
            };

            // Thêm class_obj hoặc combined_class tùy loại
            if (classType === 'regular') {
                data.class_obj_id = formData.get('class_id');
            } else if (classType === 'combined') {
                data.combined_class_id = formData.get('combined_class_id');
            }

            // Validate
            if (!data.instructor_id || !data.curriculum_subject_id || !data.academic_year || !data.semester) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }

            if (!data.class_obj_id && !data.combined_class_id) {
                alert('Vui lòng chọn lớp học');
                return;
            }

            // Gửi request tạo phân công
            fetch('/api/teaching-assignments/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Đã tạo phân công giảng dạy thành công');
                    closeThemPhanCongModal();
                    loadTeachingAssignmentsData();
                } else {
                    alert('Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tạo phân công');
            });
        }

        

        // Hàm điền dropdown cho modal giảng viên
        function populateInstructorModalDropdowns() {
            // Điền khoa
            const departmentSelect = document.querySelector('#form-them-giang-vien select[name="department_id"]');
            if (departmentSelect) {
                departmentSelect.innerHTML = '<option value="">-- Chọn khoa --</option>';
                allDepartments.forEach(department => {
                    const option = document.createElement('option');
                    option.value = department.id;
                    option.textContent = department.name;
                    departmentSelect.appendChild(option);
                });
            }

            // Điền tổ bộ môn
            const subjectGroupSelect = document.querySelector('#form-them-giang-vien select[name="subject_group_id"]');
            if (subjectGroupSelect) {
                subjectGroupSelect.innerHTML = '<option value="">-- Chọn tổ bộ môn --</option>';
                allSubjectGroups.forEach(subjectGroup => {
                    const option = document.createElement('option');
                    option.value = subjectGroup.id;
                    option.textContent = subjectGroup.name;
                    subjectGroupSelect.appendChild(option);
                });
            }
        }

        function createGiangVien() {
            const form = document.getElementById('form-them-giang-vien');
            const formData = new FormData(form);
            const data = {
                code: formData.get('code'),
                full_name: formData.get('full_name'),
                email: formData.get('email') || null,
                phone: formData.get('phone') || null,
                department_id: formData.get('department_id') || null,
                subject_group_id: formData.get('subject_group_id') || null,
                is_active: formData.get('is_active') === 'on'
            };

            // Validate
            if (!data.code || !data.full_name) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc');
                return;
            }

            // Hiển thị loading
            const saveBtn = document.getElementById('btn-luu-giang-vien');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo...';
            saveBtn.disabled = true;

            // Gửi request tạo giảng viên
            fetch('/api/instructors/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ Đã tạo giảng viên thành công!');
                    closeThemGiangVienModal();
                    loadInstructorsData();
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi tạo giảng viên: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            });
        }

        // Biến lưu trữ loại đối tượng đang import
        let currentImportObjectType = '';

        // Hàm mở modal import
        function openImportModal(objectType) {
			closeAllSelect2Dropdowns();
			disableOutsideSelect2();
			// document.body.classList.add('modal-open');
			
            currentImportObjectType = objectType;
            
            // Đặt tiêu đề và nội dung theo loại đối tượng
            const modalTitle = document.getElementById('import-modal-title');
            const notesTitle = document.getElementById('import-notes-title');
            const notesList = document.getElementById('import-notes-list');
            
            let title = '';
            let notes = [];
            
            switch(objectType) {
                case 'class':
                    title = 'Import Lớp học';
                    notes = [
                        'File Excel phải theo đúng định dạng mẫu',
                        'Các cột bắt buộc: Mã lớp*, Tên lớp*, Mã chương trình*, Mã khóa học*',
                        'Mã lớp không được trùng',
                        'Mã chương trình và Mã khóa học phải tồn tại trong hệ thống'
                    ];
                    break;
                case 'combined-class':
                    title = 'Import Lớp học ghép';
                    notes = [
                        'File Excel phải theo đúng định dạng mẫu',
                        'Các cột bắt buộc: Mã lớp ghép*, Tên lớp ghép*, Mã chương trình*, Mã các lớp thành phần*',
                        'Mã lớp ghép không được trùng',
                        'Mã chương trình và các mã lớp thành phần phải tồn tại trong hệ thống',
                        'Các mã lớp thành phần phân cách bằng dấu phẩy'
                    ];
                    break;
                case 'instructor':
                    title = 'Import Giảng viên';
                    notes = [
                        'File Excel phải theo đúng định dạng mẫu',
                        'Các cột bắt buộc: Mã giảng viên*, Họ và tên*',
                        'Mã giảng viên không được trùng',
                        'Email phải đúng định dạng',
                        'Mã khoa và mã tổ bộ môn phải tồn tại trong hệ thống (nếu có)'
                    ];
                    break;
                case 'teaching-assignment':
                    title = 'Import Phân công giảng dạy';
                    notes = [
                        'File Excel phải theo đúng định dạng mẫu',
                        'Các cột bắt buộc: Mã giảng viên*, Mã môn học*, Mã lớp*, Loại lớp*, Năm học*, Học kỳ*',
                        'Mã giảng viên, Mã môn học, Mã lớp phải tồn tại trong hệ thống',
                        'Loại lớp phải là "Thường" hoặc "Ghép"',
                        'Học kỳ phải là số từ 1 đến 12'
                    ];
                    break;
            }
            
            modalTitle.textContent = title;
            notesTitle.textContent = `Lưu ý khi import ${title.toLowerCase()}:`;
            notesList.innerHTML = notes.map(note => `<li>${note}</li>`).join('');
            
            document.getElementById('modal-import').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        // Hàm tải template
        function downloadTemplate() {
            if (!currentImportObjectType) return;
            
            const url = `/import-teaching-data/${currentImportObjectType}/`;
            window.open(url, '_blank');
        }

        // Hàm import Excel
        function importExcel() {
            const form = document.getElementById('form-import');
            const formData = new FormData(form);
            const fileInput = document.getElementById('excel-file');
            const selectedSheet = document.getElementById('selected-sheet').value;
            
            if (!fileInput.files.length) {
                alert('Vui lòng chọn file Excel');
                return;
            }
            
            // Thêm sheet được chọn vào formData
            if (selectedSheet) {
                formData.append('selected_sheet', selectedSheet);
            }
            
            // Hiển thị loading
            const importBtn = document.getElementById('btn-luu-import');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang xử lý...';
            importBtn.disabled = true;
            
            fetch(`/import-teaching-data/${currentImportObjectType}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('✅ ' + data.message);
                    closeImportModal();
                    
                    // Hiển thị chi tiết lỗi nếu có
                    if (data.errors && data.errors.length > 0) {
                        showImportErrors(data.errors);
                    }
                    
                    // Reload dữ liệu theo tab hiện tại
                    const activeTab = document.querySelector('.tab-panel.active');
                    if (activeTab.id === 'classes-tab') {
                        loadClassesData();
                    } else if (activeTab.id === 'combined-classes-tab') {
                        loadCombinedClassesData();
                    } else if (activeTab.id === 'teaching-assignments-tab') {
                        loadTeachingAssignmentsData();
                    }
                } else {
                    alert('❌ Lỗi: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Có lỗi xảy ra khi import file: ' + error.message);
            })
            .finally(() => {
                // Khôi phục trạng thái nút
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
            });
        }

        // Hàm hiển thị lỗi import
        function showImportErrors(errors) {
            const errorsContent = document.getElementById('import-errors-content');
            if (errors && errors.length > 0) {
                errorsContent.innerHTML = `
                    <div class="mb-3 p-3 bg-red-50 border border-red-200 rounded">
                        <h4 class="font-semibold text-red-800 mb-2">Có ${errors.length} lỗi cần xem xét:</h4>
                    </div>
                    <div class="space-y-2">
                        ${errors.map(error => 
                            `<div class="flex items-start text-red-700 py-2 border-b border-red-100">
                                <i class="fas fa-exclamation-circle mt-1 mr-2 text-red-500 flex-shrink-0"></i>
                                <span class="text-sm">${error}</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
            } else {
                errorsContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <div class="text-green-600 font-semibold">Không có lỗi nào trong quá trình import</div>
                    </div>
                `;
            }
            openImportErrorsModal();
        }

        // Hàm mở/đóng modal lỗi
        function openImportErrorsModal() {
			closeAllSelect2Dropdowns();
			// document.body.classList.add('modal-open');
            document.getElementById('modal-import-errors').classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeImportErrorsModal() {
			closeAllSelect2Dropdowns();
			// document.body.classList.remove('modal-open');
            document.getElementById('modal-import-errors').classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }
        // Hàm lấy CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Hàm sửa lớp học
		function editClass(id) {
			fetch(`/api/classes/${id}/`)
    			.then(response => {
					if (!response.ok) {
            			throw new Error('Network response was not ok');
        			}
        			return response.json();
    			})
    			.then(data => {
					// Kiểm tra status của response
        			if (data.status === 'success' && data.data) {
            			const classData = data.data;
        				// Điền dữ liệu vào form
        				document.querySelector('#form-them-lop-hoc input[name="code"]').value = classData.code;
        				document.querySelector('#form-them-lop-hoc input[name="name"]').value = classData.name;
        				document.querySelector('#form-them-lop-hoc input[name="start_date"]').value = classData.start_date;
        				document.querySelector('#form-them-lop-hoc input[name="end_date"]').value = classData.end_date;
        				document.querySelector('#form-them-lop-hoc input[name="is_combined"]').checked = classData.is_combined;
        				document.querySelector('#form-them-lop-hoc textarea[name="description"]').value = classData.description || '';

						// Xử lý trường combined_class_code
        				if (classData.is_combined && classData.combined_class_code) {
            				document.querySelector('#form-them-lop-hoc input[name="combined_class_code"]').value = classData.combined_class_code;
        				}
            
        				// Hiển thị/ẩn combined fields
        				const combinedFields = document.getElementById('combined-class-fields');
        				if (classData.is_combined) {
            				combinedFields.classList.remove('hidden');
        				} else {
            				combinedFields.classList.add('hidden');
        				}
        				// Hiển thị modal
        				openThemLopHocModal();

						// Cập nhật Select2 sau khi điền giá trị
            			setTimeout(() => {
							const curriculumSelect = $('select[name="curriculum_id"]');
                			const courseSelect = $('select[name="course_id"]');
                    
                			curriculumSelect.val(classData.curriculum_id || '').trigger('change');
                			courseSelect.val(classData.course_id || '').trigger('change');
							
                			$('#modal-them-lop-hoc select').trigger('change.select2');
            			}, 500);
            
        				// Đổi tiêu đề và hành động của nút
        				document.querySelector('#modal-them-lop-hoc h3').textContent = 'Sửa lớp học';
        				const saveBtn = document.getElementById('btn-luu-lop-hoc');
        				saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật lớp học';
        				saveBtn.onclick = function(e) { 
							updateLopHoc(id, e);
							return false;
						};
        			} else {
            			alert('Không thể tải dữ liệu lớp học: ' + (data.message || 'Lỗi không xác định'));
        			}
    			})
    			.catch(error => {
        			console.error('Error loading class data:', error);
        			alert('Không thể tải dữ liệu lớp học');
    			});
		}

		let isLopUpdating = false;
		// Hàm cập nhật lớp học
		function updateLopHoc(id, event) {
			
			// Ngăn sự kiện mặc định nếu có
			if (event) {
    			event.preventDefault();
    			event.stopPropagation();
				event.stopImmediatePropagation();
			}
			// Ngăn chặn gọi nhiều lần
			if (isLopUpdating) {
    			return false;
			}
			const form = document.getElementById('form-them-lop-hoc');
			const formData = new FormData(form);
    
			const data = {
    			code: formData.get('code'),
    			name: formData.get('name'),
    			curriculum_id: formData.get('curriculum_id'),
    			course_id: formData.get('course_id'),
    			is_combined: formData.get('is_combined') === 'on',
    			description: formData.get('description')
			};

			// Xử lý ngày tháng
			const startDate = formData.get('start_date');
			if (startDate) data.start_date = startDate;
    
			const endDate = formData.get('end_date');
			if (endDate) data.end_date = endDate;
    
			if (data.is_combined) {
    			const combinedClassCode = formData.get('combined_class_code');
    			if (combinedClassCode) data.combined_class_code = combinedClassCode;
			}

			// Validate
			if (!data.code || !data.name || !data.curriculum_id || !data.course_id) {
    			alert('Vui lòng điền đầy đủ các trường bắt buộc');
    			return false;
			}
			// Đánh dấu đang cập nhật
			isLopUpdating = true;
			
			// Hiển thị loading
			const saveBtn = document.getElementById('btn-luu-lop-hoc');
			const originalText = saveBtn.innerHTML;
			const originalOnClick = saveBtn.onclick;
			saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang cập nhật...';
			saveBtn.disabled = true;
			saveBtn.onclick = null; // Tạm thời vô hiệu hóa onclick
    
			// Gửi request cập nhật
			fetch(`/api/classes/update/${id}/`, {
    			method: 'PUT',
    			headers: {
        			'Content-Type': 'application/json',
        			'X-CSRFToken': getCookie('csrftoken'),
    			},
    			body: JSON.stringify(data)
			})
			.then(response => {
    			if (!response.ok) {
        			throw new Error('Network response was not ok: ' + response.status);
    			}
    			return response.json();
			}) 
			.then(data => {
    			if (data.status === 'success') {
        			alert('✅ Đã cập nhật lớp học thành công!');
        			closeThemLopHocModal();
        			loadClassesData();
    			} else {
        			alert('❌ Lỗi: ' + data.message);
    			}
			})
			.catch(error => {
    			console.error('Error:', error);
    			alert('❌ Có lỗi xảy ra khi cập nhật lớp học');
			})
			.finally(() => {
    			saveBtn.innerHTML = originalText;
    			saveBtn.disabled = false;
				saveBtn.onclick = originalOnClick;
				isLopUpdating = false;
			});
			return false; // Ngăn form submit mặc định
		}

		// Hàm xóa lớp học
		function deleteClass(id) {
			if (confirm('Bạn có chắc chắn muốn xóa lớp học này? Hành động này không thể hoàn tác.')) {
    			fetch(`/api/classes/delete/${id}/`, {
        			method: 'DELETE',
        			headers: {
            			'X-CSRFToken': getCookie('csrftoken'),
        			},
    			})
    			.then(response => response.json())
    			.then(data => {
        			if (data.status === 'success') {
            			alert('✅ Đã xóa lớp học thành công!');
            			loadClassesData();
        			} else {
            			alert('❌ Lỗi: ' + data.message);
        			}
    			})
    			.catch(error => {
        			console.error('Error:', error);
        			alert('❌ Có lỗi xảy ra khi xóa lớp học');
    			});
			}
		}

		// Hàm sửa lớp ghép
		function editCombinedClass(id) {
			fetch(`/api/combined-classes/${id}/`)
    			.then(response =>  {
        			if (!response.ok) {
            			throw new Error('Network response was not ok');
        			}
					return response.json();
				})
    			.then(data => {
					if (data.status === 'success' && data.data) {
            			const classData = data.data;
        				document.querySelector('#form-them-lop-ghep input[name="code"]').value = classData.code;
        				document.querySelector('#form-them-lop-ghep input[name="name"]').value = classData.name;
        				// document.querySelector('#form-them-lop-ghep select[name="curriculum_id"]').value = classData.curriculum_id;
        				document.querySelector('#form-them-lop-ghep textarea[name="description"]').value = classData.description || '';
            
        				// Điền các lớp thành phần
        				if (classData.classes && classData.classes.length > 0) {
            				const classIds = classData.classes.map(cls => cls.id);
            				$('#classes').val(classIds).trigger('change');
        				}
            
        				openThemLopGhepModal();

						// Điền các lớp thành phần - SỬA: chờ Select2 khởi tạo xong
            			if (classData.classes && classData.classes.length > 0) {
                			const classIds = classData.classes.map(cls => cls.id);
                			// Đợi modal mở và Select2 khởi tạo
                			setTimeout(() => {
                    			const classesSelect = $('#classes');
								const curriculumSelect = $('select[name="curriculum_id"]');
                    
                				curriculumSelect.val(classData.curriculum_id || '').trigger('change');

                    			if (classesSelect.length) {
                        			classesSelect.val(classIds).trigger('change');
                    			}
                                $('#modal-them-lop-ghep select').trigger('change.select2');
                			}, 500);
						}
        				document.querySelector('#modal-them-lop-ghep h3').textContent = 'Sửa lớp ghép';
        				const saveBtn = document.getElementById('btn-luu-lop-ghep');
        				saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật lớp ghép';
        				saveBtn.onclick = function(e) { 
							updateLopGhep(id, e);
							return false;
						};
        			} else {
            			alert('Không thể tải dữ liệu lớp ghép: ' + (data.message || 'Lỗi không xác định'));
        			}
    			})
    			.catch(error => {
        			console.error('Error loading combined class data:', error);
        			alert('Không thể tải dữ liệu lớp ghép');
    			});
		}

		let isLopGhepUpdating = false;
		function updateLopGhep(id, event) {
			// Ngăn sự kiện mặc định nếu có
			if (event) {
    			event.preventDefault();
    			event.stopPropagation();
				event.stopImmediatePropagation();
			}
			// Ngăn chặn gọi nhiều lần
			if (isLopGhepUpdating) {
    			return false;
			}
			const form = document.getElementById('form-them-lop-ghep');
			const formData = new FormData(form);
			const data = {
    			code: formData.get('code'),
    			name: formData.get('name'),
    			curriculum_id: formData.get('curriculum_id'),
    			classes: Array.from(formData.getAll('classes')).map(id => parseInt(id))
			};

			const description = formData.get('description');
			if (description) data.description = description;

			isLopGhepUpdating = true;
			
			const saveBtn = document.getElementById('btn-luu-lop-ghep');
			const originalText = saveBtn.innerHTML;
			const originalOnClick = saveBtn.onclick;
			saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang cập nhật...';
			saveBtn.disabled = true;
			saveBtn.onclick = null;

			fetch(`/api/combined-classes/update/${id}/`, {
    			method: 'PUT',
    			headers: {
        			'Content-Type': 'application/json',
        			'X-CSRFToken': getCookie('csrftoken'),
    			},
    			body: JSON.stringify(data)
			})
			.then(response => response.json())
			.then(data => {
    			if (data.status === 'success') {
        			alert('✅ Đã cập nhật lớp ghép thành công!');
        			closeThemLopGhepModal();
        			loadCombinedClassesData();
    			} else {
        			alert('❌ Lỗi: ' + data.message);
    			}
			})
			.catch(error => {
    			console.error('Error:', error);
    			alert('❌ Có lỗi xảy ra khi cập nhật lớp ghép');
			})
			.finally(() => {
    			saveBtn.innerHTML = originalText;
    			saveBtn.disabled = false;
				saveBtn.onclick = originalOnClick
				isLopGhepUpdating = false;
			});
			return false;
		}

		function deleteCombinedClass(id) {
			if (confirm('Bạn có chắc chắn muốn xóa lớp ghép này? Hành động này không thể hoàn tác.')) {
    			fetch(`/api/combined-classes/delete/${id}/`, {
        			method: 'DELETE',
        			headers: {
            			'X-CSRFToken': getCookie('csrftoken'),
        			},
    			})
    			.then(response => response.json())
    			.then(data => {
        			if (data.status === 'success') {
            			alert('✅ Đã xóa lớp ghép thành công!');
            			loadCombinedClassesData();
        			} else {
            			alert('❌ Lỗi: ' + data.message);
        			}
    			})
    			.catch(error => {
        			console.error('Error:', error);
        			alert('❌ Có lỗi xảy ra khi xóa lớp ghép');
    			});
			}
		}

		// Hàm sửa giảng viên
		function editInstructor(id) {
			fetch(`/api/instructors/${id}/`)
    			.then(response => {
        			if (!response.ok) {
            			throw new Error('Network response was not ok');
        			}
        			return response.json();
				})
    			.then(data => {
					if (data.status === 'success' && data.data) {
            			const instructorData = data.data;
        				document.querySelector('#form-them-giang-vien input[name="code"]').value = instructorData.code;
        				document.querySelector('#form-them-giang-vien input[name="full_name"]').value = instructorData.full_name;
        				document.querySelector('#form-them-giang-vien input[name="email"]').value = instructorData.email || '';
        				document.querySelector('#form-them-giang-vien input[name="phone"]').value = instructorData.phone || '';
        				// document.querySelector('#form-them-giang-vien select[name="department_id"]').value = instructorData.department_id;
        				// document.querySelector('#form-them-giang-vien select[name="subject_group_id"]').value = instructorData.subject_group_id;
        				document.querySelector('#form-them-giang-vien input[name="is_active"]').checked = instructorData.is_active;
            
        				openThemGiangVienModal();

						// Cập nhật Select2
            			setTimeout(() => {
							const departmentSelect = $('select[name="department_id"]');
                			const subjectGroupSelect = $('select[name="subject_group_id"]');
                    
                			departmentSelect.val(instructorData.department_id || '').trigger('change');
                			subjectGroupSelect.val(instructorData.subject_group_id || '').trigger('change');
                			
                            $('#modal-them-giang-vien select').trigger('change.select2');
            			}, 500);
						
        				document.querySelector('#modal-them-giang-vien h3').textContent = 'Sửa giảng viên';
        				const saveBtn = document.getElementById('btn-luu-giang-vien');
        				saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật giảng viên';
        				saveBtn.onclick = function(e) { 
							updateInstructor(id, e);
							return false;
						};
        			} else {
            			alert('Không thể tải dữ liệu giảng viên: ' + (data.message || 'Lỗi không xác định'));
        			}
    			})
    			.catch(error => {
        			console.error('Error loading instructor data:', error);
        			alert('Không thể tải dữ liệu giảng viên');
    			});
		}

		let isInstructorUpdate = false;
		function updateInstructor(id, event) {
			// Ngăn sự kiện mặc định nếu có
			if (event) {
    			event.preventDefault();
    			event.stopPropagation();
				event.stopImmediatePropagation();
			}
			// Ngăn chặn gọi nhiều lần
			if (isInstructorUpdate) {
    			return false;
			}
			const form = document.getElementById('form-them-giang-vien');
			const formData = new FormData(form);
			const data = {
    			code: formData.get('code'),
    			full_name: formData.get('full_name'),
    			email: formData.get('email') || null,
    			phone: formData.get('phone') || null,
    			department_id: formData.get('department_id') || null,
    			subject_group_id: formData.get('subject_group_id') || null,
    			is_active: formData.get('is_active') === 'on'
			};

			isInstructorUpdate = true;
			const saveBtn = document.getElementById('btn-luu-giang-vien');
			const originalText = saveBtn.innerHTML;
			const originalOnClick = saveBtn.onclick;
			saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang cập nhật...';
			saveBtn.disabled = true;
			saveBtn.onclick = null;

			fetch(`/api/instructors/update/${id}/`, {
    			method: 'PUT',
    			headers: {
        			'Content-Type': 'application/json',
        			'X-CSRFToken': getCookie('csrftoken'),
    			},
    			body: JSON.stringify(data)
			})
			.then(response => {
    			if (!response.ok) {
        			throw new Error('Network response was not ok: ' + response.status);
    			}
    			return response.json();
			}) 
			.then(data => {
    			if (data.status === 'success') {
        			alert('✅ Đã cập nhật giảng viên thành công!');
        			closeThemGiangVienModal();
        			loadInstructorsData();
    			} else {
        			alert('❌ Lỗi: ' + data.message);
    			}
			})
			.catch(error => {
    			console.error('Error:', error);
    			alert('❌ Có lỗi xảy ra khi cập nhật giảng viên');
			})
			.finally(() => {
    			saveBtn.innerHTML = originalText;
    			saveBtn.disabled = false;
				saveBtn.onclick = originalOnClick;
				isInstructorUpdate = false;
			});
			return false;
		}

		function deleteInstructor(id) {
			if (confirm('Bạn có chắc chắn muốn xóa giảng viên này? Hành động này không thể hoàn tác.')) {
    			fetch(`/api/instructors/delete/${id}/`, {
        			method: 'DELETE',
        			headers: {
            			'X-CSRFToken': getCookie('csrftoken'),
        			},
    			})
    			.then(response => response.json())
    			.then(data => {
        			if (data.status === 'success') {
            			alert('✅ Đã xóa giảng viên thành công!');
            			loadInstructorsData();
        			} else {
            			alert('❌ Lỗi: ' + data.message);
        			}
    			})
    			.catch(error => {
        			console.error('Error:', error);
        			alert('❌ Có lỗi xảy ra khi xóa giảng viên');
    			});
			}
		}

		// Hàm sửa phân công giảng dạy
		function editTeachingAssignment(id) {
			fetch(`/api/teaching-assignments/${id}/`)
    			.then(response => {
        			if (!response.ok) {
            			throw new Error('Network response was not ok');
        			}
        			return response.json();
    			})
    			.then(data => {
					if (data.status === 'success' && data.data) {
            			const assignmentData = data.data;
        				// document.querySelector('#form-them-phan-cong select[name="instructor_id"]').value = assignmentData.instructor_id;
        				// document.querySelector('#form-them-phan-cong select[name="curriculum_subject_id"]').value = assignmentData.curriculum_subject_id;
        				document.querySelector('#form-them-phan-cong input[name="academic_year"]').value = assignmentData.academic_year;
        				document.querySelector('#form-them-phan-cong select[name="semester"]').value = assignmentData.semester;
        				document.querySelector('#form-them-phan-cong input[name="is_main_instructor"]').checked = assignmentData.is_main_instructor;
        				document.querySelector('#form-them-phan-cong input[name="student_count"]').value = assignmentData.student_count;
        				document.querySelector('#form-them-phan-cong input[name="teaching_hours"]').value = assignmentData.teaching_hours;
            
        				// Xử lý loại lớp và lớp tương ứng
        				if (assignmentData.class_obj_id) {
            				document.querySelector('#form-them-phan-cong select[name="class_type"]').value = 'regular';
            				document.querySelector('#form-them-phan-cong select[name="class_id"]').value = assignmentData.class_obj_id;
        				} else if (assignmentData.combined_class_id) {
            				document.querySelector('#form-them-phan-cong select[name="class_type"]').value = 'combined';
            				document.querySelector('#form-them-phan-cong select[name="combined_class_id"]').value = assignmentData.combined_class_id;
        				}
            
        				// Kích hoạt sự kiện change để hiển thị đúng dropdown
        				document.querySelector('#form-them-phan-cong select[name="class_type"]').dispatchEvent(new Event('change'));
            
        				openThemPhanCongModal();
        				
						// Xử lý loại lớp và lớp tương ứng - SỬA: thêm timeout
            			setTimeout(() => {
                			const classTypeSelect = document.querySelector('#form-them-phan-cong select[name="class_type"]');
							const curriculumSubjectSelect = $('select[name="curriculum_subject_id"]');
                			const instructorSelect = $('select[name="instructor_id"]');
                    
                			instructorSelect.val(assignmentData.instructor_id || '').trigger('change');
                			curriculumSubjectSelect.val(assignmentData.curriculum_subject_id || '').trigger('change');
                    
                			if (assignmentData.class_obj_id) {
                    			classTypeSelect.value = 'regular';
                    			document.querySelector('#form-them-phan-cong select[name="class_id"]').value = assignmentData.class_obj_id;
                			} else if (assignmentData.combined_class_id) {
                    			classTypeSelect.value = 'combined';
                    			document.querySelector('#form-them-phan-cong select[name="combined_class_id"]').value = assignmentData.combined_class_id;
                			}
                    
                			// Kích hoạt sự kiện change để hiển thị đúng dropdown
                			classTypeSelect.dispatchEvent(new Event('change'));
                    
                			// Cập nhật Select2
                			$('#modal-them-phan-cong select').trigger('change.select2');
            			}, 500);

						document.querySelector('#modal-them-phan-cong h3').textContent = 'Sửa phân công giảng dạy';
        				const saveBtn = document.getElementById('btn-luu-phan-cong');
        				saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Cập nhật phân công';
        				saveBtn.onclick = function(e) { 
							updateTeachingAssignment(id, e);
							return false;
						};
        			} else {
            			alert('Không thể tải dữ liệu phân công giảng dạy: ' + (data.message || 'Lỗi không xác định'));
        			}
    			})
    			.catch(error => {
        			console.error('Error loading teaching assignment data:', error);
        			alert('Không thể tải dữ liệu phân công giảng dạy');
    			});
		}

		let isTeachingAssignUpdate = false;
		function updateTeachingAssignment(id, event) {
			
			// Ngăn sự kiện mặc định nếu có
			if (event) {
    			event.preventDefault();
    			event.stopPropagation();
				event.stopImmediatePropagation();
			}
			// Ngăn chặn gọi nhiều lần
			if (isTeachingAssignUpdate) {
    			return false;
			}
			const form = document.getElementById('form-them-phan-cong');
			const formData = new FormData(form);
			const classType = formData.get('class_type');
			const data = {
    			instructor_id: formData.get('instructor_id'),
    			curriculum_subject_id: formData.get('curriculum_subject_id'),
    			academic_year: formData.get('academic_year'),
    			semester: formData.get('semester'),
    			is_main_instructor: formData.get('is_main_instructor') === 'on',
    			student_count: parseInt(formData.get('student_count')) || 0,
    			teaching_hours: parseInt(formData.get('teaching_hours')) || 0
			};

			if (classType === 'regular') {
    			data.class_obj_id = formData.get('class_id');
			} else if (classType === 'combined') {
    			data.combined_class_id = formData.get('combined_class_id');
			}

			isTeachingAssignUpdate = true;
			
			const saveBtn = document.getElementById('btn-luu-phan-cong');
			const originalText = saveBtn.innerHTML;
			const originalOnClick = saveBtn.onclick;
			saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang cập nhật...';
			saveBtn.disabled = true;
			saveBtn.onclick = null;

			fetch(`/api/teaching-assignments/update/${id}/`, {
    			method: 'PUT',
    			headers: {
        			'Content-Type': 'application/json',
        			'X-CSRFToken': getCookie('csrftoken'),
    			},
    			body: JSON.stringify(data)
			})
			.then(response => {
    			if (!response.ok) {
        			throw new Error('Network response was not ok: ' + response.status);
    			}
    			return response.json();
			}) 
			.then(data => {
    			if (data.status === 'success') {
        			alert('✅ Đã cập nhật phân công giảng dạy thành công!');
        			closeThemPhanCongModal();
        			loadTeachingAssignmentsData();
    			} else {
        			alert('❌ Lỗi: ' + data.message);
    			}
			})
			.catch(error => {
    			console.error('Error:', error);
    			alert('❌ Có lỗi xảy ra khi cập nhật phân công giảng dạy');
			})
			.finally(() => {
    			saveBtn.innerHTML = originalText;
    			saveBtn.disabled = false;
				saveBtn.onclick = originalOnClick;
				isTeachingAssignUpdate = false;
			});
			return false;
		}

		function deleteTeachingAssignment(id) {
			if (confirm('Bạn có chắc chắn muốn xóa phân công giảng dạy này? Hành động này không thể hoàn tác.')) {
    			fetch(`/api/teaching-assignments/delete/${id}/`, {
        			method: 'DELETE',
        			headers: {
            			'X-CSRFToken': getCookie('csrftoken'),
        			},
    			})
    			.then(response => response.json())
    			.then(data => {
        			if (data.status === 'success') {
            			alert('✅ Đã xóa phân công giảng dạy thành công!');
            			loadTeachingAssignmentsData();
        			} else {
            			alert('❌ Lỗi: ' + data.message);
        			}
    			})
    			.catch(error => {
        			console.error('Error:', error);
        			alert('❌ Có lỗi xảy ra khi xóa phân công giảng dạy');
    			});
			}
		}

		// Thêm vào cuối file script
		function resetModalToAddState(modalId, formId, saveButtonId, originalButtonText) {
			const modal = document.getElementById(modalId);
			const form = document.getElementById(formId);
			const saveBtn = document.getElementById(saveButtonId);
    
			// Reset form
			if (form) form.reset();
    
			// Reset button text và onclick
			if (saveBtn) {
    			saveBtn.innerHTML = originalButtonText;
    			// Đặt lại onclick tùy theo modal
    			if (modalId === 'modal-them-lop-hoc') {
        			saveBtn.onclick = createLopHoc;
    			} else if (modalId === 'modal-them-lop-ghep') {
        			saveBtn.onclick = createLopGhep;
    			} else if (modalId === 'modal-them-giang-vien') {
        			saveBtn.onclick = createGiangVien;
    			} else if (modalId === 'modal-them-phan-cong') {
        			saveBtn.onclick = createPhanCong;
    			}
			}
    
			// Reset tiêu đề
			const title = modal.querySelector('h3');
			if (title) {
    			if (modalId === 'modal-them-lop-hoc') title.textContent = 'Thêm lớp học mới';
    			else if (modalId === 'modal-them-lop-ghep') title.textContent = 'Thêm lớp học ghép mới';
    			else if (modalId === 'modal-them-giang-vien') title.textContent = 'Thêm giảng viên mới';
    			else if (modalId === 'modal-them-phan-cong') title.textContent = 'Thêm phân công giảng dạy mới';
			}
		}
    </script>
    
</body>
</html>
